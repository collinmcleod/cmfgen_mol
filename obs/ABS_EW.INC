!
!	WRITE(6,*)NCF,N_OBS,FL
!	WRITE(6,*)VTURB_FIX,C_KMS
!	FLUSH(UNIT=6)
	T1=2.1D0*FL*V(1)/C_KMS
	T2=T1
	T3=FL*(VTURB_FIX/C_KMS)
	I=(T1+T2)/T3+1; NCF=MIN(I,NCF)
	T3=(T1+T2)/(NCF-1)
	NU(1)=FL+T1
	DO ML=2,NCF
	  NU(ML)=NU(1)-(ML-1)*T3
	END DO
!	WRITE(6,*)'NEW_NCF=',NCF
!	FLUSH(UNIT=6)
!
	N_OBS=MIN(1000,N_OBS)
	OBS_FREQ(1)=FL*(1.0D0+1.0D0*V(1)/C_KMS)
	OBS_FREQ(N_OBS)=FL*(1.0D0-1.0D0*V(1)/C_KMS)
	T1=(OBS_FREQ(1)-OBS_FREQ(N_OBS))/(N_OBS-1)
	DO I=2,N_OBS-1
	  OBS_FREQ(I)=OBS_FREQ(1)-(I-1)*T1
	END DO
!
!	DO ML=2,NCF
!	  WRITE(114,'(I8,2ES15.4)')ML,NU(ML),C_KMS*(NU(ML-1)-NU(ML))/NU(ML)
!	END DO
!	WRITE(114,'(A)')'*****'
!	DO ML=2,N_OBS
!	  WRITE(114,'(I8,2ES15.4)')ML,OBS_FREQ(ML),C_KMS*(OBS_FREQ(ML-1)-OBS_FREQ(ML))/OBS_FREQ(ML)
!	END DO
!
	DO ML=1,NCF
	  ETA_CMF_ST(:,ML)=ETA_CLUMP+ESEC_CLUMP*RJ
	  CHI_CMF_ST(:,ML)=CHI_CLUMP
	END DO
	WRITE(6,*)'Updated opacities';FLUSH(UNIT=6)
!
        T1=1.0D-15/1.77245385095516D0         !1.0D-15/SQRT(PI)
        T2=12.85D0*SQRT( TDOP/AMASS_DOP + (VTURB_FIX/12.85D0)**2 )
        T3=FL*T2/C_KMS
	DO ML=1,NCF
	  T4=( (NU(ML)-FL)/T3 )**2
	  IF(T4 .LT. 36.0D0)THEN
            T4=EXP(-T4)*T1/T3
            DO I=1,ND
	      ETA_CMF_ST(I,ML)=ETA_CMF_ST(I,ML)+T4*ETAL(I)
	      CHI_CMF_ST(I,ML)=CHI_CMF_ST(I,ML)+T4*CHIL(I)
	    END DO
	  END IF
	END DO
!	WRITE(6,*)'Updated frequency dependent opacities';FLUSH(UNIT=6)
!
	TMP_LOG=.FALSE.
	IF(PLANE_PARALLEL_NO_V .OR. PLANE_PARALLEL)TMP_LOG=.TRUE.
	IF(PLANE_PARALLEL_NO_V)THEN
	  TA(1:ND)=0.0D0
	ELSE
	  TA(1:ND)=V(1:ND)
	END IF
	WRITE(6,*)'Call OBS_FRAME_SUB_V9';FLUSH(UNIT=6)
	CALL OBS_FRAME_SUB_V9(ETA_CMF_ST,CHI_CMF_ST,NU,
	1            R,TA,T,ED,ND,NCF,
	1            P_OBS,MU_AT_RMAX,HQW_AT_RMAX,NC_OBS,NP_OBS,
	1            OBS_FREQ,OBS_FLUX,N_OBS,
	1            MAX_DEL_V_RES_ZONE,OBS_TAU_MAX,OBS_ES_DTAU,
	1            N_INS_OBS,OBS_INT_METHOD,
	1            TAU_REF,L_FALSE,L_FALSE,L_FALSE, 		!WRITE_RTAU,WRITE_IP,WRITE_dFR,
	1            L_FALSE,TMP_LOG)				!DO_REL_IN_OBS_FREQRAME,TMP_LOG)
	CONT_INT=OBS_FLUX(1) 
!	WRITE(6,*)'Called OBS_FRAME_SUB_V9';FLUSH(UNIT=6)
!
	EW=0.0D0; T1=0.0D0
	DO I=1,N_OBS-1
	  EW=EW+(OBS_FREQ(I)-OBS_FREQ(I+1))*(OBS_FLUX(I)+OBS_FLUX(I+1)-2.0D0*OBS_FLUX(1))
	  T1=T1+(OBS_FREQ(I)-OBS_FREQ(I+1))*ABS(OBS_FLUX(I)+OBS_FLUX(I+1)-2.0D0*OBS_FLUX(1))
	END DO
	EW=0.5D0*0.01D0*C_KMS*EW/FL/FL/CONT_INT
	T1=0.5D0*0.01D0*C_KMS*T1/FL/FL/CONT_INT
	WRITE(115,'(F12.4,4ES14.4,5X,A)')0.01*C_KMS/FL,CONT_INT,FL,EW,T1,TRIM(TRANS_NAME_SIM(1))
	FLUSH(UNIT=115)
!
