
characteristics_v2.f

      REAL(KIND=LDP), PARAMETER ::  MU_STEP=0.005_LDP
      REAL(KIND=LDP), PARAMETER ::  MU_STEP=0.005D0

      DIRECTION=1.0_LDP
      DIRECTION=1.0D0

	IF(dV .GT. 1.25_LDP*VDOP_FRAC*VDOP_VEC(I))THEN
	IF(dV .GT. 1.25D0*VDOP_FRAC*VDOP_VEC(I))THEN

      B(ID)=GAMMA*((1.0_LDP-MU(ID)**2)*BETA/R(ID)+GAMMA**2*MU(ID)*(MU(ID)+BETA)*DBETADR)
      B(ID)=GAMMA*((1.0D0-MU(ID)**2)*BETA/R(ID)+GAMMA**2*MU(ID)*(MU(ID)+BETA)*DBETADR)

      A(1)=0.0_LDP
      A(1)=0.0D0

        DR=(R(JD)-R(JD+1))/10.0_LDP
        DR=(R(JD)-R(JD+1))/10.0D0

        B(JD)=GAMMA*((1.0_LDP-MU(JD)**2)*BETA/R(JD)+
        B(JD)=GAMMA*((1.0D0-MU(JD)**2)*BETA/R(JD)+

          IF(dV .GT. 1.25_LDP*VDOP_FRAC*VDOP_VEC(I))THEN
          IF(dV .GT. 1.25D0*VDOP_FRAC*VDOP_VEC(I))THEN

          S(ID+1)=0.0_LDP
          S(ID+1)=0.0D0

          B(ID+1)=GAMMA*((1.0_LDP-MU(ID+1)**2)*BETA/R(ID+1)+
          B(ID+1)=GAMMA*((1.0D0-MU(ID+1)**2)*BETA/R(ID+1)+

        DADS(2)=(1.0_LDP-BETA*BETA)**1.5_LDP/P(IP)
        DADS(2)=(1.0D0-BETA*BETA)**1.5D0/P(IP)

        SS=0.0_LDP
        SS=0.0D0

        DADS(1)=0.0_LDP
        DADS(1)=0.0D0

        DADS(2)=(1.0_LDP-BETA*BETA)**1.5_LDP/P(IP)
        DADS(2)=(1.0D0-BETA*BETA)**1.5D0/P(IP)

        DR_OLD=0.0_LDP
        DR_OLD=0.0D0

        DO WHILE((R(ID)-A(1)-DR_OLD).GT.(DR_OLD*1.0E-3_LDP))
        DO WHILE((R(ID)-A(1)-DR_OLD).GT.(DR_OLD*1.0D-3))

        DADR(1)=1.0_LDP/DADS(1)
        DADR(1)=1.0D0/DADS(1)

        B(ID)=GAMMA*((1.0_LDP-MU(ID)**2)*BETA/R(ID)+
        B(ID)=GAMMA*((1.0D0-MU(ID)**2)*BETA/R(ID)+

        DR_OLD=0.0_LDP
        DR_OLD=0.0D0

          DO WHILE((R(JD)-RR-DR_OLD).GT.(DR_OLD*1.0E-3_LDP))
          DO WHILE((R(JD)-RR-DR_OLD).GT.(DR_OLD*1.0D-3))

            DR=ABS(MU_STEP/DADR(2)/4.0_LDP)
            DR=ABS(MU_STEP/DADR(2)/4.0D0)

          B(JD)=GAMMA*((1.0_LDP-MU(JD)**2)*BETA/R(JD)+
          B(JD)=GAMMA*((1.0D0-MU(JD)**2)*BETA/R(JD)+

         RAY(NP)%S_P(1)=0.0_LDP
         RAY(NP)%S_P(1)=0.0D0

         RAY(NP)%B_P(1)=GAMMA*((1.0_LDP-RAY(NP)%MU_P(1)**2)*BETA/R(1)+
         RAY(NP)%B_P(1)=GAMMA*((1.0D0-RAY(NP)%MU_P(1)**2)*BETA/R(1)+

          RAY(NP)%S_M(1)=0.0_LDP
          RAY(NP)%S_M(1)=0.0D0

          RAY(NP)%B_M(1)=GAMMA*((1.0_LDP-RAY(NP)%MU_M(1)**2)*BETA/R(1)+
          RAY(NP)%B_M(1)=GAMMA*((1.0D0-RAY(NP)%MU_M(1)**2)*BETA/R(1)+

      IF(DIRECTION .GT. 0.0_LDP)THEN
      IF(DIRECTION .GT. 0.0D0)THEN

        DIRECTION=-1.0_LDP
        DIRECTION=-1.0D0


characteristics_v2_gam.f

      REAL(KIND=LDP), PARAMETER ::  MU_STEP=0.005_LDP
      REAL(KIND=LDP), PARAMETER ::  MU_STEP=0.005D0

      DIRECTION=1.0_LDP
      DIRECTION=1.0D0

	IF(dV .GT. 1.25_LDP*VDOP_FRAC*VDOP_VEC(I))THEN
	IF(dV .GT. 1.25D0*VDOP_FRAC*VDOP_VEC(I))THEN

      B(ID)=GAMMA*((1.0_LDP-MU(ID)**2)*BETA/R(ID)+GAMMA**2*MU(ID)*(MU(ID)+BETA)*DBETADR)
      B(ID)=GAMMA*((1.0D0-MU(ID)**2)*BETA/R(ID)+GAMMA**2*MU(ID)*(MU(ID)+BETA)*DBETADR)

      A(1)=0.0_LDP
      A(1)=0.0D0

        DR=(R(JD)-R(JD+1))/10.0_LDP
        DR=(R(JD)-R(JD+1))/10.0D0

        B(JD)=GAMMA*((1.0_LDP-MU(JD)**2)*BETA/R(JD)+
        B(JD)=GAMMA*((1.0D0-MU(JD)**2)*BETA/R(JD)+

          IF(dV .GT. 1.25_LDP*VDOP_FRAC*VDOP_VEC(I))THEN
          IF(dV .GT. 1.25D0*VDOP_FRAC*VDOP_VEC(I))THEN

          S(ID+1)=0.0_LDP
          S(ID+1)=0.0D0

          B(ID+1)=GAMMA*((1.0_LDP-MU(ID+1)**2)*BETA/R(ID+1)+
          B(ID+1)=GAMMA*((1.0D0-MU(ID+1)**2)*BETA/R(ID+1)+

        DADS(2)=(1.0_LDP-BETA*BETA)**1.5_LDP/P(IP)
        DADS(2)=(1.0D0-BETA*BETA)**1.5D0/P(IP)

        SS=0.0_LDP
        SS=0.0D0

        DADS(1)=0.0_LDP
        DADS(1)=0.0D0

        DADS(2)=(1.0_LDP-BETA*BETA)**1.5_LDP/P(IP)
        DADS(2)=(1.0D0-BETA*BETA)**1.5D0/P(IP)

        DR_OLD=0.0_LDP
        DR_OLD=0.0D0

        DO WHILE((R(ID)-A(1)-DR_OLD).GT.(DR_OLD*1.0E-3_LDP))
        DO WHILE((R(ID)-A(1)-DR_OLD).GT.(DR_OLD*1.0D-3))

        DADR(1)=1.0_LDP/DADS(1)
        DADR(1)=1.0D0/DADS(1)

        B(ID)=GAMMA*((1.0_LDP-MU(ID)**2)*BETA/R(ID)+
        B(ID)=GAMMA*((1.0D0-MU(ID)**2)*BETA/R(ID)+

        DR_OLD=0.0_LDP
        DR_OLD=0.0D0

          DO WHILE((R(JD)-RR-DR_OLD).GT.(DR_OLD*1.0E-3_LDP))
          DO WHILE((R(JD)-RR-DR_OLD).GT.(DR_OLD*1.0D-3))

            DR=ABS(MU_STEP/DADR(2)/4.0_LDP)
            DR=ABS(MU_STEP/DADR(2)/4.0D0)

          B(JD)=GAMMA*((1.0_LDP-MU(JD)**2)*BETA/R(JD)+
          B(JD)=GAMMA*((1.0D0-MU(JD)**2)*BETA/R(JD)+

         RAY(NP)%S_P(1)=0.0_LDP
         RAY(NP)%S_P(1)=0.0D0

         RAY(NP)%B_P(1)=GAMMA*((1.0_LDP-RAY(NP)%MU_P(1)**2)*BETA/R(1)+
         RAY(NP)%B_P(1)=GAMMA*((1.0D0-RAY(NP)%MU_P(1)**2)*BETA/R(1)+

          RAY(NP)%S_M(1)=0.0_LDP
          RAY(NP)%S_M(1)=0.0D0

          RAY(NP)%B_M(1)=GAMMA*((1.0_LDP-RAY(NP)%MU_M(1)**2)*BETA/R(1)+
          RAY(NP)%B_M(1)=GAMMA*((1.0D0-RAY(NP)%MU_M(1)**2)*BETA/R(1)+

      IF(DIRECTION .GT. 0.0_LDP)THEN
      IF(DIRECTION .GT. 0.0D0)THEN

        DIRECTION=-1.0_LDP
        DIRECTION=-1.0D0


cmf_formal_rel.f

	  NU_ON_dNU=0.0_LDP
	  NU_ON_dNU=0.0D0

	  NU_ON_dNU=1.0_LDP/dLOG_NU
	  NU_ON_dNU=1.0D0/dLOG_NU

	    IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.001_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(2)=R_EXT(1)-0.001*(R_EXT(1)-R_EXT(5))

	    R_EXT(3)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(3)=R_EXT(1)-0.1*(R_EXT(1)-R_EXT(5))

	    R_EXT(4)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(4)=R_EXT(1)-0.4*(R_EXT(1)-R_EXT(5))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  GAM_REL(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/C_KMS)**2)
	  GAM_REL(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/C_KMS)**2)

	    MIDR(I)=0.5_LDP*(R(I)+R(I+1))
	    MIDR(I)=0.5D0*(R(I)+R(I+1))

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	    IF(ESEC_POW .LT. 2._LDP)ESEC_POW=2
	    IF(ESEC_POW .LT. 2.)ESEC_POW=2

	    IF(ALPHA .LT. 2._LDP)ALPHA=2.0
	    IF(ALPHA .LT. 2.)ALPHA=2.0

	    IF(ESEC_POW .LT. 2._LDP)ESEC_POW=2
	    IF(ESEC_POW .LT. 2.)ESEC_POW=2

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5
	  IF(ALPHA .LT. 3.5)ALPHA=3.5

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	  T1=0.0_LDP
	  T1=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	HNU(:)=0.0_LDP
	HNU(:)=0.0D0

	KNU(:)=0.0_LDP
	KNU(:)=0.0D0

	NNU(:)=0.0_LDP
	NNU(:)=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	    RAY(IP)%I_P_PREV=0.0_LDP; RAY(IP)%I_M_PREV=0.0_LDP
	    RAY(IP)%I_P_PREV=0.0D0; RAY(IP)%I_M_PREV=0.0D0

	    RAY(IP)%I_P_SAVE=0.0_LDP; RAY(IP)%I_M_SAVE=0.0_LDP
	    RAY(IP)%I_P_SAVE=0.0D0; RAY(IP)%I_M_SAVE=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	IF(.not. DIF)T1=0.0_LDP
	IF(.not. DIF)T1=0.0D0

	    IF( I_P_GRID(ID) .LT. 0 .OR. I_M_GRID(ID) .LT. 0.0_LDP)THEN
	    IF( I_P_GRID(ID) .LT. 0 .OR. I_M_GRID(ID) .LT. 0.0D0)THEN

	  RSQN_MID_ON_RSQJ(1:NDM1)=0.0_LDP
	  RSQN_MID_ON_RSQJ(1:NDM1)=0.0D0

	      T1=100.0_LDP
	      T1=100.0D0

	    IF(T1 .GT. 1.1_LDP .OR. T1 .LT. 0.05_LDP)THEN
	    IF(T1 .GT. 1.1 .OR. T1 .LT. 0.05)THEN

	      N_ON_H_MID(I)=0.0_LDP
	      N_ON_H_MID(I)=0.0D0

	  RSQN_MID_ON_RSQJ(1:NDM1)=0.0_LDP
	  RSQN_MID_ON_RSQJ(1:NDM1)=0.0D0

	       IF(N_ON_H_MID(I) .GT. 1.0_LDP)THEN
	       IF(N_ON_H_MID(I) .GT. 1.0D0)THEN

	         N_ON_H_MID(I)=1.0_LDP
	         N_ON_H_MID(I)=1.0D0

	       ELSE IF( NNU_MID(I) .LT. 0.01_LDP) THEN
	       ELSE IF( NNU_MID(I) .LT. 0.01) THEN

	         N_ON_H_MID(I)=0.01_LDP
	         N_ON_H_MID(I)=0.01D0

	      N_ON_H_MID(I)=0.0_LDP              !Later replaced by average.
	      N_ON_H_MID(I)=0.0D0              !Later replaced by average.


cmf_formal_rel_v2.f

	  NU_ON_dNU=0.0_LDP
	  NU_ON_dNU=0.0D0

	  NU_ON_dNU=1.0_LDP/dLOG_NU
	  NU_ON_dNU=1.0D0/dLOG_NU

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+05_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+05)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	    IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.001_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(2)=R_EXT(1)-0.001*(R_EXT(1)-R_EXT(5))

	    R_EXT(3)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(3)=R_EXT(1)-0.1*(R_EXT(1)-R_EXT(5))

	    R_EXT(4)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(4)=R_EXT(1)-0.4*(R_EXT(1)-R_EXT(5))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	    IF(ESEC_POW .LT. 2._LDP)ESEC_POW=2
	    IF(ESEC_POW .LT. 2.)ESEC_POW=2

	    IF(ALPHA .LT. 2._LDP)ALPHA=2.0
	    IF(ALPHA .LT. 2.)ALPHA=2.0

	    IF(ESEC_POW .LT. 2._LDP)ESEC_POW=2
	    IF(ESEC_POW .LT. 2.)ESEC_POW=2

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5
	  IF(ALPHA .LT. 3.5)ALPHA=3.5

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	  T1=0.0_LDP
	  T1=0.0D0

	    HQW_AT_RMAX=2.0_LDP*HQW_P(1,IP)
	    HQW_AT_RMAX=2.0D0*HQW_P(1,IP)

	    N_STORE=2.0_LDP*V(ND)/5.0_LDP
	    N_STORE=2.0D0*V(ND)/5.0D0

	      BETA=V(ND)/2.99792458E+05_LDP
	      BETA=V(ND)/2.99792458D+05

	        T2=1.0_LDP-BETA*(T1+BETA)/(1.0_LDP+BETA*T1)
	        T2=1.0D0-BETA*(T1+BETA)/(1.0D0+BETA*T1)

	        RAY(IP)%FREQ_CONV_FAC=1.0_LDP/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0_LDP-BETA*T1)
	        RAY(IP)%FREQ_CONV_FAC=1.0D0/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0D0-BETA*T1)

	    FREQ_STORE=0.0_LDP
	    FREQ_STORE=0.0D0

	        RAY(IP)%I_IN_BND_STORE=0.0_LDP
	        RAY(IP)%I_IN_BND_STORE=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	    RAY(IP)%I_P_PREV=0.0_LDP; RAY(IP)%I_M_PREV=0.0_LDP
	    RAY(IP)%I_P_PREV=0.0D0; RAY(IP)%I_M_PREV=0.0D0

	    RAY(IP)%I_P_SAVE=0.0_LDP; RAY(IP)%I_M_SAVE=0.0_LDP
	    RAY(IP)%I_P_SAVE=0.0D0; RAY(IP)%I_M_SAVE=0.0D0

	    HNU_AT_OB_PREV=0.0_LDP; NNU_AT_OB_PREV=0.0_LDP
	    HNU_AT_OB_PREV=0.0D0; NNU_AT_OB_PREV=0.0D0

	    HNU_AT_IB_PREV=0.0_LDP; NNU_AT_IB_PREV=0.0_LDP
	    HNU_AT_IB_PREV=0.0D0; NNU_AT_IB_PREV=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	Jnu_store=0.0_LDP; Hnu_store=0.0_LDP
	Jnu_store=0.0D0; Hnu_store=0.0D0

	Knu_store=0.0_LDP; Nnu_store=0.0_LDP
	Knu_store=0.0D0; Nnu_store=0.0D0

	IPLUS=0.0_LDP
	IPLUS=0.0D0

	    IF( I_P_GRID(ID) .LT. 0 .OR. I_M_GRID(ID) .LT. 0.0_LDP)THEN
	    IF( I_P_GRID(ID) .LT. 0 .OR. I_M_GRID(ID) .LT. 0.0D0)THEN

	IF(HBC .LT. 0.0_LDP)HBC=0.0_LDP
	IF(HBC .LT. 0.0D0)HBC=0.0D0

	IF(NBC .LT. 0.0_LDP)NBC=0.0_LDP
	IF(NBC .LT. 0.0D0)NBC=0.0D0


cmf_formal_rel_v3.f

	  NU_ON_dNU=0.0_LDP
	  NU_ON_dNU=0.0D0

	  NU_ON_dNU=1.0_LDP/dLOG_NU
	  NU_ON_dNU=1.0D0/dLOG_NU

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+05_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+05)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	    IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.001_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(2)=R_EXT(1)-0.001D0*(R_EXT(1)-R_EXT(5))

	    R_EXT(3)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(3)=R_EXT(1)-0.1D0*(R_EXT(1)-R_EXT(5))

	    R_EXT(4)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(4)=R_EXT(1)-0.4D0*(R_EXT(1)-R_EXT(5))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	    IF(ALPHA .LT. 2.0_LDP)ALPHA=2.0_LDP
	    IF(ALPHA .LT. 2.0D0)ALPHA=2.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5
	  IF(ALPHA .LT. 3.5)ALPHA=3.5

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	  T1=0.0_LDP
	  T1=0.0D0

	    HQW_AT_RMAX=2.0_LDP*HQW_P(1,IP)
	    HQW_AT_RMAX=2.0D0*HQW_P(1,IP)

	    N_STORE=2.0_LDP*V(ND)/5.0_LDP
	    N_STORE=2.0D0*V(ND)/5.0D0

	      BETA=V(ND)/2.99792458E+05_LDP
	      BETA=V(ND)/2.99792458D+05

	        T2=1.0_LDP-BETA*(T1+BETA)/(1.0_LDP+BETA*T1)
	        T2=1.0D0-BETA*(T1+BETA)/(1.0D0+BETA*T1)

	        RAY(IP)%FREQ_CONV_FAC=1.0_LDP/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0_LDP-BETA*T1)
	        RAY(IP)%FREQ_CONV_FAC=1.0D0/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0D0-BETA*T1)

	    FREQ_STORE=0.0_LDP
	    FREQ_STORE=0.0D0

	        RAY(IP)%I_IN_BND_STORE=0.0_LDP
	        RAY(IP)%I_IN_BND_STORE=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	    RAY(IP)%I_P_PREV=0.0_LDP; RAY(IP)%I_M_PREV=0.0_LDP
	    RAY(IP)%I_P_PREV=0.0D0; RAY(IP)%I_M_PREV=0.0D0

	    RAY(IP)%I_P_SAVE=0.0_LDP; RAY(IP)%I_M_SAVE=0.0_LDP
	    RAY(IP)%I_P_SAVE=0.0D0; RAY(IP)%I_M_SAVE=0.0D0

	    HNU_AT_OB_PREV=0.0_LDP; NNU_AT_OB_PREV=0.0_LDP
	    HNU_AT_OB_PREV=0.0D0; NNU_AT_OB_PREV=0.0D0

	    HNU_AT_IB_PREV=0.0_LDP; NNU_AT_IB_PREV=0.0_LDP
	    HNU_AT_IB_PREV=0.0D0; NNU_AT_IB_PREV=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	Jnu_store=0.0_LDP; Hnu_store=0.0_LDP
	Jnu_store=0.0D0; Hnu_store=0.0D0

	Knu_store=0.0_LDP; Nnu_store=0.0_LDP
	Knu_store=0.0D0; Nnu_store=0.0D0

	JPLUS_IB=0.0_LDP; HPLUS_IB=0.0_LDP; KPLUS_IB=0.0_LDP
	JPLUS_IB=0.0D0; HPLUS_IB=0.0D0; KPLUS_IB=0.0D0

	JMIN_IB=0.0_LDP;  HMIN_IB=0.0_LDP; KMIN_IB=0.0_LDP
	JMIN_IB=0.0D0;  HMIN_IB=0.0D0; KMIN_IB=0.0D0

	JPLUS_OB=0.0_LDP;  HPLUS_OB=0.0_LDP; KPLUS_OB=0.0_LDP
	JPLUS_OB=0.0D0;  HPLUS_OB=0.0D0; KPLUS_OB=0.0D0

	JMIN_OB=0.0_LDP;   HMIN_OB=0.0_LDP;  KMIN_OB=0.0_LDP
	JMIN_OB=0.0D0;   HMIN_OB=0.0D0;  KMIN_OB=0.0D0

	IPLUS=0.0_LDP
	IPLUS=0.0D0

	    IF( I_P_GRID(ID) .LT. 0 .OR. I_M_GRID(ID) .LT. 0.0_LDP)THEN
	    IF( I_P_GRID(ID) .LT. 0 .OR. I_M_GRID(ID) .LT. 0.0D0)THEN

	IF(HBC .LT. 0.0_LDP)HBC=0.0_LDP
	IF(HBC .LT. 0.0D0)HBC=0.0D0

	IF(NBC .LT. 0.0_LDP)NBC=0.0_LDP
	IF(NBC .LT. 0.0D0)NBC=0.0D0


cmf_formal_rel_v4.f

	  NU_ON_dNU=0.0_LDP
	  NU_ON_dNU=0.0D0

	  NU_ON_dNU=1.0_LDP/dLOG_NU
	  NU_ON_dNU=1.0D0/dLOG_NU

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+05_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+05)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	  ALLOCATE ( R_EXT(ND_EXT),STAT=IOS );          R_EXT=0.0_LDP
	  ALLOCATE ( R_EXT(ND_EXT),STAT=IOS );          R_EXT=0.0D0

	    IF(REXT_FAC .GT. 1.0_LDP .AND. REXT_FAC .LT. 10.0_LDP)THEN
	    IF(REXT_FAC .GT. 1.0D0 .AND. REXT_FAC .LT. 10.0D0)THEN

	    ELSE IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    ELSE IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.001_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(2)=R_EXT(1)-0.001D0*(R_EXT(1)-R_EXT(5))

	    R_EXT(3)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(3)=R_EXT(1)-0.1D0*(R_EXT(1)-R_EXT(5))

	    R_EXT(4)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(4)=R_EXT(1)-0.4D0*(R_EXT(1)-R_EXT(5))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	    IF(ALPHA .LT. 2.0_LDP)ALPHA=2.0_LDP
	    IF(ALPHA .LT. 2.0D0)ALPHA=2.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5_LDP
	  IF(ALPHA .LT. 3.5D0)ALPHA=3.5D0

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	  T1=0.0_LDP
	  T1=0.0D0

	    HQW_AT_RMAX=2.0_LDP*HQW_P(1,IP)
	    HQW_AT_RMAX=2.0D0*HQW_P(1,IP)

	    N_STORE=2.0_LDP*V(ND)                   !/5.0D0
	    N_STORE=2.0D0*V(ND)                   !/5.0D0

	      BETA=V(ND)/2.99792458E+05_LDP
	      BETA=V(ND)/2.99792458D+05

	        T2=1.0_LDP-BETA*(T1+BETA)/(1.0_LDP+BETA*T1)
	        T2=1.0D0-BETA*(T1+BETA)/(1.0D0+BETA*T1)

	        RAY(IP)%FREQ_CONV_FAC=1.0_LDP/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0_LDP-BETA*T1)
	        RAY(IP)%FREQ_CONV_FAC=1.0D0/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0D0-BETA*T1)

	    FREQ_STORE=0.0_LDP
	    FREQ_STORE=0.0D0

	      RAY(IP)%I_IN_BND_STORE=0.0_LDP
	      RAY(IP)%I_IN_BND_STORE=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	    RAY(IP)%I_P_PREV=0.0_LDP; RAY(IP)%I_M_PREV=0.0_LDP
	    RAY(IP)%I_P_PREV=0.0D0; RAY(IP)%I_M_PREV=0.0D0

	    RAY(IP)%I_P_SAVE=0.0_LDP; RAY(IP)%I_M_SAVE=0.0_LDP
	    RAY(IP)%I_P_SAVE=0.0D0; RAY(IP)%I_M_SAVE=0.0D0

	  HNU_AT_OB_PREV=0.0_LDP; NNU_AT_OB_PREV=0.0_LDP
	  HNU_AT_OB_PREV=0.0D0; NNU_AT_OB_PREV=0.0D0

	  HNU_AT_IB_PREV=0.0_LDP; NNU_AT_IB_PREV=0.0_LDP
	  HNU_AT_IB_PREV=0.0D0; NNU_AT_IB_PREV=0.0D0

	      RAY(IP)%I_P(ID)=0.0_LDP; RAY(IP)%I_M(ID)=0.0_LDP
	      RAY(IP)%I_P(ID)=0.0D0; RAY(IP)%I_M(ID)=0.0D0

	Jnu_store=0.0_LDP; Hnu_store=0.0_LDP
	Jnu_store=0.0D0; Hnu_store=0.0D0

	Knu_store=0.0_LDP; Nnu_store=0.0_LDP
	Knu_store=0.0D0; Nnu_store=0.0D0

	JPLUS_IB=0.0_LDP; HPLUS_IB=0.0_LDP; KPLUS_IB=0.0_LDP
	JPLUS_IB=0.0D0; HPLUS_IB=0.0D0; KPLUS_IB=0.0D0

	JMIN_IB=0.0_LDP;  HMIN_IB=0.0_LDP; KMIN_IB=0.0_LDP
	JMIN_IB=0.0D0;  HMIN_IB=0.0D0; KMIN_IB=0.0D0

	JPLUS_OB=0.0_LDP;  HPLUS_OB=0.0_LDP; KPLUS_OB=0.0_LDP
	JPLUS_OB=0.0D0;  HPLUS_OB=0.0D0; KPLUS_OB=0.0D0

	JMIN_OB=0.0_LDP;   HMIN_OB=0.0_LDP;  KMIN_OB=0.0_LDP
	JMIN_OB=0.0D0;   HMIN_OB=0.0D0;  KMIN_OB=0.0D0

	IPLUS=0.0_LDP
	IPLUS=0.0D0

	IF(HBC .LT. 0.0_LDP)HBC=0.0_LDP
	IF(HBC .LT. 0.0D0)HBC=0.0D0

	IF(NBC .LT. 0.0_LDP)NBC=0.0_LDP
	IF(NBC .LT. 0.0D0)NBC=0.0D0

	T1=1.0E-200_LDP
	T1=1.0D-200


cmf_formal_rel_v4_gam.f

	  NU_ON_dNU=0.0_LDP
	  NU_ON_dNU=0.0D0

	  NU_ON_dNU=1.0_LDP/dLOG_NU
	  NU_ON_dNU=1.0D0/dLOG_NU

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+05_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+05)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	    IF(REXT_FAC .GT. 1.0_LDP .AND. REXT_FAC .LT. 10.0_LDP)THEN
	    IF(REXT_FAC .GT. 1.0D0 .AND. REXT_FAC .LT. 10.0D0)THEN

	    ELSE IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    ELSE IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.001_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(2)=R_EXT(1)-0.001D0*(R_EXT(1)-R_EXT(5))

	    R_EXT(3)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(3)=R_EXT(1)-0.1D0*(R_EXT(1)-R_EXT(5))

	    R_EXT(4)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(5))
	    R_EXT(4)=R_EXT(1)-0.4D0*(R_EXT(1)-R_EXT(5))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	    IF(ALPHA .LT. 2.0_LDP)ALPHA=2.0_LDP
	    IF(ALPHA .LT. 2.0D0)ALPHA=2.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5_LDP
	  IF(ALPHA .LT. 3.5D0)ALPHA=3.5D0

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	  T1=0.0_LDP
	  T1=0.0D0

	    HQW_AT_RMAX=2.0_LDP*HQW_P(1,IP)
	    HQW_AT_RMAX=2.0D0*HQW_P(1,IP)

	    N_STORE=2.0_LDP*V(ND)/5.0_LDP
	    N_STORE=2.0D0*V(ND)/5.0D0

	      BETA=V(ND)/2.99792458E+05_LDP
	      BETA=V(ND)/2.99792458D+05

	        T2=1.0_LDP-BETA*(T1+BETA)/(1.0_LDP+BETA*T1)
	        T2=1.0D0-BETA*(T1+BETA)/(1.0D0+BETA*T1)

	        RAY(IP)%FREQ_CONV_FAC=1.0_LDP/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0_LDP-BETA*T1)
	        RAY(IP)%FREQ_CONV_FAC=1.0D0/GAM_REL_STORE(ND)/GAM_REL_STORE(ND)/T2/(1.0D0-BETA*T1)

	    FREQ_STORE=0.0_LDP
	    FREQ_STORE=0.0D0

	        RAY(IP)%I_IN_BND_STORE=0.0_LDP
	        RAY(IP)%I_IN_BND_STORE=0.0D0

	    RAY(IP)%I_P=0.0_LDP; RAY(IP)%I_M=0.0_LDP
	    RAY(IP)%I_P=0.0D0; RAY(IP)%I_M=0.0D0

	    RAY(IP)%I_P_PREV=0.0_LDP; RAY(IP)%I_M_PREV=0.0_LDP
	    RAY(IP)%I_P_PREV=0.0D0; RAY(IP)%I_M_PREV=0.0D0

	    RAY(IP)%I_P_SAVE=0.0_LDP; RAY(IP)%I_M_SAVE=0.0_LDP
	    RAY(IP)%I_P_SAVE=0.0D0; RAY(IP)%I_M_SAVE=0.0D0

	  HNU_AT_OB_PREV=0.0_LDP; NNU_AT_OB_PREV=0.0_LDP
	  HNU_AT_OB_PREV=0.0D0; NNU_AT_OB_PREV=0.0D0

	  HNU_AT_IB_PREV=0.0_LDP; NNU_AT_IB_PREV=0.0_LDP
	  HNU_AT_IB_PREV=0.0D0; NNU_AT_IB_PREV=0.0D0

	      RAY(IP)%I_P(ID)=0.0_LDP; RAY(IP)%I_M(ID)=0.0_LDP
	      RAY(IP)%I_P(ID)=0.0D0; RAY(IP)%I_M(ID)=0.0D0

	Jnu_store=0.0_LDP; Hnu_store=0.0_LDP
	Jnu_store=0.0D0; Hnu_store=0.0D0

	Knu_store=0.0_LDP; Nnu_store=0.0_LDP
	Knu_store=0.0D0; Nnu_store=0.0D0

	JPLUS_IB=0.0_LDP; HPLUS_IB=0.0_LDP; KPLUS_IB=0.0_LDP
	JPLUS_IB=0.0D0; HPLUS_IB=0.0D0; KPLUS_IB=0.0D0

	JMIN_IB=0.0_LDP;  HMIN_IB=0.0_LDP; KMIN_IB=0.0_LDP
	JMIN_IB=0.0D0;  HMIN_IB=0.0D0; KMIN_IB=0.0D0

	JPLUS_OB=0.0_LDP;  HPLUS_OB=0.0_LDP; KPLUS_OB=0.0_LDP
	JPLUS_OB=0.0D0;  HPLUS_OB=0.0D0; KPLUS_OB=0.0D0

	JMIN_OB=0.0_LDP;   HMIN_OB=0.0_LDP;  KMIN_OB=0.0_LDP
	JMIN_OB=0.0D0;   HMIN_OB=0.0D0;  KMIN_OB=0.0D0

	IPLUS=0.0_LDP
	IPLUS=0.0D0

	IF(HBC .LT. 0.0_LDP)HBC=0.0_LDP
	IF(HBC .LT. 0.0D0)HBC=0.0D0

	IF(NBC .LT. 0.0_LDP)NBC=0.0_LDP
	IF(NBC .LT. 0.0D0)NBC=0.0D0


comp_add_edd_facs.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  GAM_REL(I)=SQRT(1.0_LDP/(1.0_LDP-(V(I)/C_KMS)**2))
	  GAM_REL(I)=SQRT(1.0D0/(1.0D0-(V(I)/C_KMS)**2))

	  MIDR(I)=0.5_LDP*(R(I)+R(I+1))
	  MIDR(I)=0.5D0*(R(I)+R(I+1))

	T2=DBB/CHI(ND)/3.0_LDP
	T2=DBB/CHI(ND)/3.0D0

	IF(.NOT. DIF)T2=0.5_LDP*IC*(0.5_LDP+INBC)-INBC*RJ(ND)
	IF(.NOT. DIF)T2=0.5D0*IC*(0.5D0+INBC)-INBC*RJ(ND)

	  IF(GEDD(I) .EQ. 0.0_LDP)THEN
	  IF(GEDD(I) .EQ. 0.0D0)THEN

	  N_ON_J_NODE(I)=2.0_LDP*N_ON_J_NODE(I)        !/RJ(I)/R(I)/R(I)
	  N_ON_J_NODE(I)=2.0D0*N_ON_J_NODE(I)        !/RJ(I)/R(I)/R(I)

	  IF(ABS(N_ON_J_NODE(I)) .GE. 1.0_LDP)THEN
	  IF(ABS(N_ON_J_NODE(I)) .GE. 1.0D0)THEN

	    T1=SQRT(1.0_LDP/(1.0_LDP-0.25_LDP*(V(I)/C_KMS+V(I+1)/C_KMS)**2))
	    T1=SQRT(1.0D0/(1.0D0-0.25D0*(V(I)/C_KMS+V(I+1)/C_KMS)**2))


create_incid_inten.f

	REAL(KIND=LDP), PARAMETER :: HDKT=4.7994145_LDP
	REAL(KIND=LDP), PARAMETER :: HDKT=4.7994145D0

	REAL(KIND=LDP), PARAMETER :: TWOHCSQ=0.0147452575_LDP
	REAL(KIND=LDP), PARAMETER :: TWOHCSQ=0.0147452575D0

	REAL(KIND=LDP), PARAMETER :: NU_MAX=100.0_LDP
	REAL(KIND=LDP), PARAMETER :: NU_MAX=100.0D0

	REAL(KIND=LDP), PARAMETER :: NU_MIN=0.0001_LDP
	REAL(KIND=LDP), PARAMETER :: NU_MIN=0.0001D0

	NANG=11; NPTS_PER_DECADE=20; REL_LUM=0.1_LDP
	NANG=11; NPTS_PER_DECADE=20; REL_LUM=0.1D0

	MU(1)=0.0_LDP
	MU(1)=0.0D0

	MU(NANG)=1.0_LDP
	MU(NANG)=1.0D0

	  MU(I)=(I-1.0_LDP)/(NANG-1.0_LDP)
	  MU(I)=(I-1.0D0)/(NANG-1.0D0)

	  DIST(I)=1.0_LDP-4.0_LDP*(MU(I)-0.5_LDP)**2
	  DIST(I)=1.0D0-4.0D0*(MU(I)-0.5D0)**2

	T1=0.0_LDP
	T1=0.0D0

	  T1=T1+0.5_LDP*(MU(I+1)-MU(I))*(MU(I)*DIST(I)+MU(I+1)*DIST(I+1))
	  T1=T1+0.5D0*(MU(I+1)-MU(I))*(MU(I)*DIST(I)+MU(I+1)*DIST(I+1))

	NORMALIZED_ANGLE_INTEGRAL=2.0_LDP*T1
	NORMALIZED_ANGLE_INTEGRAL=2.0D0*T1

	T1=EXP(LOG(10.0_LDP)/NPTS_PER_DECADE)
	T1=EXP(LOG(10.0D0)/NPTS_PER_DECADE)

	FLUX=0.0_LDP
	FLUX=0.0D0

	  BNU=TWOHCSQ*NU*NU*NU*X/(1.0_LDP-X)
	  BNU=TWOHCSQ*NU*NU*NU*X/(1.0D0-X)

	  FLUX=FLUX+BNU*(NU*T1-NU/T1)/2.0_LDP
	  FLUX=FLUX+BNU*(NU*T1-NU/T1)/2.0D0

	PI=4.0_LDP*ATAN(1.0_LDP)
	PI=4.0D0*ATAN(1.0D0)

	T1=(FLUX*PI*1.0E+15_LDP/5.6705E-05_LDP)**(0.25_LDP)
	T1=(FLUX*PI*1.0D+15/5.6705D-05)**(0.25D0)


define_grid_v2.f


define_grid_v2_gam.f

	  R_MU(ID)%MU_VECTOR=0.0_LDP
	  R_MU(ID)%MU_VECTOR=0.0D0

	    R_MU(ID)%dMU=2.0_LDP/(NA-1)
	    R_MU(ID)%dMU=2.0D0/(NA-1)

	    R_MU(ID)%MON_MU(1)=1.0_LDP
	    R_MU(ID)%MON_MU(1)=1.0D0

	      R_MU(ID)%MON_MU(I)=1.0_LDP-(I-1)*R_MU(ID)%dMU
	      R_MU(ID)%MON_MU(I)=1.0D0-(I-1)*R_MU(ID)%dMU

	    R_MU(ID)%MON_MU(NA)=-1.0_LDP
	    R_MU(ID)%MON_MU(NA)=-1.0D0


derivr.f

      djdr(1)=1.0_LDP/gamma/(mu+beta)
      djdr(1)=1.0d0/gamma/(mu+beta)

      djdr(2)=(1.0_LDP-mu*mu)/(mu+beta)*((1.0_LDP+beta*mu)/r-
      djdr(2)=(1.0d0-mu*mu)/(mu+beta)*((1.0d0+beta*mu)/r-


derivs.f

      djds(2)=gamma*(1.0_LDP-mu*mu)*((1.0_LDP+beta*mu)/r-
      djds(2)=gamma*(1.0d0-mu*mu)*((1.0d0+beta*mu)/r-


drhsdchi_pp.f

	dTAU_dCHI(:,:)=0.0_LDP
	dTAU_dCHI(:,:)=0.0D0

	  ALPHA=0.5_LDP*(R(I)-R(K))
	  ALPHA=0.5D0*(R(I)-R(K))

	  BETA=ALPHA*(R(I)-R(K))/6.0_LDP
	  BETA=ALPHA*(R(I)-R(K))/6.0D0

	W(:,:)=0.0_LDP
	W(:,:)=0.0D0

	  T1=-0.5_LDP*(1.0_LDP-COH_VEC(I))+F(I)/DTAU(J)/DTAU(J)
	  T1=-0.5D0*(1.0D0-COH_VEC(I))+F(I)/DTAU(J)/DTAU(J)

	  UIJ=UIJ+T1*RJ(I)+0.5_LDP*SOURCE(I)
	  UIJ=UIJ+T1*RJ(I)+0.5D0*SOURCE(I)

	  T1=-0.5_LDP*(1.0_LDP-COH_VEC(I))+F(I)/DTAU(I)/DTAU(I)
	  T1=-0.5D0*(1.0D0-COH_VEC(I))+F(I)/DTAU(I)/DTAU(I)

	  UII=UII+T1*RJ(I)+0.5_LDP*SOURCE(I)
	  UII=UII+T1*RJ(I)+0.5D0*SOURCE(I)

	  W(I,I)=W(I,I)-0.5_LDP*(DTAU(J)+DTAU(I))*
	  W(I,I)=W(I,I)-0.5D0*(DTAU(J)+DTAU(I))*

	UII=-0.5_LDP*(1.0_LDP-COH_VEC(1))*RJ(1)+(RJ(1)*F(1)-RJ(2)*F(2))/DTAU(1)/DTAU(1)
	UII=-0.5D0*(1.0D0-COH_VEC(1))*RJ(1)+(RJ(1)*F(1)-RJ(2)*F(2))/DTAU(1)/DTAU(1)

	UII=UII+0.5_LDP*SOURCE(1)
	UII=UII+0.5D0*SOURCE(1)

	W(1,1)=W(1,1)-0.50_LDP*DTAU(1)*(RJ(1)*COH_VEC(1)+SOURCE(1))/CHI(1)
	W(1,1)=W(1,1)-0.50D0*DTAU(1)*(RJ(1)*COH_VEC(1)+SOURCE(1))/CHI(1)

	UIJ=-0.5_LDP*(1.0_LDP-COH_VEC(ND))*RJ(ND)+(RJ(ND)*F(ND)-F(ND-1)*RJ(ND-1))/DTAU(ND-1)/DTAU(ND-1)
	UIJ=-0.5D0*(1.0D0-COH_VEC(ND))*RJ(ND)+(RJ(ND)*F(ND)-F(ND-1)*RJ(ND-1))/DTAU(ND-1)/DTAU(ND-1)

	UIJ=UIJ+0.5_LDP*SOURCE(ND)
	UIJ=UIJ+0.5D0*SOURCE(ND)

	  W(ND,ND)=W(ND,ND)-DBB/CHI(ND)/CHI(ND)/3.0_LDP
	  W(ND,ND)=W(ND,ND)-DBB/CHI(ND)/CHI(ND)/3.0D0

	W(ND,ND)=W(ND,ND)-0.50_LDP*DTAU(ND-1)*(RJ(ND)*COH_VEC(ND)+SOURCE(ND))/CHI(ND)
	W(ND,ND)=W(ND,ND)-0.50D0*DTAU(ND-1)*(RJ(ND)*COH_VEC(ND)+SOURCE(ND))/CHI(ND)


edd_j_hub_var_v1.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	  T1=(1.0_LDP+W(I))*(CHI(I)+CHI(I+1))
	  T1=(1.0D0+W(I))*(CHI(I)+CHI(I+1))

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  dTBdCHI=(PSI(I)+DJDT(I))/(DTAU(J)+DTAU(I))+T1*(1.0_LDP-ES_COH_VEC(I))
	  dTBdCHI=(PSI(I)+DJDT(I))/(DTAU(J)+DTAU(I))+T1*(1.0D0-ES_COH_VEC(I))

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)


edd_j_hub_var_v2.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	  T1=(1.0_LDP+W(I))*(CHI(I)+CHI(I+1))
	  T1=(1.0D0+W(I))*(CHI(I)+CHI(I+1))

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  dTBdCHI=(PSI(I)+DJDT(I))/(DTAU(J)+DTAU(I))+T1*(1.0_LDP-ES_COH_VEC(I))
	  dTBdCHI=(PSI(I)+DJDT(I))/(DTAU(J)+DTAU(I))+T1*(1.0D0-ES_COH_VEC(I))

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  MOD_DTAU=0.5_LDP*(CHI(1)-CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)-CHI(2))*(R(1)-R(2))

	  VK(1,1,1)=T1*0.5_LDP*(R(1)-R(2))
	  VK(1,1,1)=T1*0.5D0*(R(1)-R(2))

	  VK(1,2,1)=T1*0.5_LDP*(R(1)-R(2))
	  VK(1,2,1)=T1*0.5D0*(R(1)-R(2))


edd_j_hub_var_v3.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	  T1=(1.0_LDP+W(I))*(CHI(I)+CHI(I+1))
	  T1=(1.0D0+W(I))*(CHI(I)+CHI(I+1))

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  dTBdCHI=(PSI(I)+DJDT(I))/(DTAU(J)+DTAU(I))+T1*(1.0_LDP-ES_COH_VEC(I))
	  dTBdCHI=(PSI(I)+DJDT(I))/(DTAU(J)+DTAU(I))+T1*(1.0D0-ES_COH_VEC(I))

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  MOD_DTAU=0.5_LDP*(CHI(1)-CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)-CHI(2))*(R(1)-R(2))

	  VK(1,1,1)=T1*0.5_LDP*(R(1)-R(2))
	  VK(1,1,1)=T1*0.5D0*(R(1)-R(2))

	  VK(1,2,1)=T1*0.5_LDP*(R(1)-R(2))
	  VK(1,2,1)=T1*0.5D0*(R(1)-R(2))


edd_jrel_var_v1.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	  EPS_FAC(I)=-1.0_LDP/T1
	  EPS_FAC(I)=-1.0D0/T1

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  VK(ND,ND,1)=VK(ND,ND,1)-GAM_RSQ(ND)*GAM_REL(ND)*DBB/3.0_LDP/CHI(ND)/CHI(ND)
	  VK(ND,ND,1)=VK(ND,ND,1)-GAM_RSQ(ND)*GAM_REL(ND)*DBB/3.0D0/CHI(ND)/CHI(ND)


edd_jrel_var_v2.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	  EPS_FAC(I)=-1.0_LDP/T1
	  EPS_FAC(I)=-1.0D0/T1

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  VK(ND,ND,1)=VK(ND,ND,1)-GAM_RSQ(ND)*GAM_REL(ND)*DBB/3.0_LDP/CHI(ND)/CHI(ND)
	  VK(ND,ND,1)=VK(ND,ND,1)-GAM_RSQ(ND)*GAM_REL(ND)*DBB/3.0D0/CHI(ND)/CHI(ND)


edd_jrel_var_v3.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	  EPS_FAC(I)=-1.0_LDP/T1
	  EPS_FAC(I)=-1.0D0/T1

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  T1=0.5_LDP*R(I)*R(I)/Q(I)
	  T1=0.5D0*R(I)*R(I)/Q(I)

	  VK(ND,ND,1)=VK(ND,ND,1)-GAM_RSQ(ND)*GAM_REL(ND)*DBB/3.0_LDP/CHI(ND)/CHI(ND)
	  VK(ND,ND,1)=VK(ND,ND,1)-GAM_RSQ(ND)*GAM_REL(ND)*DBB/3.0D0/CHI(ND)/CHI(ND)


expint.f

      PARAMETER (MAXIT=100,EPS=1.E-7_LDP,FPMIN=1.E-200_LDP,EULER=.5772156649_LDP)
      PARAMETER (MAXIT=100,EPS=1.D-7,FPMIN=1.D-200,EULER=.5772156649)

      if(n.lt.0.or.x.lt.0..or.(x.eq.0..and.(n.eq.0.or.n.eq.1_LDP)))then
      if(n.lt.0.or.x.lt.0..or.(x.eq.0..and.(n.eq.0.or.n.eq.1)))then

      else if(x.eq.0._LDP)then
      else if(x.eq.0.)then

        expint=1._LDP/nm1
        expint=1./nm1

      else if(x.gt.1._LDP)then
      else if(x.gt.1.)then

        c=1._LDP/FPMIN
        c=1./FPMIN

        d=1._LDP/b
        d=1./b

          d=1._LDP/(a*d+b)
          d=1./(a*d+b)

          if(abs(del-1._LDP).lt.EPS)then
          if(abs(del-1.).lt.EPS)then

          expint=1._LDP/nm1
          expint=1./nm1

              psi=psi+1._LDP/ii
              psi=psi+1./ii


expn_approx.f

	  EXPN=(X*X + 4.03640_LDP*X + 1.15198_LDP)/(X*X + 5.03637_LDP*X + 4.1916_LDP)/X
	  EXPN=(X*X + 4.03640*X + 1.15198)/(X*X + 5.03637*X + 4.1916)/X

	    EXPN=(1.0_LDP-X*EXPN)/(I-1)
	    EXPN=(1.0D0-X*EXPN)/(I-1)

	    EXPN=(1.0_LDP-X*EXPN)/(I-1)
	    EXPN=(1.0D0-X*EXPN)/(I-1)

	  EXPN=(1.0_LDP/(X+J))
	  EXPN=(1.0/(X+J))

	    EXPN=(1.0_LDP-K*EXPN)/X
	    EXPN=(1.0D0-K*EXPN)/X


expn.f

	REAL(KIND=LDP), PARAMETER :: EULER=0.5772156649015328606_LDP
	REAL(KIND=LDP), PARAMETER :: EULER=0.5772156649015328606D0

	REAL(KIND=LDP), PARAMETER :: EPS=1.0E-10_LDP
	REAL(KIND=LDP), PARAMETER :: EPS=1.0D-10

	ELSE IF(X .EQ. 0.0_LDP .AND. N .EQ .0)THEN
	ELSE IF(X .EQ. 0.0D0 .AND. N .EQ .0)THEN

	ELSE IF(X .EQ. 0.0_LDP)THEN
	ELSE IF(X .EQ. 0.0D0)THEN

	ELSE IF(X .LE. 1.5_LDP)THEN
	ELSE IF(X .LE. 1.5D0)THEN

	  ANS=0.0_LDP
	  ANS=0.0D0

	  FAC=1.0_LDP
	  FAC=1.0D0

	    ANS=ANS+1.0_LDP/I
	    ANS=ANS+1.0D0/I

	  Y=1.0_LDP
	  Y=1.0D0

	  VAL=0.0_LDP
	  VAL=0.0D0

	  IF(N .NE. 1)VAL=Y/(1.0_LDP-N)
	  IF(N .NE. 1)VAL=Y/(1.0D0-N)

	  A0=0.0_LDP; B0=1.0_LDP
	  A0=0.0D0; B0=1.0D0

	  A1=1.0_LDP; B1=X+N
	  A1=1.0D0; B1=X+N

	  ANS=0.0_LDP
	  ANS=0.0D0


fcomp_pp_v2.f

	REAL(KIND=LDP), PARAMETER :: RZERO=0.0_LDP
	REAL(KIND=LDP), PARAMETER :: RZERO=0.0D0

	REAL(KIND=LDP), PARAMETER :: RONE=1.0_LDP
	REAL(KIND=LDP), PARAMETER :: RONE=1.0D0

	NEWRJ(1:ND)=0.0_LDP
	NEWRJ(1:ND)=0.0D0

	NEWRK(1:ND)=0.0_LDP
	NEWRK(1:ND)=0.0D0

	HBC_J=0.0_LDP
	HBC_J=0.0D0

	HBC_S=0.0_LDP
	HBC_S=0.0D0

	INBCNEW=0.0_LDP
	INBCNEW=0.0D0

	  DTAU_RAD(I)=0.5_LDP*(R(I)-R(I+1))*( CHI(I)+CHI(I+1)+(R(I)-R(I+1))*
	  DTAU_RAD(I)=0.5D0*(R(I)-R(I+1))*( CHI(I)+CHI(I+1)+(R(I)-R(I+1))*

	1     (dCHIdR(I+1)-dCHIdR(I))/6.0_LDP)
	1     (dCHIdR(I+1)-dCHIdR(I))/6.0D0)

	      IF(TOR .LT. 0)TOR=0.0_LDP
	      IF(TOR .LT. 0)TOR=0.0D0

	      IBOUND=SOURCE(1)*(1.0_LDP-EXP(-TOR/MU(LS)))
	      IBOUND=SOURCE(1)*(1.0D0-EXP(-TOR/MU(LS)))

	      IBOUND=0.0_LDP
	      IBOUND=0.0D0

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TC(I)=1.0_LDP/DTAU(I)
	      TC(I)=1.0D0/DTAU(I)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-SOURCE(I)*(DTAU(I-1)+DTAU(I))*0.5_LDP
	      XM(I)=-SOURCE(I)*(DTAU(I-1)+DTAU(I))*0.5D0

	      TB(ND)=1.0_LDP-TA(ND)
	      TB(ND)=1.0D0-TA(ND)

	    TC(ND)=0.0_LDP
	    TC(ND)=0.0D0

	    IPLUS(LS)=2.0_LDP*(XM(1)-IBOUND)
	    IPLUS(LS)=2.0D0*(XM(1)-IBOUND)

	    IPLUS(LS)=0.0_LDP
	    IPLUS(LS)=0.0D0

	INBCNEW=INBCNEW/(2.0_LDP*NEWRJ(ND)-IC)
	INBCNEW=INBCNEW/(2.0D0*NEWRJ(ND)-IC)


fg_j_cmf_v11.f

	DATA VDOP_FRAC_SAV/-1001.0_LDP/ 	!Absurd value.
	DATA VDOP_FRAC_SAV/-1001.0D0/ 	!Absurd value.

	DATA PREVIOUS_FREQ/0.0_LDP/
	DATA PREVIOUS_FREQ/0.0D0/

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+10_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+10)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	    IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(2)=R_EXT(1)-0.1*(R_EXT(1)-R_EXT(4))

	    R_EXT(3)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(3)=R_EXT(1)-0.4*(R_EXT(1)-R_EXT(4))

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	        Z_EXT(I)=0.0_LDP
	        Z_EXT(I)=0.0D0

	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01_LDP,T1)
	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01D0,T1)

	        Z_EXT(I)=0.0_LDP
	        Z_EXT(I)=0.0D0

	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01_LDP,T1)
	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01D0,T1)

	      ELSE IF( ABS(R_RAY(K,LS)-R(I))/R(I) .GT. 1.0E-12_LDP)THEN
	      ELSE IF( ABS(R_RAY(K,LS)-R(I))/R(I) .GT. 1.0D-12)THEN

	          T1=0.5_LDP*(R(I)+R(I+1))
	          T1=0.5D0*(R(I)+R(I+1))

	          T1=0.5_LDP*(R(I)+R(I+1))
	          T1=0.5D0*(R(I)+R(I+1))

	          IF(T1 .LE. 0.5_LDP*(R_RAY(K,LS)+R_RAY(K+1,LS)) .AND. T1 .GE. 0.5_LDP*(R_RAY(K+1,LS)+R_RAY(K+2,LS)) )THEN
	          IF(T1 .LE. 0.5D0*(R_RAY(K,LS)+R_RAY(K+1,LS)) .AND. T1 .GE. 0.5D0*(R_RAY(K+1,LS)+R_RAY(K+2,LS)) )THEN

	  FG_ERR_ON_FREQ(:)=0.0_LDP
	  FG_ERR_ON_FREQ(:)=0.0D0

	    AV_PREV(:,:)=0.0_LDP
	    AV_PREV(:,:)=0.0D0

	    CV_PREV(:,:)=0.0_LDP
	    CV_PREV(:,:)=0.0D0

	    I_P_PREV(:,:)=0.0_LDP
	    I_P_PREV(:,:)=0.0D0

	    I_M_PREV(:,:)=0.0_LDP
	    I_M_PREV(:,:)=0.0D0

	      T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I,LS)
	      T1=3.33564D-06*V_RAY(I)/R_RAY(I,LS)

	      GAM(I,LS)=T1*( 1.0_LDP+SIGMA_RAY(I)*(MU**2) )
	      GAM(I,LS)=T1*( 1.0D0+SIGMA_RAY(I)*(MU**2) )

	        T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I,LS)
	        T1=3.33564D-06*V_RAY(I)/R_RAY(I,LS)

	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564E-06_LDP*
	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564D-06*

	1                   (  1.0_LDP+0.5_LDP*(MU**2)*
	1                   (  1.0D0+0.5D0*(MU**2)*

	    IF(ESEC_POW .LT. 2._LDP)ESEC_POW=2
	    IF(ESEC_POW .LT. 2.)ESEC_POW=2

	    IF(ALPHA .LT. 2._LDP)ALPHA=2.0
	    IF(ALPHA .LT. 2.)ALPHA=2.0

	    IF(ESEC_POW .LT. 2._LDP)ESEC_POW=2
	    IF(ESEC_POW .LT. 2.)ESEC_POW=2

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5
	  IF(ALPHA .LT. 3.5)ALPHA=3.5

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	JPLUS_IB=0.0_LDP; HPLUS_IB=0.0_LDP; KPLUS_IB=0.0_LDP; NPLUS_IB=0.0_LDP
	JPLUS_IB=0.0D0; HPLUS_IB=0.0D0; KPLUS_IB=0.0D0; NPLUS_IB=0.0D0

	JMIN_IB=0.0_LDP;  HMIN_IB=0.0_LDP; KMIN_IB=0.0_LDP;   NMIN_IB=0.0_LDP
	JMIN_IB=0.0D0;  HMIN_IB=0.0D0; KMIN_IB=0.0D0;   NMIN_IB=0.0D0

	JPLUS_OB=0.0_LDP;  HPLUS_OB=0.0_LDP; KPLUS_OB=0.0_LDP; NPLUS_OB=0.0_LDP
	JPLUS_OB=0.0D0;  HPLUS_OB=0.0D0; KPLUS_OB=0.0D0; NPLUS_OB=0.0D0

	JMIN_OB=0.0_LDP;   HMIN_OB=0.0_LDP;  KMIN_OB=0.0_LDP;  NMIN_OB=0.0_LDP
	JMIN_OB=0.0D0;   HMIN_OB=0.0D0;  KMIN_OB=0.0D0;  NMIN_OB=0.0D0

	  AV(:,:)=0.0_LDP
	  AV(:,:)=0.0D0

	  CV(:,:)=0.0_LDP
	  CV(:,:)=0.0D0

	        T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	        T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	    IBOUND(LS)=0.0_LDP
	    IBOUND(LS)=0.0D0

	        Q(I)=0.0_LDP
	        Q(I)=0.0D0

	        QH(I)=0.0_LDP
	        QH(I)=0.0D0

	        QH(I)=GAMH(I,LS)*2.0_LDP/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)
	        QH(I)=GAMH(I,LS)*2.0D0/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)

	      QH(NI)=0.0_LDP
	      QH(NI)=0.0D0

	      T1=0.0_LDP
	      T1=0.0D0

	1            *(1.0_LDP+T1*(1.0_LDP-CHI_RAY(NI)/OLDCHI(LS)))
	1            *(1.0D0+T1*(1.0D0-CHI_RAY(NI)/OLDCHI(LS)))

	          DTAU(I,LS)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dZ
	          DTAU(I,LS)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dZ

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	      DIV(1)=1.0_LDP/(TC(1,LS)+TB(1,LS))
	      DIV(1)=1.0/(TC(1,LS)+TB(1,LS))

	        DIV(I)=1.0_LDP/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))
	        DIV(I)=1.0D0/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))

	      XM(1)=0.0_LDP
	      XM(1)=0.0D0

	        XM(I)=-0.5_LDP*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))
	        XM(I)=-0.5D0*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))

	        XM(NI)=0.5_LDP*DTAU(NI-1,LS)*SOURCE_RAY(NI)
	        XM(NI)=0.5*DTAU(NI-1,LS)*SOURCE_RAY(NI)

	      T1=1.0E-08_LDP*ABS(AV(K,LS))
	      T1=1.0D-08*ABS(AV(K,LS))

	        AV(I,LS)=MAX(0.01_LDP*ABS(AV(I,LS)),T1)
	        AV(I,LS)=MAX(0.01D0*ABS(AV(I,LS)),T1)

	      CV_BOUND(LS)=0.0_LDP
	      CV_BOUND(LS)=0.0D0

	      CV_BOUND(LS)=0.5_LDP*(CV(K+1,LS)+CV(K-1,LS))
	      CV_BOUND(LS)=0.5D0*(CV(K+1,LS)+CV(K-1,LS))

	      I_P(1,LS)=0.0_LDP
	      I_P(1,LS)=0.0D0

	      I_M(1,LS)=0.0_LDP
	      I_M(1,LS)=0.0D0

	        T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	        T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	      Q(1:NI)=0.0_LDP
	      Q(1:NI)=0.0D0

	          DTAU(I,LS)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dZ
	          DTAU(I,LS)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dZ

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	        EE(I)=0.0_LDP
	        EE(I)=0.0D0

	        IF(T1 .LT. 700.0_LDP)EE(I)=EXP(-T1)
	        IF(T1 .LT. 700.0D0)EE(I)=EXP(-T1)

	        IF(T1 .GT. 0.5_LDP)THEN
	        IF(T1 .GT. 0.5)THEN

	          E0(I)=1.0_LDP-EE(I)
	          E0(I)=1.0D0-EE(I)

	          E1(I)=1.0_LDP-E0(I)/T1
	          E1(I)=1.0D0-E0(I)/T1

	          E2(I)=1.0_LDP-2.0_LDP*E1(I)/T1
	          E2(I)=1.0D0-2.0D0*E1(I)/T1

	          E3(I)=1.0_LDP-3.0_LDP*E2(I)/T1
	          E3(I)=1.0D0-3.0D0*E2(I)/T1

	        ELSE IF(T1 .GT. 0.1_LDP)THEN
	        ELSE IF(T1 .GT. 0.1)THEN

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP*
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0*

	1               (1.0_LDP-T1/10.0_LDP*(1.0_LDP-T1/11.0_LDP*
	1               (1.0D0-T1/10.0D0*(1.0D0-T1/11.0D0*

	1               (1.0_LDP-T1/12.0_LDP*(1.0_LDP-T1/13.0_LDP)))))))) )
	1               (1.0D0-T1/12.0D0*(1.0D0-T1/13.0D0)))))))) )

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0D0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP) ))))
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0) ))))

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0d0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	        A1(I,LS)=E0(I)-3.0_LDP*E2(I)+2.0_LDP*E3(I)
	        A1(I,LS)=E0(I)-3.0D0*E2(I)+2.0D0*E3(I)

	        A2(I,LS)=3.0_LDP*E2(I)-2.0_LDP*E3(I)
	        A2(I,LS)=3.0D0*E2(I)-2.0D0*E3(I)

	        A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0_LDP*E2(I)+E3(I))
	        A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0D0*E2(I)+E3(I))

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5*ABS(dS(1)))

	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5*ABS(dS(I)))

	1               MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1               MIN(ABS(S(NI-1)),0.5*ABS(dS(NI)))

            I_M(1,LS)=0.0_LDP
            I_M(1,LS)=0.0D0

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5*ABS(dS(1)))

	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5*ABS(dS(I)))

	1            MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1            MIN(ABS(S(NI-1)),0.5*ABS(dS(NI)))

	    CV_BOUND(LS)=0.5_LDP*(I_P(K,LS)-I_M(K,LS))
	    CV_BOUND(LS)=0.5D0*(I_P(K,LS)-I_M(K,LS))

	      AV(I,LS)=0.5_LDP*( I_P(I,LS)+I_M(I,LS) )
	      AV(I,LS)=0.5D0*( I_P(I,LS)+I_M(I,LS) )

	      CV(I,LS)= 0.5_LDP*( I_P(I,LS)-I_M(I,LS) )
	      CV(I,LS)= 0.5D0*( I_P(I,LS)-I_M(I,LS) )

	HBC=0.0_LDP			!H/J at model outer boundary.
	HBC=0.0D0			!H/J at model outer boundary.

	NBC=0.0_LDP			!N/J at model outer boundary.
	NBC=0.0D0			!N/J at model outer boundary.

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	JNU_STORE(:)=0.0_LDP			!1:ND
	JNU_STORE(:)=0.0D0			!1:ND

	HNU_STORE(:)=0.0_LDP
	HNU_STORE(:)=0.0D0

	KNU_STORE(:)=0.0_LDP
	KNU_STORE(:)=0.0D0

	NNU_STORE(:)=0.0_LDP
	NNU_STORE(:)=0.0D0

	  T2=0.0_LDP; T2=MAX(T2,AV(K,LS)-CV_BOUND(LS))
	  T2=0.0D0; T2=MAX(T2,AV(K,LS)-CV_BOUND(LS))

	  T1=AV(K,LS)-0.5_LDP*I_M_IN_BND(LS)
	  T1=AV(K,LS)-0.5D0*I_M_IN_BND(LS)

                T2=0.5_LDP*(R(I)+R(I+1))
                T2=0.5D0*(R(I)+R(I+1))

                HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
                HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

                NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
                NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	    HNU_AT_OB=0.0_LDP; NNU_AT_OB=0.0_LDP
	    HNU_AT_OB=0.0D0; NNU_AT_OB=0.0D0

	      IPLUS_P(LS)=2.0_LDP*CV_BOUND(LS)
	      IPLUS_P(LS)=2.0D0*CV_BOUND(LS)

	      T2=0.5_LDP*(R(I)+R(I+1))
	      T2=0.5D0*(R(I)+R(I+1))

	      T1=( 2.0_LDP*T2-(R_RAY(K,LS)+R_RAY(K+1,LS)) )/(R_RAY(K+2,LS)-R_RAY(K,LS))
	      T1=( 2.0*T2-(R_RAY(K,LS)+R_RAY(K+1,LS)) )/(R_RAY(K+2,LS)-R_RAY(K,LS))

	      HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	      NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	  HNU_AT_OB=0.0_LDP; NNU_AT_OB=0.0_LDP
	  HNU_AT_OB=0.0D0; NNU_AT_OB=0.0D0

	    IPLUS_P(LS)=2.0_LDP*CV_BOUND(LS)
	    IPLUS_P(LS)=2.0D0*CV_BOUND(LS)

	    HNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/3.0_LDP
	    HNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/3.0D0

	    NNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/5.0_LDP
	    NNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/5.0D0

	    HNU_AT_IB=0.0_LDP; NNU_AT_IB=0.0_LDP
	    HNU_AT_IB=0.0D0; NNU_AT_IB=0.0D0

	      HNU_AT_IB=HNU_AT_IB+0.5_LDP*(IC-I_M_IN_BND(LS))*HQW(ND,LS)
	      HNU_AT_IB=HNU_AT_IB+0.5D0*(IC-I_M_IN_BND(LS))*HQW(ND,LS)

	      NNU_AT_IB=NNU_AT_IB+0.5_LDP*(IC-I_M_IN_BND(LS))*NQW(ND,LS)
	      NNU_AT_IB=NNU_AT_IB+0.5D0*(IC-I_M_IN_BND(LS))*NQW(ND,LS)

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	IN_HBC=IN_HBC/(2.0_LDP*JNU_STORE(ND)-IC)
	IN_HBC=IN_HBC/(2.0D0*JNU_STORE(ND)-IC)

	  T1=0.0_LDP
	  T1=0.0D0


fg_j_cmf_v12.f

	DATA VDOP_FRAC_SAV/-1001.0_LDP/ 	!Absurd value.
	DATA VDOP_FRAC_SAV/-1001.0D0/ 	!Absurd value.

	DATA PREVIOUS_FREQ/0.0_LDP/
	DATA PREVIOUS_FREQ/0.0D0/

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+10_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+10)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	    IF(REXT_FAC .GT. 1.0_LDP .AND. REXT_FAC .LT. 10.0_LDP)THEN
	    IF(REXT_FAC .GT. 1.0D0 .AND. REXT_FAC .LT. 10.0D0)THEN

	    ELSE IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    ELSE IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(2)=R_EXT(1)-0.1D0*(R_EXT(1)-R_EXT(4))

	    R_EXT(3)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(3)=R_EXT(1)-0.4D0*(R_EXT(1)-R_EXT(4))

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	        Z_EXT(I)=0.0_LDP
	        Z_EXT(I)=0.0D0

	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01_LDP,T1)
	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01D0,T1)

	      IF(T1 .GT. 1.0_LDP)K=K+INT(T1)
	      IF(T1 .GT. 1.0D0)K=K+INT(T1)

	        Z_EXT(I)=0.0_LDP
	        Z_EXT(I)=0.0D0

	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01_LDP,T1)
	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01D0,T1)

	      IF(T1 .GT. 1.0_LDP)THEN
	      IF(T1 .GT. 1.0D0)THEN

	      ELSE IF( ABS(R_RAY(K,LS)-R(I))/R(I) .GT. 1.0E-12_LDP)THEN
	      ELSE IF( ABS(R_RAY(K,LS)-R(I))/R(I) .GT. 1.0D-12)THEN

	          T1=0.5_LDP*(R(I)+R(I+1))
	          T1=0.5D0*(R(I)+R(I+1))

	          T1=0.5_LDP*(R(I)+R(I+1))
	          T1=0.5D0*(R(I)+R(I+1))

	          IF(T1 .LE. 0.5_LDP*(R_RAY(K,LS)+R_RAY(K+1,LS)) .AND. T1 .GE. 0.5_LDP*(R_RAY(K+1,LS)+R_RAY(K+2,LS)) )THEN
	          IF(T1 .LE. 0.5D0*(R_RAY(K,LS)+R_RAY(K+1,LS)) .AND. T1 .GE. 0.5D0*(R_RAY(K+1,LS)+R_RAY(K+2,LS)) )THEN

	  FG_ERR_ON_FREQ(:)=0.0_LDP
	  FG_ERR_ON_FREQ(:)=0.0D0

	    AV_PREV(:,:)=0.0_LDP
	    AV_PREV(:,:)=0.0D0

	    CV_PREV(:,:)=0.0_LDP
	    CV_PREV(:,:)=0.0D0

	    I_P_PREV(:,:)=0.0_LDP
	    I_P_PREV(:,:)=0.0D0

	    I_M_PREV(:,:)=0.0_LDP
	    I_M_PREV(:,:)=0.0D0

	    IF(SIGMA(I) .LT. -1.0_LDP)THEN
	    IF(SIGMA(I) .LT. -1.0D0)THEN

	      IF(SIGMA_RAY(I) .LE. -1.0_LDP)SIGMA_RAY(I)=-0.999_LDP
	      IF(SIGMA_RAY(I) .LE. -1.0D0)SIGMA_RAY(I)=-0.999D0

	      T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I,LS)
	      T1=3.33564D-06*V_RAY(I)/R_RAY(I,LS)

	      GAM(I,LS)=T1*( 1.0_LDP+SIGMA_RAY(I)*(MU**2) )
	      GAM(I,LS)=T1*( 1.0D0+SIGMA_RAY(I)*(MU**2) )

	        T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I,LS)
	        T1=3.33564D-06*V_RAY(I)/R_RAY(I,LS)

	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564E-06_LDP*
	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564D-06*

	1                   (  1.0_LDP+0.5_LDP*(MU**2)*
	1                   (  1.0D0+0.5D0*(MU**2)*

	     GAMH(NI,LS)=0.0_LDP
	     GAMH(NI,LS)=0.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	    IF(ALPHA .LT. 2.0_LDP)ALPHA=2.0_LDP
	    IF(ALPHA .LT. 2.0D0)ALPHA=2.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5_LDP
	  IF(ALPHA .LT. 3.5D0)ALPHA=3.5D0

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	JPLUS_IB=0.0_LDP; HPLUS_IB=0.0_LDP; KPLUS_IB=0.0_LDP; NPLUS_IB=0.0_LDP
	JPLUS_IB=0.0D0; HPLUS_IB=0.0D0; KPLUS_IB=0.0D0; NPLUS_IB=0.0D0

	JMIN_IB=0.0_LDP;  HMIN_IB=0.0_LDP; KMIN_IB=0.0_LDP;   NMIN_IB=0.0_LDP
	JMIN_IB=0.0D0;  HMIN_IB=0.0D0; KMIN_IB=0.0D0;   NMIN_IB=0.0D0

	JPLUS_OB=0.0_LDP;  HPLUS_OB=0.0_LDP; KPLUS_OB=0.0_LDP; NPLUS_OB=0.0_LDP
	JPLUS_OB=0.0D0;  HPLUS_OB=0.0D0; KPLUS_OB=0.0D0; NPLUS_OB=0.0D0

	JMIN_OB=0.0_LDP;   HMIN_OB=0.0_LDP;  KMIN_OB=0.0_LDP;  NMIN_OB=0.0_LDP
	JMIN_OB=0.0D0;   HMIN_OB=0.0D0;  KMIN_OB=0.0D0;  NMIN_OB=0.0D0

	  AV(:,:)=0.0_LDP
	  AV(:,:)=0.0D0

	  CV(:,:)=0.0_LDP
	  CV(:,:)=0.0D0

	        T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	        T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	    IBOUND(LS)=0.0_LDP
	    IBOUND(LS)=0.0D0

	        Q(I)=0.0_LDP
	        Q(I)=0.0D0

	        QH(I)=0.0_LDP
	        QH(I)=0.0D0

	        QH(I)=GAMH(I,LS)*2.0_LDP/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)
	        QH(I)=GAMH(I,LS)*2.0D0/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)

	      QH(NI)=0.0_LDP
	      QH(NI)=0.0D0

	      T1=0.0_LDP
	      T1=0.0D0

	1            *(1.0_LDP+T1*(1.0_LDP-CHI_RAY(NI)/OLDCHI(LS)))
	1            *(1.0D0+T1*(1.0D0-CHI_RAY(NI)/OLDCHI(LS)))

	          DTAU(I,LS)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dZ
	          DTAU(I,LS)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dZ

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	      TC(NI,LS)=0.0_LDP				!As used.
	      TC(NI,LS)=0.0D0				!As used.

	      DIV(1)=1.0_LDP/(TC(1,LS)+TB(1,LS))
	      DIV(1)=1.0D0/(TC(1,LS)+TB(1,LS))

	        DIV(I)=1.0_LDP/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))
	        DIV(I)=1.0D0/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))

	      XM(1)=0.0_LDP
	      XM(1)=0.0D0

	        XM(I)=-0.5_LDP*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))
	        XM(I)=-0.5D0*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))

	        XM(NI)=0.5_LDP*DTAU(NI-1,LS)*SOURCE_RAY(NI)
	        XM(NI)=0.5D0*DTAU(NI-1,LS)*SOURCE_RAY(NI)

	      T1=1.0E-08_LDP*ABS(AV(K,LS))
	      T1=1.0D-08*ABS(AV(K,LS))

	        AV(I,LS)=MAX(0.01_LDP*ABS(AV(I,LS)),T1)
	        AV(I,LS)=MAX(0.01D0*ABS(AV(I,LS)),T1)

	      CV_BOUND(LS)=0.0_LDP
	      CV_BOUND(LS)=0.0D0

	      CV_BOUND(LS)=0.5_LDP*(CV(K+1,LS)+CV(K-1,LS))
	      CV_BOUND(LS)=0.5D0*(CV(K+1,LS)+CV(K-1,LS))

	      I_P(1,LS)=0.0_LDP
	      I_P(1,LS)=0.0D0

	      I_M(1,LS)=0.0_LDP
	      I_M(1,LS)=0.0D0

	        T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	        T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	      Q(1:NI)=0.0_LDP
	      Q(1:NI)=0.0D0

	          DTAU(I,LS)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dZ
	          DTAU(I,LS)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dZ

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	        EE(I)=0.0_LDP
	        EE(I)=0.0D0

	        IF(T1 .LT. 700.0_LDP)EE(I)=EXP(-T1)
	        IF(T1 .LT. 700.0D0)EE(I)=EXP(-T1)

	        IF(T1 .GE. 40.0_LDP)THEN
	        IF(T1 .GE. 40.0D0)THEN

	        ELSE IF(T1 .GT. 0.5_LDP)THEN
	        ELSE IF(T1 .GT. 0.5D0)THEN

	          E0(I)=1.0_LDP-EE(I)
	          E0(I)=1.0D0-EE(I)

	          E1(I)=1.0_LDP-E0(I)/T1
	          E1(I)=1.0D0-E0(I)/T1

	          E2(I)=1.0_LDP-2.0_LDP*E1(I)/T1
	          E2(I)=1.0D0-2.0D0*E1(I)/T1

	          E3(I)=1.0_LDP-3.0_LDP*E2(I)/T1
	          E3(I)=1.0D0-3.0D0*E2(I)/T1

	        ELSE IF(T1 .GT. 0.1_LDP)THEN
	        ELSE IF(T1 .GT. 0.1D0)THEN

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20D0*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP*
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0*

	1               (1.0_LDP-T1/10.0_LDP*(1.0_LDP-T1/11.0_LDP*
	1               (1.0D0-T1/10.0D0*(1.0D0-T1/11.0D0*

	1               (1.0_LDP-T1/12.0_LDP*(1.0_LDP-T1/13.0_LDP)))))))) )
	1               (1.0D0-T1/12.0D0*(1.0D0-T1/13.0D0)))))))) )

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0D0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20D0*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP) ))))
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0) ))))

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0d0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	        IF(T1 .GE. 40.0_LDP)THEN
	        IF(T1 .GE. 40.0D0)THEN

	          A1(I,LS)=(6.0_LDP-12.0_LDP/T1)/T1/T1
	          A1(I,LS)=(6.0D0-12.0/T1)/T1/T1

	          A2(I,LS)=1.0_LDP-A1(I,LS)
	          A2(I,LS)=1.0D0-A1(I,LS)

	          A3(I,LS)=(2.0_LDP-6.0_LDP/T1)/T1
	          A3(I,LS)=(2.0D0-6.0D0/T1)/T1

	          A4(I,LS)=(4.0_LDP-6.0_LDP/T1)/T1-1.0_LDP
	          A4(I,LS)=(4.0D0-6.0D0/T1)/T1-1.0D0

	          A1(I,LS)=E0(I)-3.0_LDP*E2(I)+2.0_LDP*E3(I)
	          A1(I,LS)=E0(I)-3.0D0*E2(I)+2.0D0*E3(I)

	          A2(I,LS)=3.0_LDP*E2(I)-2.0_LDP*E3(I)
	          A2(I,LS)=3.0D0*E2(I)-2.0D0*E3(I)

	          A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0_LDP*E2(I)+E3(I))
	          A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0D0*E2(I)+E3(I))

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5D0*ABS(dS(1)))

	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5D0*ABS(dS(I)))

	1               MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1               MIN(ABS(S(NI-1)),0.5D0*ABS(dS(NI)))

            I_M(1,LS)=0.0_LDP
            I_M(1,LS)=0.0D0

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5D0*ABS(dS(1)))

	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5D0*ABS(dS(I)))

	1            MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1            MIN(ABS(S(NI-1)),0.5D0*ABS(dS(NI)))

	    CV_BOUND(LS)=0.5_LDP*(I_P(K,LS)-I_M(K,LS))
	    CV_BOUND(LS)=0.5D0*(I_P(K,LS)-I_M(K,LS))

	      AV(I,LS)=0.5_LDP*( I_P(I,LS)+I_M(I,LS) )
	      AV(I,LS)=0.5D0*( I_P(I,LS)+I_M(I,LS) )

	      CV(I,LS)= 0.5_LDP*( I_P(I,LS)-I_M(I,LS) )
	      CV(I,LS)= 0.5D0*( I_P(I,LS)-I_M(I,LS) )

	HBC=0.0_LDP			!H/J at model outer boundary.
	HBC=0.0D0			!H/J at model outer boundary.

	NBC=0.0_LDP			!N/J at model outer boundary.
	NBC=0.0D0			!N/J at model outer boundary.

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	JNU_STORE(:)=0.0_LDP			!1:ND
	JNU_STORE(:)=0.0D0			!1:ND

	HNU_STORE(:)=0.0_LDP
	HNU_STORE(:)=0.0D0

	KNU_STORE(:)=0.0_LDP
	KNU_STORE(:)=0.0D0

	NNU_STORE(:)=0.0_LDP
	NNU_STORE(:)=0.0D0

	  T2=0.0_LDP; T2=MAX(T2,AV(K,LS)-CV_BOUND(LS))
	  T2=0.0D0; T2=MAX(T2,AV(K,LS)-CV_BOUND(LS))

	  T1=AV(K,LS)-0.5_LDP*I_M_IN_BND(LS)
	  T1=AV(K,LS)-0.5D0*I_M_IN_BND(LS)

                T2=0.5_LDP*(R(I)+R(I+1))
                T2=0.5D0*(R(I)+R(I+1))

                HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
                HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

                NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
                NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	    HNU_AT_OB=0.0_LDP; NNU_AT_OB=0.0_LDP
	    HNU_AT_OB=0.0D0; NNU_AT_OB=0.0D0

	      IPLUS_P(LS)=2.0_LDP*CV_BOUND(LS)
	      IPLUS_P(LS)=2.0D0*CV_BOUND(LS)

	      T2=0.5_LDP*(R(I)+R(I+1))
	      T2=0.5D0*(R(I)+R(I+1))

	      T1=( 2.0_LDP*T2-(R_RAY(K,LS)+R_RAY(K+1,LS)) )/(R_RAY(K+2,LS)-R_RAY(K,LS))
	      T1=( 2.0D0*T2-(R_RAY(K,LS)+R_RAY(K+1,LS)) )/(R_RAY(K+2,LS)-R_RAY(K,LS))

	      HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	      NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	  HNU_AT_OB=0.0_LDP; NNU_AT_OB=0.0_LDP
	  HNU_AT_OB=0.0D0; NNU_AT_OB=0.0D0

	    IPLUS_P(LS)=2.0_LDP*CV_BOUND(LS)
	    IPLUS_P(LS)=2.0D0*CV_BOUND(LS)

	    HNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/3.0_LDP
	    HNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/3.0D0

	    NNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/5.0_LDP
	    NNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/5.0D0

	    HNU_AT_IB=0.0_LDP; NNU_AT_IB=0.0_LDP
	    HNU_AT_IB=0.0D0; NNU_AT_IB=0.0D0

	      HNU_AT_IB=HNU_AT_IB+0.5_LDP*(IC-I_M_IN_BND(LS))*HQW(ND,LS)
	      HNU_AT_IB=HNU_AT_IB+0.5D0*(IC-I_M_IN_BND(LS))*HQW(ND,LS)

	      NNU_AT_IB=NNU_AT_IB+0.5_LDP*(IC-I_M_IN_BND(LS))*NQW(ND,LS)
	      NNU_AT_IB=NNU_AT_IB+0.5D0*(IC-I_M_IN_BND(LS))*NQW(ND,LS)

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	IN_HBC=IN_HBC/(2.0_LDP*JNU_STORE(ND)-IC)
	IN_HBC=IN_HBC/(2.0D0*JNU_STORE(ND)-IC)

	  T1=0.0_LDP
	  T1=0.0D0


fg_j_cmf_v13.f

	DATA VDOP_FRAC_SAV/-1001.0_LDP/ 	!Absurd value.
	DATA VDOP_FRAC_SAV/-1001.0D0/ 	!Absurd value.

	DATA PREVIOUS_FREQ/0.0_LDP/
	DATA PREVIOUS_FREQ/0.0D0/

	  GAM_REL_STORE(1:ND)=1.0_LDP/SQRT(1.0_LDP-(V(1:ND)/2.99792458E+10_LDP)**2)
	  GAM_REL_STORE(1:ND)=1.0D0/SQRT(1.0D0-(V(1:ND)/2.99792458D+10)**2)

	    RMID_STORE(I)=0.5_LDP*(R(I)+R(I+1))
	    RMID_STORE(I)=0.5D0*(R(I)+R(I+1))

	    EXT_RMID_STORE(I+1)=0.5_LDP*(R(I)+R(I+1))
	    EXT_RMID_STORE(I+1)=0.5D0*(R(I)+R(I+1))

	    IF(REXT_FAC .GT. 1.0_LDP .AND. REXT_FAC .LT. 10.0_LDP)THEN
	    IF(REXT_FAC .GT. 1.0D0 .AND. REXT_FAC .LT. 10.0D0)THEN

	    ELSE IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    ELSE IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(2)=R_EXT(1)-0.1D0*(R_EXT(1)-R_EXT(4))

	    R_EXT(3)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(3)=R_EXT(1)-0.4D0*(R_EXT(1)-R_EXT(4))

	    BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	    BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	      V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	      V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	      SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	      T1=MIN(3.0_LDP,T1)
	      T1=MIN(3.0D0,T1)

	        Z_EXT(I)=0.0_LDP
	        Z_EXT(I)=0.0D0

	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01_LDP,T1)
	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01D0,T1)

	      IF(T1 .GT. 1.0_LDP)K=K+INT(T1)
	      IF(T1 .GT. 1.0D0)K=K+INT(T1)

	        Z_EXT(I)=0.0_LDP
	        Z_EXT(I)=0.0D0

	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01_LDP,T1)
	      IF(.NOT. THK .AND. NI_SMALL .EQ. 2)T1=MAX(2.01D0,T1)

	      IF(T1 .GT. 1.0_LDP)THEN
	      IF(T1 .GT. 1.0D0)THEN

	      ELSE IF( ABS(R_RAY(K,LS)-R(I))/R(I) .GT. 1.0E-12_LDP)THEN
	      ELSE IF( ABS(R_RAY(K,LS)-R(I))/R(I) .GT. 1.0D-12)THEN

	          T1=0.5_LDP*(R(I)+R(I+1))
	          T1=0.5D0*(R(I)+R(I+1))

	          T1=0.5_LDP*(R(I)+R(I+1))
	          T1=0.5D0*(R(I)+R(I+1))

	          IF(T1 .LE. 0.5_LDP*(R_RAY(K,LS)+R_RAY(K+1,LS)) .AND. T1 .GE. 0.5_LDP*(R_RAY(K+1,LS)+R_RAY(K+2,LS)) )THEN
	          IF(T1 .LE. 0.5D0*(R_RAY(K,LS)+R_RAY(K+1,LS)) .AND. T1 .GE. 0.5D0*(R_RAY(K+1,LS)+R_RAY(K+2,LS)) )THEN

	  FG_ERR_ON_FREQ(:)=0.0_LDP
	  FG_ERR_ON_FREQ(:)=0.0D0

	    AV_PREV(:,:)=0.0_LDP
	    AV_PREV(:,:)=0.0D0

	    CV_PREV(:,:)=0.0_LDP
	    CV_PREV(:,:)=0.0D0

	    I_P_PREV(:,:)=0.0_LDP
	    I_P_PREV(:,:)=0.0D0

	    I_M_PREV(:,:)=0.0_LDP
	    I_M_PREV(:,:)=0.0D0

	    IF(SIGMA(I) .LT. -1.0_LDP)THEN
	    IF(SIGMA(I) .LT. -1.0D0)THEN

	      IF(SIGMA_RAY(I) .LE. -1.0_LDP)SIGMA_RAY(I)=-0.999_LDP
	      IF(SIGMA_RAY(I) .LE. -1.0D0)SIGMA_RAY(I)=-0.999D0

	      T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I,LS)
	      T1=3.33564D-06*V_RAY(I)/R_RAY(I,LS)

	      GAM(I,LS)=T1*( 1.0_LDP+SIGMA_RAY(I)*(MU**2) )
	      GAM(I,LS)=T1*( 1.0D0+SIGMA_RAY(I)*(MU**2) )

	        T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I,LS)
	        T1=3.33564D-06*V_RAY(I)/R_RAY(I,LS)

	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564E-06_LDP*
	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564D-06*

	1                   (  1.0_LDP+0.5_LDP*(MU**2)*
	1                   (  1.0D0+0.5D0*(MU**2)*

	     GAMH(NI,LS)=0.0_LDP
	     GAMH(NI,LS)=0.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	    IF(ALPHA .LT. 2.0_LDP)ALPHA=2.0_LDP
	    IF(ALPHA .LT. 2.0D0)ALPHA=2.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5_LDP
	  IF(ALPHA .LT. 3.5D0)ALPHA=3.5D0

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	JPLUS_IB=0.0_LDP; HPLUS_IB=0.0_LDP; KPLUS_IB=0.0_LDP; NPLUS_IB=0.0_LDP
	JPLUS_IB=0.0D0; HPLUS_IB=0.0D0; KPLUS_IB=0.0D0; NPLUS_IB=0.0D0

	JMIN_IB=0.0_LDP;  HMIN_IB=0.0_LDP; KMIN_IB=0.0_LDP;   NMIN_IB=0.0_LDP
	JMIN_IB=0.0D0;  HMIN_IB=0.0D0; KMIN_IB=0.0D0;   NMIN_IB=0.0D0

	JPLUS_OB=0.0_LDP;  HPLUS_OB=0.0_LDP; KPLUS_OB=0.0_LDP; NPLUS_OB=0.0_LDP
	JPLUS_OB=0.0D0;  HPLUS_OB=0.0D0; KPLUS_OB=0.0D0; NPLUS_OB=0.0D0

	JMIN_OB=0.0_LDP;   HMIN_OB=0.0_LDP;  KMIN_OB=0.0_LDP;  NMIN_OB=0.0_LDP
	JMIN_OB=0.0D0;   HMIN_OB=0.0D0;  KMIN_OB=0.0D0;  NMIN_OB=0.0D0

	  AV(:,:)=0.0_LDP
	  AV(:,:)=0.0D0

	  CV(:,:)=0.0_LDP
	  CV(:,:)=0.0D0

	        T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	        T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	    IBOUND(LS)=0.0_LDP
	    IBOUND(LS)=0.0D0

	        Q(I)=0.0_LDP
	        Q(I)=0.0D0

	        QH(I)=0.0_LDP
	        QH(I)=0.0D0

	        QH(I)=GAMH(I,LS)*2.0_LDP/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)
	        QH(I)=GAMH(I,LS)*2.0D0/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)

	      QH(NI)=0.0_LDP
	      QH(NI)=0.0D0

	        T1=0.0_LDP
	        T1=0.0D0

	1            *(1.0_LDP+T1*(1.0_LDP-CHI_RAY(NI)/OLDCHI(LS)))
	1            *(1.0D0+T1*(1.0D0-CHI_RAY(NI)/OLDCHI(LS)))

	        DBC=0.0_LDP
	        DBC=0.0D0

	        DBC=0.0_LDP
	        DBC=0.0D0

	          DTAU(I,LS)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dZ
	          DTAU(I,LS)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dZ

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	      TC(NI,LS)=0.0_LDP				!As used.
	      TC(NI,LS)=0.0D0				!As used.

	      DIV(1)=1.0_LDP/(TC(1,LS)+TB(1,LS))
	      DIV(1)=1.0D0/(TC(1,LS)+TB(1,LS))

	        DIV(I)=1.0_LDP/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))
	        DIV(I)=1.0D0/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))

	      XM(1)=0.0_LDP
	      XM(1)=0.0D0

	        XM(I)=-0.5_LDP*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))
	        XM(I)=-0.5D0*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))

	        XM(NI)=0.5_LDP*DTAU(NI-1,LS)*SOURCE_RAY(NI)
	        XM(NI)=0.5D0*DTAU(NI-1,LS)*SOURCE_RAY(NI)

	        XM(NI)=0.0_LDP
	        XM(NI)=0.0D0

	      T1=1.0E-08_LDP*ABS(AV(K,LS))
	      T1=1.0D-08*ABS(AV(K,LS))

	        AV(I,LS)=MAX(0.01_LDP*ABS(AV(I,LS)),T1)
	        AV(I,LS)=MAX(0.01D0*ABS(AV(I,LS)),T1)

	      CV_BOUND(LS)=0.0_LDP
	      CV_BOUND(LS)=0.0D0

	      CV_BOUND(LS)=0.5_LDP*(CV(K+1,LS)+CV(K-1,LS))
	      CV_BOUND(LS)=0.5D0*(CV(K+1,LS)+CV(K-1,LS))

	      I_P(1,LS)=0.0_LDP
	      I_P(1,LS)=0.0D0

	      I_M(1,LS)=0.0_LDP
	      I_M(1,LS)=0.0D0

	        T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	        T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	      Q(1:NI)=0.0_LDP
	      Q(1:NI)=0.0D0

	          DTAU(I,LS)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dZ
	          DTAU(I,LS)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dZ

	          DTAU(I,LS)=0.5_LDP*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +
	          DTAU(I,LS)=0.5D0*dZ*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0_LDP )
	1            dCHIdR_RAY(I)*Z(I,LS)/R_RAY(I,LS) )/6.0D0 )

	        EE(I)=0.0_LDP
	        EE(I)=0.0D0

	        IF(T1 .LT. 700.0_LDP)EE(I)=EXP(-T1)
	        IF(T1 .LT. 700.0D0)EE(I)=EXP(-T1)

	        IF(T1 .GE. 40.0_LDP)THEN
	        IF(T1 .GE. 40.0D0)THEN

	        ELSE IF(T1 .GT. 0.5_LDP)THEN
	        ELSE IF(T1 .GT. 0.5D0)THEN

	          E0(I)=1.0_LDP-EE(I)
	          E0(I)=1.0D0-EE(I)

	          E1(I)=1.0_LDP-E0(I)/T1
	          E1(I)=1.0D0-E0(I)/T1

	          E2(I)=1.0_LDP-2.0_LDP*E1(I)/T1
	          E2(I)=1.0D0-2.0D0*E1(I)/T1

	          E3(I)=1.0_LDP-3.0_LDP*E2(I)/T1
	          E3(I)=1.0D0-3.0D0*E2(I)/T1

	        ELSE IF(T1 .GT. 0.1_LDP)THEN
	        ELSE IF(T1 .GT. 0.1D0)THEN

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20D0*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP*
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0*

	1               (1.0_LDP-T1/10.0_LDP*(1.0_LDP-T1/11.0_LDP*
	1               (1.0D0-T1/10.0D0*(1.0D0-T1/11.0D0*

	1               (1.0_LDP-T1/12.0_LDP*(1.0_LDP-T1/13.0_LDP)))))))) )
	1               (1.0D0-T1/12.0D0*(1.0D0-T1/13.0D0)))))))) )

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0D0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20D0*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP) ))))
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0) ))))

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0d0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	        IF(T1 .GE. 40.0_LDP)THEN
	        IF(T1 .GE. 40.0D0)THEN

	          A1(I,LS)=(6.0_LDP-12.0_LDP/T1)/T1/T1
	          A1(I,LS)=(6.0D0-12.0/T1)/T1/T1

	          A2(I,LS)=1.0_LDP-A1(I,LS)
	          A2(I,LS)=1.0D0-A1(I,LS)

	          A3(I,LS)=(2.0_LDP-6.0_LDP/T1)/T1
	          A3(I,LS)=(2.0D0-6.0D0/T1)/T1

	          A4(I,LS)=(4.0_LDP-6.0_LDP/T1)/T1-1.0_LDP
	          A4(I,LS)=(4.0D0-6.0D0/T1)/T1-1.0D0

	          A1(I,LS)=E0(I)-3.0_LDP*E2(I)+2.0_LDP*E3(I)
	          A1(I,LS)=E0(I)-3.0D0*E2(I)+2.0D0*E3(I)

	          A2(I,LS)=3.0_LDP*E2(I)-2.0_LDP*E3(I)
	          A2(I,LS)=3.0D0*E2(I)-2.0D0*E3(I)

	          A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0_LDP*E2(I)+E3(I))
	          A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0D0*E2(I)+E3(I))

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5D0*ABS(dS(1)))

	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5D0*ABS(dS(I)))

	1               MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1               MIN(ABS(S(NI-1)),0.5D0*ABS(dS(NI)))

            I_M(1,LS)=0.0_LDP
            I_M(1,LS)=0.0D0

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5D0*ABS(dS(1)))

	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5D0*ABS(dS(I)))

	1            MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1            MIN(ABS(S(NI-1)),0.5D0*ABS(dS(NI)))

	    CV_BOUND(LS)=0.5_LDP*(I_P(K,LS)-I_M(K,LS))
	    CV_BOUND(LS)=0.5D0*(I_P(K,LS)-I_M(K,LS))

	      AV(I,LS)=0.5_LDP*( I_P(I,LS)+I_M(I,LS) )
	      AV(I,LS)=0.5D0*( I_P(I,LS)+I_M(I,LS) )

	      CV(I,LS)= 0.5_LDP*( I_P(I,LS)-I_M(I,LS) )
	      CV(I,LS)= 0.5D0*( I_P(I,LS)-I_M(I,LS) )

	HBC=0.0_LDP			!H/J at model outer boundary.
	HBC=0.0D0			!H/J at model outer boundary.

	NBC=0.0_LDP			!N/J at model outer boundary.
	NBC=0.0D0			!N/J at model outer boundary.

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	JNU_STORE(:)=0.0_LDP			!1:ND
	JNU_STORE(:)=0.0D0			!1:ND

	HNU_STORE(:)=0.0_LDP
	HNU_STORE(:)=0.0D0

	KNU_STORE(:)=0.0_LDP
	KNU_STORE(:)=0.0D0

	NNU_STORE(:)=0.0_LDP
	NNU_STORE(:)=0.0D0

	  T2=0.0_LDP; T2=MAX(T2,AV(K,LS)-CV_BOUND(LS))
	  T2=0.0D0; T2=MAX(T2,AV(K,LS)-CV_BOUND(LS))

	  T1=AV(K,LS)-0.5_LDP*I_M_IN_BND(LS)
	  T1=AV(K,LS)-0.5D0*I_M_IN_BND(LS)

                T2=0.5_LDP*(R(I)+R(I+1))
                T2=0.5D0*(R(I)+R(I+1))

                HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
                HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

                NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
                NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	    HNU_AT_OB=0.0_LDP; NNU_AT_OB=0.0_LDP
	    HNU_AT_OB=0.0D0; NNU_AT_OB=0.0D0

	      IPLUS_P(LS)=2.0_LDP*CV_BOUND(LS)
	      IPLUS_P(LS)=2.0D0*CV_BOUND(LS)

	      T2=0.5_LDP*(R(I)+R(I+1))
	      T2=0.5D0*(R(I)+R(I+1))

	      T1=( 2.0_LDP*T2-(R_RAY(K,LS)+R_RAY(K+1,LS)) )/(R_RAY(K+2,LS)-R_RAY(K,LS))
	      T1=( 2.0D0*T2-(R_RAY(K,LS)+R_RAY(K+1,LS)) )/(R_RAY(K+2,LS)-R_RAY(K,LS))

	      HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      HNU_STORE(I)=HNU_STORE(I)+HMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	      NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      NNU_STORE(I)=NNU_STORE(I)+NMIDQW(I,LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	  HNU_AT_OB=0.0_LDP; NNU_AT_OB=0.0_LDP
	  HNU_AT_OB=0.0D0; NNU_AT_OB=0.0D0

	    IPLUS_P(LS)=2.0_LDP*CV_BOUND(LS)
	    IPLUS_P(LS)=2.0D0*CV_BOUND(LS)

	    HNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/3.0_LDP
	    HNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/3.0D0

	    NNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/5.0_LDP
	    NNU_AT_IB=DBB/R(ND)/CHI_RAY(NI)/5.0D0

	    HNU_AT_IB=0.0_LDP; NNU_AT_IB=0.0_LDP
	    HNU_AT_IB=0.0D0; NNU_AT_IB=0.0D0

	      HNU_AT_IB=HNU_AT_IB+0.5_LDP*IC*HQW(ND,LS)
	      HNU_AT_IB=HNU_AT_IB+0.5D0*IC*HQW(ND,LS)

	      NNU_AT_IB=NNU_AT_IB+0.5_LDP*IC*NQW(ND,LS)
	      NNU_AT_IB=NNU_AT_IB+0.5D0*IC*NQW(ND,LS)

	    HNU_AT_IB=0.0_LDP
	    HNU_AT_IB=0.0D0

	    NNU_AT_IB=0.0_LDP
	    NNU_AT_IB=0.0D0

	    HNU_AT_IB=0.0_LDP; NNU_AT_IB=0.0_LDP
	    HNU_AT_IB=0.0D0; NNU_AT_IB=0.0D0

	      HNU_AT_IB=HNU_AT_IB+0.5_LDP*(IC-I_M_IN_BND(LS))*HQW(ND,LS)
	      HNU_AT_IB=HNU_AT_IB+0.5D0*(IC-I_M_IN_BND(LS))*HQW(ND,LS)

	      NNU_AT_IB=NNU_AT_IB+0.5_LDP*(IC-I_M_IN_BND(LS))*NQW(ND,LS)
	      NNU_AT_IB=NNU_AT_IB+0.5D0*(IC-I_M_IN_BND(LS))*NQW(ND,LS)

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	IN_HBC=IN_HBC/(2.0_LDP*JNU_STORE(ND)-IC)
	IN_HBC=IN_HBC/(2.0D0*JNU_STORE(ND)-IC)

	  T1=0.0_LDP
	  T1=0.0D0


fgrey_norel_v1.f

	PI=ACOS(-1.0_LDP)
	PI=ACOS(-1.0D0)

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	IBOUND=0.0_LDP
	IBOUND=0.0D0

	FS_J(:)=0.0_LDP
	FS_J(:)=0.0D0

	FS_H(:)=0.0_LDP
	FS_H(:)=0.0D0

	FS_K(:)=0.0_LDP
	FS_K(:)=0.0D0

	H_INBC=0.0_LDP
	H_INBC=0.0D0

	H_OUTBC=0.0_LDP
	H_OUTBC=0.0D0

	T1=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	T1=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	DBB=3.0_LDP*T1/R(ND)/R(ND)
	DBB=3.0D0*T1/R(ND)/R(ND)

	      TA(I)=4.0_LDP*TA(I)*( (1.0_LDP-T1)**2 + T1*T1*TA(I) )
	      TA(I)=4.0D0*TA(I)*( (1.0D0-T1)**2 + T1*T1*TA(I) )

	      DTAU(I)=0.5_LDP*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))
	      DTAU(I)=0.5D0*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))

	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0_LDP)
	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0D0)

	      VU(I)=1.0_LDP/DTAU(I)
	      VU(I)=1.0D0/DTAU(I)

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-RJ(I)*CHI(I)*(DTAU(I-1)+DTAU(I))*0.5_LDP/CHI_MOD(I)
	      XM(I)=-RJ(I)*CHI(I)*(DTAU(I-1)+DTAU(I))*0.5D0/CHI_MOD(I)

	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0_LDP
	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0D0

	      XM(NI)=0.5_LDP*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)
	      XM(NI)=0.5D0*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)

	      TB(NI)=1.0_LDP+VU(NI-1)
	      TB(NI)=1.0D0+VU(NI-1)

	    TC(NI)=0.0_LDP
	    TC(NI)=0.0D0

	    XM(1)=0.0_LDP
	    XM(1)=0.0D0

	    DTAU(1)=0.5_LDP*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0
	    DTAU(1)=0.5D0*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0

	    E2=1.0_LDP-(1.0_LDP-E1)/DTAU(1)
	    E2=1.0D0-(1.0D0-E1)/DTAU(1)

	    E3=(1.0_LDP-E1)/DTAU(1)-E1
	    E3=(1.0D0-E1)/DTAU(1)-E1

	    IF(DTAU(1) .LT. 1.0E-03_LDP)THEN
	    IF(DTAU(1) .LT. 1.0D-03)THEN

	      E2=DTAU(1)*0.5_LDP+DTAU(1)*DTAU(1)/6.0_LDP
	      E2=DTAU(1)*0.5D0+DTAU(1)*DTAU(1)/6.0D0

	      E3=DTAU(1)*0.5_LDP-DTAU(1)*DTAU(1)/3.0_LDP
	      E3=DTAU(1)*0.5D0-DTAU(1)*DTAU(1)/3.0D0

	    VU(1)=1.0_LDP/DTAU(1)
	    VU(1)=1.0D0/DTAU(1)

            XM(1)=0.5_LDP*(XM(2)*E1+TA(1)*E2+TA(2)*E3)
            XM(1)=0.5D0*(XM(2)*E1+TA(1)*E2+TA(2)*E3)

	  TA(I)=0.25_LDP*FS_H(I)*(R(I)+R(I+1))**2
	  TA(I)=0.25D0*FS_H(I)*(R(I)+R(I+1))**2

	  T1=4.1274E-12_LDP*R(1)*R(1)*( FS_H(1)+BETA(1)*FS_J(1)*
	  T1=4.1274D-12*R(1)*R(1)*( FS_H(1)+BETA(1)*FS_J(1)*

	1         (1.0_LDP+FEDD(1))/(1.0_LDP-BETA(1)*BETA(1)) )
	1         (1.0D0+FEDD(1))/(1.0D0-BETA(1)*BETA(1)) )

	  T1=4.1274E-12_LDP*R(1)*R(1)*FS_H(1)
	  T1=4.1274D-12*R(1)*R(1)*FS_H(1)


fine_chi_grid.f


fine_r_grid.f

	DATA VDOP_FRAC_SAV/-1000001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-1000001.1D0/    !Absurd value

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	   RSQ_GAM_SM(I)=R_SM(I)*R_SM(I)/SQRT(1.0_LDP-(V_SM(I)/C_KMS)**2)
	   RSQ_GAM_SM(I)=R_SM(I)*R_SM(I)/SQRT(1.0D0-(V_SM(I)/C_KMS)**2)

	    R_MID_SM(I)=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    R_MID_SM(I)=0.5D0*(R_SM(I)+R_SM(I+1))

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  GAM_REL(I)=SQRT(1.0_LDP/(1.0_LDP-(V(I)/C_KMS)**2))
	  GAM_REL(I)=SQRT(1.0D0/(1.0D0-(V(I)/C_KMS)**2))


gauleg.f

	REAL(KIND=LDP), PARAMETER :: EPS=3.0E-14_LDP
	REAL(KIND=LDP), PARAMETER :: EPS=3.0D-14

	XM=0.5_LDP*(X2+X1)
	XM=0.5D0*(X2+X1)

	XL=0.5_LDP*(X2-X1)
	XL=0.5D0*(X2-X1)

	  Z=COS(3.141592654_LDP*(I-.25_LDP)/(N+.5_LDP))
	  Z=COS(3.141592654D0*(I-.25D0)/(N+.5D0))

	    P1=1._LDP
	    P1=1.D0

	    P2=0._LDP
	    P2=0.D0

	      P1=((2._LDP*J-1._LDP)*Z*P2-(J-1._LDP)*P3)/J
	      P1=((2.D0*J-1.D0)*Z*P2-(J-1.D0)*P3)/J

	    dP=N*(Z*P1-P2)/(Z*Z-1._LDP)
	    dP=N*(Z*P1-P2)/(Z*Z-1.D0)

	  W(I)=2._LDP*XL/((1._LDP-Z*Z)*dP*dP)
	  W(I)=2.D0*XL/((1.D0-Z*Z)*dP*dP)

	  SUM=0.0_LDP
	  SUM=0.0D0

	  IF( ABS(ANS-SUM)/P1 .GT. 1.0E-12_LDP)THEN
	  IF( ABS(ANS-SUM)/P1 .GT. 1.0D-12)THEN


get_ibound.f

	REAL(KIND=LDP), SAVE:: FREQ_SAV=0.0_LDP           !Previous frequency
	REAL(KIND=LDP), SAVE:: FREQ_SAV=0.0D0           !Previous frequency

	  FREQ_SAV=1.0E+30_LDP			!Big value
	  FREQ_SAV=1.0D+30			!Big value

	    DO WHILE ( (MU(LS)-ANG_GRID(J))*(ANG_GRID(J+1)-MU(LS)) .LT. 0.0_LDP )
	    DO WHILE ( (MU(LS)-ANG_GRID(J))*(ANG_GRID(J+1)-MU(LS)) .LT. 0.0D0 )

	    DIST(LS)=(1.0_LDP-T2)*ANG_VARIATION(J)+T2*ANG_VARIATION(J+1)
	    DIST(LS)=(1.0D0-T2)*ANG_VARIATION(J)+T2*ANG_VARIATION(J+1)

	  IBOUND=0.0_LDP
	  IBOUND=0.0D0

	  T2=(1.0_LDP-T1)*INTENSITY(ML)+T1*INTENSITY(ML+1)
	  T2=(1.0D0-T1)*INTENSITY(ML)+T1*INTENSITY(ML+1)


get_ibound_old.f

	    DO WHILE ( (MU(LS)-ANG_GRID(J))*(NU_GRID(J+1)-MU(LS)) .LT. 0.0_LDP )
	    DO WHILE ( (MU(LS)-ANG_GRID(J))*(NU_GRID(J+1)-MU(LS)) .LT. 0.0D0 )

	  IBOUND=0.0_LDP
	  IBOUND=0.0D0

	    IMU1=(1.0_LDP-T1)*INTENSITY(J,ML)+T1*INTENSITY(J,ML+1)
	    IMU1=(1.0D0-T1)*INTENSITY(J,ML)+T1*INTENSITY(J,ML+1)

	    IMU2=(1.0_LDP-T1)*INTENSITY(J+1,ML)+T1*INTENSITY(J+1,ML+1)
	    IMU2=(1.0D0-T1)*INTENSITY(J+1,ML)+T1*INTENSITY(J+1,ML+1)

	    IBOUND(LS)=(1.0_LDP-T2)*IMU1+T2*IMU2
	    IBOUND(LS)=(1.0D0-T2)*IMU1+T2*IMU2


get_jh_at_prev_time_step.f

	REAL(KIND=LDP), SAVE :: NU_SAV=0.0_LDP
	REAL(KIND=LDP), SAVE :: NU_SAV=0.0D0

	  ALLOCATE (NUST(NSM));        NUST=0.0_LDP
	  ALLOCATE (NUST(NSM));        NUST=0.0D0

	    LOG_OLD_MIDV(I+1)=LOG( 0.5_LDP*(OLD_V(I)+OLD_V(I+1)) )
	    LOG_OLD_MIDV(I+1)=LOG( 0.5D0*(OLD_V(I)+OLD_V(I+1)) )

	    LOG_MIDV(I+1)=LOG( 0.5_LDP*(V(I)+V(I+1)) )
	    LOG_MIDV(I+1)=LOG( 0.5D0*(V(I)+V(I+1)) )

	  T1=1.0E-07_LDP					!Altered 3-Feb-2008
	  T1=1.0D-07					!Altered 3-Feb-2008

	  T1=1.0E-07_LDP
	  T1=1.0D-07

	DELTA_TIME_SECS=1.0E+05_LDP*(R(ND)-OLD_R(ND_OLD))/V(ND)
	DELTA_TIME_SECS=1.0D+05*(R(ND)-OLD_R(ND_OLD))/V(ND)

	IF(DELTA_TIME_SECS .LE. 0.0_LDP)THEN
	IF(DELTA_TIME_SECS .LE. 0.0D0)THEN

	    OLD_J(:)=0.0_LDP; OLD_H(:)=0.0_LDP; H_INBC_OLDT=0.0_LDP; H_OUTBC_OLDT=0.0_LDP
	    OLD_J(:)=0.0D0; OLD_H(:)=0.0; H_INBC_OLDT=0.0D0; H_OUTBC_OLDT=0.0D0

	    H_INBC_OLDT=0.5E+15_LDP*H_INBC_OLDT
	    H_INBC_OLDT=0.5D+15*H_INBC_OLDT

	    OLD_J=0.5E+15_LDP*OLD_J; OLD_H=0.5E+15_LDP*OLD_H;
	    OLD_J=0.5D+15*OLD_J; OLD_H=0.5D+15*OLD_H;

	    T1=1.0E-12_LDP; IF( .NOT. EQUAL(V(1),OLD_V(1),T1) )H_OUTBC_OLDT=WRK_NEW_H(1)/NEW_J(1)
	    T1=1.0D-12; IF( .NOT. EQUAL(V(1),OLD_V(1),T1) )H_OUTBC_OLDT=WRK_NEW_H(1)/NEW_J(1)

	    T1=1.0E-12_LDP; IF( .NOT. EQUAL(V(1),OLD_V(1),T1) )H_OUTBC_OLDT=WRK_NEW_H(1)/NEW_J(1)
	    T1=1.0D-12; IF( .NOT. EQUAL(V(1),OLD_V(1),T1) )H_OUTBC_OLDT=WRK_NEW_H(1)/NEW_J(1)

	  NUST=1.0E+10_LDP				!A big number
	  NUST=1.0D+10				!A big number

	  IF(ABS(NU/NUST(1)-1.0_LDP) .GT. 1.0E-10_LDP)THEN
	  IF(ABS(NU/NUST(1)-1.0D0) .GT. 1.0D-10)THEN

	    OLD_J(I)=(1.0_LDP-T1)*JST(I,INDX) + T1*JST(I,INDX-1)
	    OLD_J(I)=(1.0D0-T1)*JST(I,INDX) + T1*JST(I,INDX-1)

	    OLD_H(I)=(1.0_LDP-T1)*HST(I,INDX) + T1*HST(I,INDX-1)
	    OLD_H(I)=(1.0D0-T1)*HST(I,INDX) + T1*HST(I,INDX-1)

	  H_INBC_OLDT=(1.0_LDP-T1)*H_INBC_ST(INDX) + T1*H_INBC_ST(INDX-1)
	  H_INBC_OLDT=(1.0D0-T1)*H_INBC_ST(INDX) + T1*H_INBC_ST(INDX-1)

	  H_OUTBC_OLDT=(1.0_LDP-T1)*H_OUTBC_ST(INDX) + T1*H_OUTBC_ST(INDX-1)
	  H_OUTBC_OLDT=(1.0D0-T1)*H_OUTBC_ST(INDX) + T1*H_OUTBC_ST(INDX-1)

	T1=1.0E-12_LDP; IF(.NOT. EQUAL(V(1),OLD_V(1),T1) )H_OUTBC_OLDT=WRK_NEW_H(1)/NEW_J(1)
	T1=1.0D-12; IF(.NOT. EQUAL(V(1),OLD_V(1),T1) )H_OUTBC_OLDT=WRK_NEW_H(1)/NEW_J(1)


get_moms_ddt.f

	   RMID(I)=0.5_LDP*(R(I)+R(I+1))
	   RMID(I)=0.5D0*(R(I)+R(I+1))


get_moms_non_rel.f

	   K_ON_J_SAVE(:)=0.0_LDP;  NMID_ON_HMID_SAVE(1:ND)=0.0_LDP; NMID_ON_J_SAVE(1:ND)=0.0_LDP
	   K_ON_J_SAVE(:)=0.0D0;  NMID_ON_HMID_SAVE(1:ND)=0.0D0; NMID_ON_J_SAVE(1:ND)=0.0D0

	   RMID(I)=0.5_LDP*(R(I)+R(I+1))
	   RMID(I)=0.5D0*(R(I)+R(I+1))

	  NMID_ON_HMID(1:NDM1)=0.0_LDP
	  NMID_ON_HMID(1:NDM1)=0.0D0

	  NMID_ON_J(1:NDM1)=0.0_LDP
	  NMID_ON_J(1:NDM1)=0.0D0

	      T1=100.0_LDP
	      T1=100.0D0

	    IF(T1 .GT. 1.1_LDP .OR. T1 .LT. 0.05_LDP)THEN
	    IF(T1 .GT. 1.1 .OR. T1 .LT. 0.05)THEN

	      NMID_ON_HMID(I)=0.0_LDP
	      NMID_ON_HMID(I)=0.0D0

	  NMID_ON_J(1:NDM1)=0.0_LDP
	  NMID_ON_J(1:NDM1)=0.0D0

	       IF(NMID_ON_HMID(I) .GT. 1.0_LDP)THEN
	       IF(NMID_ON_HMID(I) .GT. 1.0D0)THEN

	         NMID_ON_HMID(I)=1.0_LDP
	         NMID_ON_HMID(I)=1.0D0

	       ELSE IF(NMID_ON_HMID(I) .LT. 0.01_LDP)THEN
	       ELSE IF(NMID_ON_HMID(I) .LT. 0.01D0)THEN

	         NMID_ON_HMID(I)=0.01_LDP
	         NMID_ON_HMID(I)=0.01D0

	      NMID_ON_HMID(I)=0.0_LDP              !Later replaced by average.
	      NMID_ON_HMID(I)=0.0D0              !Later replaced by average.


get_moms_rel.f

	   RMID(I)=0.5_LDP*(R(I)+R(I+1))
	   RMID(I)=0.5D0*(R(I)+R(I+1))

	    H_ON_J(I)=MIN(1.0_LDP,H_ON_J(I))
	    H_ON_J(I)=MIN(1.0D0,H_ON_J(I))

	    H_ON_J(I)=MAX(-1.0_LDP,H_ON_J(I))
	    H_ON_J(I)=MAX(-1.0D0,H_ON_J(I))

	      T1=0.5_LDP*(GAM_REL_STORE(I)+GAM_REL_STORE(I+1))
	      T1=0.5D0*(GAM_REL_STORE(I)+GAM_REL_STORE(I+1))

	      T1=0.5_LDP*(GAM_REL_STORE(I)+GAM_REL_STORE(I+1))
	      T1=0.5D0*(GAM_REL_STORE(I)+GAM_REL_STORE(I+1))

	      T1=0.5_LDP*(GAM_REL_STORE(I)+GAM_REL_STORE(I+1))
	      T1=0.5D0*(GAM_REL_STORE(I)+GAM_REL_STORE(I+1))

	  NMID_ON_HMID(1:NDM1)=0.0_LDP
	  NMID_ON_HMID(1:NDM1)=0.0D0

	 NMID_ON_J(1:NDM1)=0.0_LDP
	 NMID_ON_J(1:NDM1)=0.0D0

	      T1=100.0_LDP
	      T1=100.0D0

	    IF(T1 .GT. 1.1_LDP .OR. T1 .LT. 0.05_LDP)THEN
	    IF(T1 .GT. 1.1 .OR. T1 .LT. 0.05)THEN

	      NMID_ON_HMID(I)=0.0_LDP
	      NMID_ON_HMID(I)=0.0D0

	 NMID_ON_J(1:NDM1)=0.0_LDP
	 NMID_ON_J(1:NDM1)=0.0D0

	      IF(NMID_ON_HMID(I) .GT. 1.0_LDP)THEN
	      IF(NMID_ON_HMID(I) .GT. 1.0D0)THEN

	        NMID_ON_HMID(I)=1.0_LDP
	        NMID_ON_HMID(I)=1.0D0

	      ELSE IF(NMID_ON_HMID(I) .LT. 0.01_LDP) THEN
	      ELSE IF(NMID_ON_HMID(I) .LT. 0.01D0) THEN

	        NMID_ON_HMID(I)=0.01_LDP
	        NMID_ON_HMID(I)=0.01D0

	      NMID_ON_HMID(I)=0.0_LDP              !Later replaced by average.
	      NMID_ON_HMID(I)=0.0D0              !Later replaced by average.


get_rsqh_rel.f

	   RMID(I)=0.5_LDP*(R(I)+R(I+1))
	   RMID(I)=0.5D0*(R(I)+R(I+1))


get_rsqj_from_j.f


h_weight.f

      temp(:)=0.0_LDP
      temp(:)=0.0d0

        a1=(angle(j)+angle(j+1))/4.0_LDP
        a1=(angle(j)+angle(j+1))/4.0d0

     *      angle(j+1)*angle(j+1))/6.0_LDP
     *      angle(j+1)*angle(j+1))/6.0d0

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**2-angle(nw)**2)/4.0_LDP
      check=(angle(1)**2-angle(nw)**2)/4.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**3-angle(nw)**3)/6.0_LDP
      check=(angle(1)**3-angle(nw)**3)/6.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then


jgrey_hub_ddt.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	PI=ACOS(-1.0_LDP)
	PI=ACOS(-1.0D0)

	  F(I)=0.33333_LDP
	  F(I)=0.33333D0

	H_OUTBC=1.0_LDP
	H_OUTBC=1.0D0

	H_INBC=0.2_LDP
	H_INBC=0.2D0

	IBOUND=0.0_LDP
	IBOUND=0.0D0

	T1=1.0E+10_LDP/4.0_LDP/PI
	T1=1.0D+10/4.0D0/PI

	  T1=0.0_LDP
	  T1=0.0D0

	  RECIP_CDELTAT=1.0E+10_LDP/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	  RECIP_CDELTAT=1.0D+10/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	  ROLD_ON_R=1.0_LDP-1.0E-05_LDP*VEL(ND)*DELTA_TIME_SECS/R(ND)
	  ROLD_ON_R=1.0D0-1.0D-05*VEL(ND)*DELTA_TIME_SECS/R(ND)

	  RECIP_CDELTAT=0.0_LDP
	  RECIP_CDELTAT=0.0D0

	  ROLD_ON_R=0.0_LDP
	  ROLD_ON_R=0.0D0

	  RSQ_J_OLDt=0.0_LDP
	  RSQ_J_OLDt=0.0D0

	  RSQ_H_OLDt=0.0_LDP
	  RSQ_H_OLDt=0.0D0

	AVE_DTAU_ON_Q(1)=0.0_LDP; AVE_DTAU_ON_Q(ND)=0.0_LDP
	AVE_DTAU_ON_Q(1)=0.0D0; AVE_DTAU_ON_Q(ND)=0.0D0

          AVE_DTAU_ON_Q(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
          AVE_DTAU_ON_Q(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  T1=2.0_LDP*RECIP_CDELTAT/(CHI(I)+CHI(I+1))
	  T1=2.0D0*RECIP_CDELTAT/(CHI(I)+CHI(I+1))

	  WMID(I)=1.0_LDP+T1+2.0_LDP*T2
	  WMID(I)=1.0D0+T1+2.0D0*T2

	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0_LDP+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)
	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0D0+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)

	T1=1.0_LDP+RECIP_CDELTAT/CHI(1)
	T1=1.0D0+RECIP_CDELTAT/CHI(1)

        TA(1)=0.0_LDP
        TA(1)=0.0D0

	H_INBC=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	H_INBC=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

        TC(ND)=0.0_LDP
        TC(ND)=0.0D0

	    T2=-2.0_LDP*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))
	    T2=-2.0D0*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))

	FS_RSQJ(:)=0.0_LDP
	FS_RSQJ(:)=0.0D0

	FS_RSQH(:)=0.0_LDP
	FS_RSQH(:)=0.0D0

	FS_RSQK(:)=0.0_LDP
	FS_RSQK(:)=0.0D0

	H_OUTBC=0.0_LDP
	H_OUTBC=0.0D0

	T1=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	T1=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	DBB=3.0_LDP*T1/R(ND)/R(ND)
	DBB=3.0D0*T1/R(ND)/R(ND)

	      TB(1)=0.0_LDP         !Cancel so values unimportant
	      TB(1)=0.0D0         !Cancel so values unimportant

	      DTAU(I)=0.5_LDP*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))
	      DTAU(I)=0.5D0*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))

	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0_LDP)
	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0D0)

	      VU(I)=1.0_LDP/DTAU(I)
	      VU(I)=1.0D0/DTAU(I)

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I))*(DTAU(I-1)+DTAU(I))*0.5_LDP/CHI_MOD(I)
	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I))*(DTAU(I-1)+DTAU(I))*0.5D0/CHI_MOD(I)

	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0_LDP
	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0D0

	      XM(NI)=0.5_LDP*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)
	      XM(NI)=0.5D0*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)

	      TB(NI)=1.0_LDP+VU(NI-1)
	      TB(NI)=1.0D0+VU(NI-1)

	    TC(NI)=0.0_LDP
	    TC(NI)=0.0D0

	    XM(1)=0.0_LDP
	    XM(1)=0.0D0

	    DTAU(1)=0.5_LDP*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0
	    DTAU(1)=0.5D0*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0

	    E2=1.0_LDP-(1.0_LDP-E1)/DTAU(1)
	    E2=1.0D0-(1.0D0-E1)/DTAU(1)

	    E3=(1.0_LDP-E1)/DTAU(1)-E1
	    E3=(1.0D0-E1)/DTAU(1)-E1

	    IF(DTAU(1) .LT. 1.0E-03_LDP)THEN
	    IF(DTAU(1) .LT. 1.0D-03)THEN

	      E2=DTAU(1)*0.5_LDP+DTAU(1)*DTAU(1)/6.0_LDP
	      E2=DTAU(1)*0.5D0+DTAU(1)*DTAU(1)/6.0D0

	      E3=DTAU(1)*0.5_LDP-DTAU(1)*DTAU(1)/3.0_LDP
	      E3=DTAU(1)*0.5D0-DTAU(1)*DTAU(1)/3.0D0

            XM(1)=0.5_LDP*(XM(2)*E1+TA(1)*E2+TA(2)*E3)
            XM(1)=0.5D0*(XM(2)*E1+TA(1)*E2+TA(2)*E3)

	T1=1.0E-04_LDP*(3.14159265_LDP/5.67E-05_LDP)**0.25_LDP
	T1=1.0D-04*(3.14159265D0/5.67D-05)**0.25

	  T2=R(I)-1.0E-05_LDP*DELTA_TIME_SECS*VEL(I)
	  T2=R(I)-1.0D-05*DELTA_TIME_SECS*VEL(I)

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)


jgrey_hub_ddt_v2.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	PI=ACOS(-1.0_LDP)
	PI=ACOS(-1.0D0)

	  F(I)=0.33333_LDP
	  F(I)=0.33333D0

	H_OUTBC=1.0_LDP
	H_OUTBC=1.0D0

	H_INBC=0.2_LDP
	H_INBC=0.2D0

	IBOUND=0.0_LDP
	IBOUND=0.0D0

	T1=1.0E+10_LDP/4.0_LDP/PI
	T1=1.0D+10/4.0D0/PI

	  T1=0.0_LDP
	  T1=0.0D0

	  RECIP_CDELTAT=1.0E+10_LDP/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	  RECIP_CDELTAT=1.0D+10/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	  ROLD_ON_R=1.0_LDP-1.0E-05_LDP*VEL(ND)*DELTA_TIME_SECS/R(ND)
	  ROLD_ON_R=1.0D0-1.0D-05*VEL(ND)*DELTA_TIME_SECS/R(ND)

	  RECIP_CDELTAT=0.0_LDP
	  RECIP_CDELTAT=0.0D0

	  ROLD_ON_R=0.0_LDP
	  ROLD_ON_R=0.0D0

	  RSQ_J_OLDt=0.0_LDP
	  RSQ_J_OLDt=0.0D0

	  RSQ_H_OLDt=0.0_LDP
	  RSQ_H_OLDt=0.0D0

	T_FROM_J(1:ND)=0.0_LDP
	T_FROM_J(1:ND)=0.0D0

	OLD_T(1:ND)=0.0_LDP
	OLD_T(1:ND)=0.0D0

	TSTORE(1:ND)=0.0_LDP
	TSTORE(1:ND)=0.0D0

	REDUCTION_FACTOR=40.0_LDP
	REDUCTION_FACTOR=40.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	AVE_DTAU_ON_Q(1)=0.0_LDP; AVE_DTAU_ON_Q(ND)=0.0_LDP
	AVE_DTAU_ON_Q(1)=0.0D0; AVE_DTAU_ON_Q(ND)=0.0D0

          AVE_DTAU_ON_Q(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
          AVE_DTAU_ON_Q(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  T1=2.0_LDP*RECIP_CDELTAT/(CHI(I)+CHI(I+1))
	  T1=2.0D0*RECIP_CDELTAT/(CHI(I)+CHI(I+1))

	  WMID(I)=1.0_LDP+T1+2.0_LDP*T2
	  WMID(I)=1.0D0+T1+2.0D0*T2

	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0_LDP+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)
	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0D0+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)

	T1=1.0_LDP+RECIP_CDELTAT/CHI(1)
	T1=1.0D0+RECIP_CDELTAT/CHI(1)

        TA(1)=0.0_LDP
        TA(1)=0.0D0

	H_INBC=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	H_INBC=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

        TC(ND)=0.0_LDP
        TC(ND)=0.0D0

	    T2=-2.0_LDP*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))
	    T2=-2.0D0*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))

	  IF(TA(I) .LE. 0.0_LDP .OR. RJ(I) .LE. 0.0_LDP)THEN
	  IF(TA(I) .LE. 0.0D0 .OR. RJ(I) .LE. 0.0D0)THEN

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

            T_FROM_J(I)=0.9_LDP*T_FROM_J(I)+0.1_LDP*((PI/5.67E-05_LDP*TA(I))**0.25_LDP)*1.0E-04_LDP
            T_FROM_J(I)=0.9D0*T_FROM_J(I)+0.1D0*((PI/5.67D-05*TA(I))**0.25D0)*1.0D-04

	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01_LDP)BAD_J=.TRUE.
	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01D0)BAD_J=.TRUE.

	IF(REDUCTION_FACTOR .GT. 1.0_LDP)THEN
	IF(REDUCTION_FACTOR .GT. 1.0D0)THEN

	  REDUCTION_FACTOR=MAX(1.0_LDP,REDUCTION_FACTOR-1.0_LDP)
	  REDUCTION_FACTOR=MAX(1.0D0,REDUCTION_FACTOR-1.0D0)

	FS_RSQJ(:)=0.0_LDP
	FS_RSQJ(:)=0.0D0

	FS_RSQH(:)=0.0_LDP
	FS_RSQH(:)=0.0D0

	FS_RSQK(:)=0.0_LDP
	FS_RSQK(:)=0.0D0

	H_OUTBC=0.0_LDP
	H_OUTBC=0.0D0

	T1=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	T1=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	DBB=3.0_LDP*T1/R(ND)/R(ND)
	DBB=3.0D0*T1/R(ND)/R(ND)

	      TB(1)=0.0_LDP         !Cancel so values unimportant
	      TB(1)=0.0D0         !Cancel so values unimportant

	      DTAU(I)=0.5_LDP*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))
	      DTAU(I)=0.5D0*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))

	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0_LDP)
	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0D0)

	      VU(I)=1.0_LDP/DTAU(I)
	      VU(I)=1.0D0/DTAU(I)

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5_LDP/CHI_MOD(I)
	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5D0/CHI_MOD(I)

	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0_LDP
	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0D0

	      XM(NI)=0.5_LDP*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)
	      XM(NI)=0.5D0*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)

	      TB(NI)=1.0_LDP+VU(NI-1)
	      TB(NI)=1.0D0+VU(NI-1)

	    TC(NI)=0.0_LDP
	    TC(NI)=0.0D0

	    XM(1)=0.0_LDP
	    XM(1)=0.0D0

	    DTAU(1)=0.5_LDP*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0
	    DTAU(1)=0.5D0*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0

	    E2=1.0_LDP-(1.0_LDP-E1)/DTAU(1)
	    E2=1.0D0-(1.0D0-E1)/DTAU(1)

	    E3=(1.0_LDP-E1)/DTAU(1)-E1
	    E3=(1.0D0-E1)/DTAU(1)-E1

	    IF(DTAU(1) .LT. 1.0E-03_LDP)THEN
	    IF(DTAU(1) .LT. 1.0D-03)THEN

	      E2=DTAU(1)*0.5_LDP+DTAU(1)*DTAU(1)/6.0_LDP
	      E2=DTAU(1)*0.5D0+DTAU(1)*DTAU(1)/6.0D0

	      E3=DTAU(1)*0.5_LDP-DTAU(1)*DTAU(1)/3.0_LDP
	      E3=DTAU(1)*0.5D0-DTAU(1)*DTAU(1)/3.0D0

            XM(1)=0.5_LDP*(XM(2)*E1+TA(1)*E2+TA(2)*E3)
            XM(1)=0.5D0*(XM(2)*E1+TA(1)*E2+TA(2)*E3)

	T1=1.0E-04_LDP*(3.14159265_LDP/5.67E-05_LDP)**0.25_LDP
	T1=1.0D-04*(3.14159265D0/5.67D-05)**0.25

	  T2=R(I)-1.0E-05_LDP*DELTA_TIME_SECS*VEL(I)
	  T2=R(I)-1.0D-05*DELTA_TIME_SECS*VEL(I)

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)


jgrey_hub_ddt_v3.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	PI=ACOS(-1.0_LDP)
	PI=ACOS(-1.0D0)

	  F(I)=0.33333_LDP
	  F(I)=0.33333D0

	H_OUTBC=1.0_LDP
	H_OUTBC=1.0D0

	H_INBC=0.2_LDP
	H_INBC=0.2D0

	IBOUND=0.0_LDP
	IBOUND=0.0D0

	T1=1.0E+10_LDP/4.0_LDP/PI
	T1=1.0D+10/4.0D0/PI

	  T1=0.0_LDP
	  T1=0.0D0

	  RECIP_CDELTAT=1.0E+10_LDP/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	  RECIP_CDELTAT=1.0D+10/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	  ROLD_ON_R=1.0_LDP-1.0E-05_LDP*VEL(ND)*DELTA_TIME_SECS/R(ND)
	  ROLD_ON_R=1.0D0-1.0D-05*VEL(ND)*DELTA_TIME_SECS/R(ND)

	  RECIP_CDELTAT=0.0_LDP
	  RECIP_CDELTAT=0.0D0

	  ROLD_ON_R=1.0_LDP
	  ROLD_ON_R=1.0D0

	  RSQ_J_OLDt=0.0_LDP
	  RSQ_J_OLDt=0.0D0

	  RSQ_H_OLDt=0.0_LDP
	  RSQ_H_OLDt=0.0D0

	  H_INBC_OLDT=0.0_LDP
	  H_INBC_OLDT=0.0D0

	  H_OUTBC_OLDT=0.0_LDP
	  H_OUTBC_OLDT=0.0D0

	  DELTA_TIME_SECS=0.0_LDP
	  DELTA_TIME_SECS=0.0D0

	T_FROM_J(1:ND)=0.0_LDP
	T_FROM_J(1:ND)=0.0D0

	OLD_T(1:ND)=0.0_LDP
	OLD_T(1:ND)=0.0D0

	TSTORE(1:ND)=0.0_LDP
	TSTORE(1:ND)=0.0D0

	REDUCTION_FACTOR=10.0_LDP
	REDUCTION_FACTOR=10.0D0

	F(1:ND)=0.0_LDP
	F(1:ND)=0.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	AVE_DTAU_ON_Q(1)=0.0_LDP; AVE_DTAU_ON_Q(ND)=0.0_LDP
	AVE_DTAU_ON_Q(1)=0.0D0; AVE_DTAU_ON_Q(ND)=0.0D0

          AVE_DTAU_ON_Q(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
          AVE_DTAU_ON_Q(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  T1=2.0_LDP*RECIP_CDELTAT/(CHI(I)+CHI(I+1))
	  T1=2.0D0*RECIP_CDELTAT/(CHI(I)+CHI(I+1))

	  WMID(I)=1.0_LDP+T1+2.0_LDP*T2
	  WMID(I)=1.0D0+T1+2.0D0*T2

	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0_LDP+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)
	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0D0+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)

	T1=1.0_LDP+RECIP_CDELTAT/CHI(1)
	T1=1.0D0+RECIP_CDELTAT/CHI(1)

        TA(1)=0.0_LDP
        TA(1)=0.0D0

	  H_INBC=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	  H_INBC=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

	  H_INBC=0.0_LDP
	  H_INBC=0.0D0

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

          XM(ND)=0.0_LDP
          XM(ND)=0.0D0

        TC(ND)=0.0_LDP
        TC(ND)=0.0D0

	    T2=-2.0_LDP*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))
	    T2=-2.0D0*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))

	  IF(RJ(I) .LE. 0.0_LDP)THEN
	  IF(RJ(I) .LE. 0.0D0)THEN

	    IF(RJ(I+1) .LE. 0.0_LDP .AND. I .NE. 1)THEN
	    IF(RJ(I+1) .LE. 0.0D0 .AND. I .NE. 1)THEN

	    ELSE IF(RJ(I+1) .LE. 0.0_LDP)THEN
	    ELSE IF(RJ(I+1) .LE. 0.0D0)THEN

	  TA(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I))
	  TA(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I))

	  IF(TA(I) .LE. 0.0_LDP)THEN
	  IF(TA(I) .LE. 0.0D0)THEN

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

            T_FROM_J(I)=0.9_LDP*T_FROM_J(I)+0.1_LDP*((PI/5.67E-05_LDP*TA(I))**0.25_LDP)*1.0E-04_LDP
            T_FROM_J(I)=0.9D0*T_FROM_J(I)+0.1D0*((PI/5.67D-05*TA(I))**0.25D0)*1.0D-04

	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01_LDP)BAD_J=.TRUE.
	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01D0)BAD_J=.TRUE.

	IF(REDUCTION_FACTOR .GT. 1.0_LDP)THEN
	IF(REDUCTION_FACTOR .GT. 1.0D0)THEN

	  REDUCTION_FACTOR=MAX(1.0_LDP,REDUCTION_FACTOR/1.2_LDP)
	  REDUCTION_FACTOR=MAX(1.0D0,REDUCTION_FACTOR/1.2D0)

	FS_RSQJ(:)=0.0_LDP
	FS_RSQJ(:)=0.0D0

	FS_RSQH(:)=0.0_LDP
	FS_RSQH(:)=0.0D0

	FS_RSQK(:)=0.0_LDP
	FS_RSQK(:)=0.0D0

	H_OUTBC=0.0_LDP
	H_OUTBC=0.0D0

	T1=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	T1=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	DBB=3.0_LDP*T1/R(ND)/R(ND)
	DBB=3.0D0*T1/R(ND)/R(ND)

	      TB(1)=0.0_LDP         !Cancel so values unimportant
	      TB(1)=0.0D0         !Cancel so values unimportant

	      DTAU(I)=0.5_LDP*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))
	      DTAU(I)=0.5D0*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))

	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0_LDP)
	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0D0)

	      VU(I)=1.0_LDP/DTAU(I)
	      VU(I)=1.0D0/DTAU(I)

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5_LDP/CHI_MOD(I)
	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5D0/CHI_MOD(I)

	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0_LDP
	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0D0

	      XM(NI)=0.5_LDP*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)
	      XM(NI)=0.5D0*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)

	      TB(NI)=1.0_LDP+VU(NI-1)
	      TB(NI)=1.0D0+VU(NI-1)

	    TC(NI)=0.0_LDP
	    TC(NI)=0.0D0

	    XM(1)=0.0_LDP
	    XM(1)=0.0D0

	    DTAU(1)=0.5_LDP*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0
	    DTAU(1)=0.5D0*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0

	    E2=1.0_LDP-(1.0_LDP-E1)/DTAU(1)
	    E2=1.0D0-(1.0D0-E1)/DTAU(1)

	    E3=(1.0_LDP-E1)/DTAU(1)-E1
	    E3=(1.0D0-E1)/DTAU(1)-E1

	    IF(DTAU(1) .LT. 1.0E-03_LDP)THEN
	    IF(DTAU(1) .LT. 1.0D-03)THEN

	      E2=DTAU(1)*0.5_LDP+DTAU(1)*DTAU(1)/6.0_LDP
	      E2=DTAU(1)*0.5D0+DTAU(1)*DTAU(1)/6.0D0

	      E3=DTAU(1)*0.5_LDP-DTAU(1)*DTAU(1)/3.0_LDP
	      E3=DTAU(1)*0.5D0-DTAU(1)*DTAU(1)/3.0D0

            XM(1)=0.5_LDP*(XM(2)*E1+TA(1)*E2+TA(2)*E3)
            XM(1)=0.5D0*(XM(2)*E1+TA(1)*E2+TA(2)*E3)

	T1=1.0E-04_LDP*(3.14159265_LDP/5.67E-05_LDP)**0.25_LDP
	T1=1.0D-04*(3.14159265D0/5.67D-05)**0.25D0

	  T2=R(I)-1.0E-05_LDP*DELTA_TIME_SECS*VEL(I)
	  T2=R(I)-1.0D-05*DELTA_TIME_SECS*VEL(I)

	  T3=T1*( RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I)) )**0.25_LDP
	  T3=T1*( RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I)) )**0.25D0

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

	  RJ(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I))
	  RJ(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I))


jgrey_hub_ddt_v4.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	PI=ACOS(-1.0_LDP)
	PI=ACOS(-1.0D0)

	  F(I)=0.33333_LDP
	  F(I)=0.33333D0

	H_OUTBC=1.0_LDP
	H_OUTBC=1.0D0

	H_INBC=0.2_LDP
	H_INBC=0.2D0

	IBOUND=0.0_LDP
	IBOUND=0.0D0

	T1=1.0E+10_LDP/4.0_LDP/PI
	T1=1.0D+10/4.0D0/PI

	  T1=0.0_LDP
	  T1=0.0D0

	  RECIP_CDELTAT=1.0E+10_LDP/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	  RECIP_CDELTAT=1.0D+10/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	  ROLD_ON_R=1.0_LDP-1.0E-05_LDP*VEL(ND)*DELTA_TIME_SECS/R(ND)
	  ROLD_ON_R=1.0D0-1.0D-05*VEL(ND)*DELTA_TIME_SECS/R(ND)

	  RECIP_CDELTAT=0.0_LDP
	  RECIP_CDELTAT=0.0D0

	  ROLD_ON_R=1.0_LDP
	  ROLD_ON_R=1.0D0

	  RSQ_J_OLDt=0.0_LDP
	  RSQ_J_OLDt=0.0D0

	  RSQ_H_OLDt=0.0_LDP
	  RSQ_H_OLDt=0.0D0

	  H_INBC_OLDT=0.0_LDP
	  H_INBC_OLDT=0.0D0

	  H_OUTBC_OLDT=0.0_LDP
	  H_OUTBC_OLDT=0.0D0

	  DELTA_TIME_SECS=0.0_LDP
	  DELTA_TIME_SECS=0.0D0

	T_FROM_J(1:ND)=0.0_LDP
	T_FROM_J(1:ND)=0.0D0

	OLD_T(1:ND)=0.0_LDP
	OLD_T(1:ND)=0.0D0

	TSTORE(1:ND)=0.0_LDP
	TSTORE(1:ND)=0.0D0

	REDUCTION_FACTOR=10.0_LDP
	REDUCTION_FACTOR=10.0D0

	F(1:ND)=0.0_LDP
	F(1:ND)=0.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	AVE_DTAU_ON_Q(1)=0.0_LDP; AVE_DTAU_ON_Q(ND)=0.0_LDP
	AVE_DTAU_ON_Q(1)=0.0D0; AVE_DTAU_ON_Q(ND)=0.0D0

          AVE_DTAU_ON_Q(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
          AVE_DTAU_ON_Q(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  T1=2.0_LDP*RECIP_CDELTAT/(CHI(I)+CHI(I+1))
	  T1=2.0D0*RECIP_CDELTAT/(CHI(I)+CHI(I+1))

	  WMID(I)=1.0_LDP+T1+2.0_LDP*T2
	  WMID(I)=1.0D0+T1+2.0D0*T2

	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0_LDP+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)
	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0D0+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)

	T1=1.0_LDP+RECIP_CDELTAT/CHI(1)
	T1=1.0D0+RECIP_CDELTAT/CHI(1)

        TA(1)=0.0_LDP
        TA(1)=0.0D0

	  H_INBC=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	  H_INBC=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

	  H_INBC=0.0_LDP
	  H_INBC=0.0D0

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

          XM(ND)=0.0_LDP
          XM(ND)=0.0D0

        TC(ND)=0.0_LDP
        TC(ND)=0.0D0

	    T2=-2.0_LDP*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))
	    T2=-2.0D0*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))

	  IF(RJ(I) .LE. 0.0_LDP)THEN
	  IF(RJ(I) .LE. 0.0D0)THEN

	    IF(RJ(I+1) .LE. 0.0_LDP .AND. I .NE. 1)THEN
	    IF(RJ(I+1) .LE. 0.0D0 .AND. I .NE. 1)THEN

	    ELSE IF(RJ(I+1) .LE. 0.0_LDP)THEN
	    ELSE IF(RJ(I+1) .LE. 0.0D0)THEN

	  TA(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I))
	  TA(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I))

	  IF(TA(I) .LE. 0.0_LDP)THEN
	  IF(TA(I) .LE. 0.0D0)THEN

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

            T_FROM_J(I)=0.9_LDP*T_FROM_J(I)+0.1_LDP*((PI/5.67E-05_LDP*TA(I))**0.25_LDP)*1.0E-04_LDP
            T_FROM_J(I)=0.9D0*T_FROM_J(I)+0.1D0*((PI/5.67D-05*TA(I))**0.25D0)*1.0D-04

	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01_LDP)BAD_J=.TRUE.
	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01D0)BAD_J=.TRUE.

	IF(REDUCTION_FACTOR .GT. 1.0_LDP)THEN
	IF(REDUCTION_FACTOR .GT. 1.0D0)THEN

	  REDUCTION_FACTOR=MAX(1.0_LDP,REDUCTION_FACTOR/1.2_LDP)
	  REDUCTION_FACTOR=MAX(1.0D0,REDUCTION_FACTOR/1.2D0)

	FS_RSQJ(:)=0.0_LDP
	FS_RSQJ(:)=0.0D0

	FS_RSQH(:)=0.0_LDP
	FS_RSQH(:)=0.0D0

	FS_RSQK(:)=0.0_LDP
	FS_RSQK(:)=0.0D0

	H_OUTBC=0.0_LDP
	H_OUTBC=0.0D0

	T1=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	T1=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	DBB=3.0_LDP*T1/R(ND)/R(ND)
	DBB=3.0D0*T1/R(ND)/R(ND)

	      TB(1)=0.0_LDP         !Cancel so values unimportant
	      TB(1)=0.0D0         !Cancel so values unimportant

	      DTAU(I)=0.5_LDP*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))
	      DTAU(I)=0.5D0*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))

	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0_LDP)
	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0D0)

	      VU(I)=1.0_LDP/DTAU(I)
	      VU(I)=1.0D0/DTAU(I)

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5_LDP/CHI_MOD(I)
	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5D0/CHI_MOD(I)

	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0_LDP
	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0D0

	      XM(NI)=0.5_LDP*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)
	      XM(NI)=0.5D0*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)

	      TB(NI)=1.0_LDP+VU(NI-1)
	      TB(NI)=1.0D0+VU(NI-1)

	    TC(NI)=0.0_LDP
	    TC(NI)=0.0D0

	    XM(1)=0.0_LDP
	    XM(1)=0.0D0

	    DTAU(1)=0.5_LDP*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0
	    DTAU(1)=0.5D0*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0

	    E2=1.0_LDP-(1.0_LDP-E1)/DTAU(1)
	    E2=1.0D0-(1.0D0-E1)/DTAU(1)

	    E3=(1.0_LDP-E1)/DTAU(1)-E1
	    E3=(1.0D0-E1)/DTAU(1)-E1

	    IF(DTAU(1) .LT. 1.0E-03_LDP)THEN
	    IF(DTAU(1) .LT. 1.0D-03)THEN

	      E2=DTAU(1)*0.5_LDP+DTAU(1)*DTAU(1)/6.0_LDP
	      E2=DTAU(1)*0.5D0+DTAU(1)*DTAU(1)/6.0D0

	      E3=DTAU(1)*0.5_LDP-DTAU(1)*DTAU(1)/3.0_LDP
	      E3=DTAU(1)*0.5D0-DTAU(1)*DTAU(1)/3.0D0

            XM(1)=0.5_LDP*(XM(2)*E1+TA(1)*E2+TA(2)*E3)
            XM(1)=0.5D0*(XM(2)*E1+TA(1)*E2+TA(2)*E3)

	T1=1.0E-04_LDP*(3.14159265_LDP/5.67E-05_LDP)**0.25_LDP
	T1=1.0D-04*(3.14159265D0/5.67D-05)**0.25D0

	  T2=R(I)-1.0E-05_LDP*DELTA_TIME_SECS*VEL(I)
	  T2=R(I)-1.0D-05*DELTA_TIME_SECS*VEL(I)

	  T3=T1*( RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I)) )**0.25_LDP
	  T3=T1*( RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I)) )**0.25D0

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

	  RJ(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I))
	  RJ(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I))


jgrey_hub_ddt_v5.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	PI=ACOS(-1.0_LDP)
	PI=ACOS(-1.0D0)

	  F(I)=0.33333_LDP
	  F(I)=0.33333D0

	H_OUTBC=1.0_LDP
	H_OUTBC=1.0D0

	H_INBC=0.2_LDP
	H_INBC=0.2D0

	IBOUND=0.0_LDP
	IBOUND=0.0D0

	T1=1.0E+10_LDP/4.0_LDP/PI
	T1=1.0D+10/4.0D0/PI

	  T1=0.0_LDP
	  T1=0.0D0

	  RECIP_CDELTAT=1.0E+10_LDP/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	  RECIP_CDELTAT=1.0D+10/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	  ROLD_ON_R=1.0_LDP-1.0E-05_LDP*VEL(ND)*DELTA_TIME_SECS/R(ND)
	  ROLD_ON_R=1.0D0-1.0D-05*VEL(ND)*DELTA_TIME_SECS/R(ND)

	  RECIP_CDELTAT=0.0_LDP
	  RECIP_CDELTAT=0.0D0

	  ROLD_ON_R=1.0_LDP
	  ROLD_ON_R=1.0D0

	  RSQ_J_OLDt=0.0_LDP
	  RSQ_J_OLDt=0.0D0

	  RSQ_H_OLDt=0.0_LDP
	  RSQ_H_OLDt=0.0D0

	  H_INBC_OLDT=0.0_LDP
	  H_INBC_OLDT=0.0D0

	  H_OUTBC_OLDT=0.0_LDP
	  H_OUTBC_OLDT=0.0D0

	  DELTA_TIME_SECS=0.0_LDP
	  DELTA_TIME_SECS=0.0D0

	T_FROM_J(1:ND)=0.0_LDP
	T_FROM_J(1:ND)=0.0D0

	OLD_T(1:ND)=0.0_LDP
	OLD_T(1:ND)=0.0D0

	TSTORE(1:ND)=0.0_LDP
	TSTORE(1:ND)=0.0D0

	REDUCTION_FACTOR=10.0_LDP
	REDUCTION_FACTOR=10.0D0

	F(1:ND)=0.0_LDP
	F(1:ND)=0.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	  OLD_T=0.0_LDP
	  OLD_T=0.0D0

	  T_FROM_J=0.0_LDP
	  T_FROM_J=0.0D0

	  WORK=0.0_LDP
	  WORK=0.0D0

	AVE_DTAU_ON_Q(1)=0.0_LDP; AVE_DTAU_ON_Q(ND)=0.0_LDP
	AVE_DTAU_ON_Q(1)=0.0D0; AVE_DTAU_ON_Q(ND)=0.0D0

          AVE_DTAU_ON_Q(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
          AVE_DTAU_ON_Q(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  T1=2.0_LDP*RECIP_CDELTAT/(CHI(I)+CHI(I+1))
	  T1=2.0D0*RECIP_CDELTAT/(CHI(I)+CHI(I+1))

	  WMID(I)=1.0_LDP+T1+2.0_LDP*T2
	  WMID(I)=1.0D0+T1+2.0D0*T2

	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0_LDP+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)
	  JFAC(I)=AVE_DTAU_ON_Q(I)*(BETA(I)*SIGMA(I)*(1.0D0+F(I))/R(I)+RECIP_CDELTAT)/CHI(I)

	T1=1.0_LDP+RECIP_CDELTAT/CHI(1)
	T1=1.0D0+RECIP_CDELTAT/CHI(1)

        TA(1)=0.0_LDP
        TA(1)=0.0D0

	  H_INBC=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	  H_INBC=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

	  H_INBC=0.0_LDP
	  H_INBC=0.0D0

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

          XM(ND)=0.0_LDP
          XM(ND)=0.0D0

        TC(ND)=0.0_LDP
        TC(ND)=0.0D0

	RSQ_HFLUX(ND)=0.0_LDP
	RSQ_HFLUX(ND)=0.0D0

	    T2=-2.0_LDP*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))
	    T2=-2.0D0*Q(I)*CHI(I)*(RSQ_HFLUX(I)-RSQ_HFLUX(I-1))/(DTAU(I-1)+DTAU(I))

	  IF(RJ(I) .LE. 0.0_LDP)THEN
	  IF(RJ(I) .LE. 0.0D0)THEN

	    IF(RJ(I+1) .LE. 0.0_LDP .AND. I .NE. 1)THEN
	    IF(RJ(I+1) .LE. 0.0D0 .AND. I .NE. 1)THEN

	    ELSE IF(RJ(I+1) .LE. 0.0_LDP)THEN
	    ELSE IF(RJ(I+1) .LE. 0.0D0)THEN

	  TA(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I))
	  TA(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I))

	  IF(TA(I) .LE. 0.0_LDP)THEN
	  IF(TA(I) .LE. 0.0D0)THEN

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

	      T_FROM_J(I)=0.5_LDP*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))
	      T_FROM_J(I)=0.5D0*(OLD_T(I)*ROLD_ON_R+T_FROM_J(I))

            T_FROM_J(I)=0.9_LDP*T_FROM_J(I)+0.1_LDP*((PI/5.67E-05_LDP*TA(I))**0.25_LDP)*1.0E-04_LDP
            T_FROM_J(I)=0.9D0*T_FROM_J(I)+0.1D0*((PI/5.67D-05*TA(I))**0.25D0)*1.0D-04

	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01_LDP)BAD_J=.TRUE.
	  IF(ABS(T_FROM_J(I)-TSTORE(I)) .GT. 0.01D0)BAD_J=.TRUE.

	IF(REDUCTION_FACTOR .GT. 1.0_LDP)THEN
	IF(REDUCTION_FACTOR .GT. 1.0D0)THEN

	  REDUCTION_FACTOR=MAX(1.0_LDP,REDUCTION_FACTOR/1.2_LDP)
	  REDUCTION_FACTOR=MAX(1.0D0,REDUCTION_FACTOR/1.2D0)

	FS_RSQJ(:)=0.0_LDP
	FS_RSQJ(:)=0.0D0

	FS_RSQH(:)=0.0_LDP
	FS_RSQH(:)=0.0D0

	FS_RSQK(:)=0.0_LDP
	FS_RSQK(:)=0.0D0

	H_OUTBC=0.0_LDP
	H_OUTBC=0.0D0

	T1=3.826E+13_LDP*LUMINOSITY/16.0_LDP/PI/PI
	T1=3.826D+13*LUMINOSITY/16.0D0/PI/PI

	DBB=3.0_LDP*T1/R(ND)/R(ND)
	DBB=3.0D0*T1/R(ND)/R(ND)

	      TB(1)=0.0_LDP         !Cancel so values unimportant
	      TB(1)=0.0D0         !Cancel so values unimportant

	      DTAU(I)=0.5_LDP*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))
	      DTAU(I)=0.5D0*(Z(I)-Z(I+1))*(CHI_MOD(I)+CHI_MOD(I+1)+(Z(I)-Z(I+1))

	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0_LDP)
	1       *(dCHI_MODdR(I+1)*Z(I+1)/R(I+1)-dCHI_MODdR(I)*Z(I)/R(I))/6.0D0)

	      VU(I)=1.0_LDP/DTAU(I)
	      VU(I)=1.0D0/DTAU(I)

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    TC(1)=1.0_LDP/DTAU(1)
	    TC(1)=1.0D0/DTAU(1)

	    TB(1)=-1.0_LDP-TC(1)
	    TB(1)=-1.0D0-TC(1)

	      TB(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)
	      TB(I)=-0.5D0*(DTAU(I-1)+DTAU(I))-TA(I)-TC(I)

	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5_LDP/CHI_MOD(I)
	      XM(I)=-(RJ(I)*CHI(I)+E_RAD_DECAY(I)-WORK(I))*(DTAU(I-1)+DTAU(I))*0.5D0/CHI_MOD(I)

	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0_LDP
	      TB(NI)=-TA(NI)+DTAU(NI-1)/2.0D0

	      XM(NI)=0.5_LDP*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)
	      XM(NI)=0.5D0*DTAU(NI-1)*RJ(NI)*CHI(NI)/CHI_MOD(NI)

	      TB(NI)=1.0_LDP+VU(NI-1)
	      TB(NI)=1.0D0+VU(NI-1)

	    TC(NI)=0.0_LDP
	    TC(NI)=0.0D0

	    XM(1)=0.0_LDP
	    XM(1)=0.0D0

	    DTAU(1)=0.5_LDP*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0
	    DTAU(1)=0.5D0*Z(1)*(CHI_MOD(1)+CHI_MOD(2))		!Z(2)=0.0

	    E2=1.0_LDP-(1.0_LDP-E1)/DTAU(1)
	    E2=1.0D0-(1.0D0-E1)/DTAU(1)

	    E3=(1.0_LDP-E1)/DTAU(1)-E1
	    E3=(1.0D0-E1)/DTAU(1)-E1

	    IF(DTAU(1) .LT. 1.0E-03_LDP)THEN
	    IF(DTAU(1) .LT. 1.0D-03)THEN

	      E2=DTAU(1)*0.5_LDP+DTAU(1)*DTAU(1)/6.0_LDP
	      E2=DTAU(1)*0.5D0+DTAU(1)*DTAU(1)/6.0D0

	      E3=DTAU(1)*0.5_LDP-DTAU(1)*DTAU(1)/3.0_LDP
	      E3=DTAU(1)*0.5D0-DTAU(1)*DTAU(1)/3.0D0

            XM(1)=0.5_LDP*(XM(2)*E1+TA(1)*E2+TA(2)*E3)
            XM(1)=0.5D0*(XM(2)*E1+TA(1)*E2+TA(2)*E3)

	T1=1.0E-04_LDP*(3.14159265_LDP/5.67E-05_LDP)**0.25_LDP
	T1=1.0D-04*(3.14159265D0/5.67D-05)**0.25D0

	  T2=R(I)-1.0E-05_LDP*DELTA_TIME_SECS*VEL(I)
	  T2=R(I)-1.0D-05*DELTA_TIME_SECS*VEL(I)

	  T3=T1*( RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I)) )**0.25_LDP
	  T3=T1*( RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I)) )**0.25D0

	  T1=1.0_LDP+RECIP_CDELTAT/CHI(ND)
	  T1=1.0D0+RECIP_CDELTAT/CHI(ND)

	  RJ(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1_LDP*CHI(I),CHI_PLANCK(I))
	  RJ(I)=RJ(I)+(E_RAD_DECAY(I)-WORK(I))/MAX(0.1D0*CHI(I),CHI_PLANCK(I))


j_weight.f

      temp(:)=0.0_LDP
      temp(:)=0.0d0

        a=(angle(j)-angle(j+1))/4.0_LDP
        a=(angle(j)-angle(j+1))/4.0d0

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)-angle(nw))/2.0_LDP
      check=(angle(1)-angle(nw))/2.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**2-angle(nw)**2)/4.0_LDP
      check=(angle(1)**2-angle(nw)**2)/4.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then


k_weight.f

      temp(:)=0.0_LDP
      temp(:)=0.0d0

     *      angle(j+1)*angle(j+1))/6.0_LDP
     *      angle(j+1)*angle(j+1))/6.0d0

     *      angle(j+1)*angle(j+1)*angle(j+1))/8.0_LDP
     *      angle(j+1)*angle(j+1)*angle(j+1))/8.0d0

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**3-angle(nw)**3)/6.0_LDP
      check=(angle(1)**3-angle(nw)**3)/6.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**4-angle(nw)**4)/8.0_LDP
      check=(angle(1)**4-angle(nw)**4)/8.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then


mod_ray_mom_store.f


mod_space_grid_v2.f


mod_space_grid_v2_gam.f


mod_var_jrel.f

        FEDD_PREV(:)=0.0_LDP
        FEDD_PREV(:)=0.0D0

        GEDD_PREV(:)=0.0_LDP
        GEDD_PREV(:)=0.0D0

        H_ON_J_PREV(:)=0.0_LDP
        H_ON_J_PREV(:)=0.0D0

        N_ON_J_PREV(:)=0.0_LDP
        N_ON_J_PREV(:)=0.0D0

        RSQN_ON_RSQJ_PREV(:)=0.0_LDP
        RSQN_ON_RSQJ_PREV(:)=0.0D0

        KMID_ON_J_PREV(:)=0.0_LDP
        KMID_ON_J_PREV(:)=0.0D0

        JNU_PREV(:)=0.0_LDP
        JNU_PREV(:)=0.0D0

        GAM_RSQHNU_PREV(:)=0.0_LDP
        GAM_RSQHNU_PREV(:)=0.0D0

	HBC_PREV=0.0_LDP
	HBC_PREV=0.0D0

	NBC_PREV=0.0_LDP
	NBC_PREV=0.0D0

	IN_HBC_PREV=0.0_LDP
	IN_HBC_PREV=0.0D0


mod_var_jrel_v2.f

	  IF(IOS .EQ. 0)ALLOCATE(DERIV_SCL_FAC(ND),STAT=IOS); DERIV_SCL_FAC=1.0_LDP
	  IF(IOS .EQ. 0)ALLOCATE(DERIV_SCL_FAC(ND),STAT=IOS); DERIV_SCL_FAC=1.0D0

        JNU_PREV(:)=0.0_LDP
        JNU_PREV(:)=0.0D0

        GAM_RSQHNU_PREV(:)=0.0_LDP
        GAM_RSQHNU_PREV(:)=0.0D0


mod_var_mom_j_cmf.f

	TA=0.0_LDP; TB=0.0_LDP; TC=0.0_LDP; DTAU=0.0_LDP; RSQ_DTAUONQ=0.0_LDP
	TA=0.0D0; TB=0.0D0; TC=0.0D0; DTAU=0.0D0; RSQ_DTAUONQ=0.0D0

	XM=0.0_LDP; SOURCE=0.0_LDP; Q=0.0_LDP; JNU=0.0_LDP; RSQ_HNU=0.0_LDP
	XM=0.0D0; SOURCE=0.0D0; Q=0.0D0; JNU=0.0D0; RSQ_HNU=0.0D0

	VB=0.0_LDP; VC=0.0_LDP; HU=0.0_LDP; HL=0.0_LDP; HS=0.0_LDP
	VB=0.0D0; VC=0.0D0; HU=0.0D0; HL=0.0D0; HS=0.0D0

	EPS_A=0.0_LDP; EPS_B=0.0_LDP; EPS_PREV_A=0.0_LDP; EPS_PREV_B=0.0_LDP
	EPS_A=0.0D0; EPS_B=0.0D0; EPS_PREV_A=0.0D0; EPS_PREV_B=0.0D0

	TX_OLD_d_T=0.0_LDP; TX_OLD_d_dTdR=0.0_LDP
	TX_OLD_d_T=0.0D0; TX_OLD_d_dTdR=0.0D0

	GAM=0.0_LDP; GAMH=0.0_LDP; W=0.0_LDP; WPREV=0.0_LDP
	GAM=0.0D0; GAMH=0.0D0; W=0.0D0; WPREV=0.0D0

	PSI=0.0_LDP; PSIPREV_MOD=0.0_LDP; PSIPREV=0.0_LDP
	PSI=0.0D0; PSIPREV_MOD=0.0D0; PSIPREV=0.0D0


mom_j_cmf_v10.f

	DATA VDOP_FRAC_SAVE/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAVE/-10001.1D0/    !Absurd value

	  RSQJNU(1:ND)=0.0_LDP; RSQJNU_PREV(1:ND)=0.0_LDP
	  RSQJNU(1:ND)=0.0D0; RSQJNU_PREV(1:ND)=0.0D0

	  RSQHNU(1:ND)=0.0_LDP; RSQHNU_PREV(1:ND)=0.0_LDP
	  RSQHNU(1:ND)=0.0D0; RSQHNU_PREV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    EPS(I)=0.0_LDP
	    EPS(I)=0.0D0

	    EPS_PREV(I)=0.0_LDP
	    EPS_PREV(I)=0.0D0

	  HBC_PREV=0.0_LDP;  IN_HBC_PREV=0.0_LDP; NBC_PREV=0.0_LDP
	  HBC_PREV=0.0D0;  IN_HBC_PREV=0.0D0; NBC_PREV=0.0D0

	    CON_GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    CON_GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_GAM(I)=3.33564E-06_LDP*V(I)/R(I)
	    CON_GAM(I)=3.33564D-06*V(I)/R(I)

	  CON_GAM(ND)=3.33564E-06_LDP*V(ND)/R(ND)
	  CON_GAM(ND)=3.33564D-06*V(ND)/R(ND)

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0_LDP+W(I))
	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0D0+W(I))

	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)= (COH_VEC(1)-1.0_LDP) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)
	  TB(1)= (COH_VEC(1)-1.0D0) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP .AND. VERBOSE)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0 .AND. VERBOSE)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	    T1=(RSQJNU(I)+RSQJNU(I+1))/2.0_LDP
	    T1=(RSQJNU(I)+RSQJNU(I+1))/2.0D0

	      RSQHNU(I)=0.99999_LDP*T1
	      RSQHNU(I)=0.99999D0*T1

	      RSQHNU(I)=-0.99999_LDP*T1
	      RSQHNU(I)=-0.99999D0*T1


mom_j_cmf_v11.f

	DATA VDOP_FRAC_SAVE/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAVE/-10001.1D0/    !Absurd value

	  RSQJNU(1:ND)=0.0_LDP; RSQJNU_PREV(1:ND)=0.0_LDP
	  RSQJNU(1:ND)=0.0D0; RSQJNU_PREV(1:ND)=0.0D0

	  RSQHNU(1:ND)=0.0_LDP; RSQHNU_PREV(1:ND)=0.0_LDP
	  RSQHNU(1:ND)=0.0D0; RSQHNU_PREV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    EPS(I)=0.0_LDP
	    EPS(I)=0.0D0

	    EPS_PREV(I)=0.0_LDP
	    EPS_PREV(I)=0.0D0

	  HBC_PREV=0.0_LDP;  IN_HBC_PREV=0.0_LDP; NBC_PREV=0.0_LDP
	  HBC_PREV=0.0D0;  IN_HBC_PREV=0.0D0; NBC_PREV=0.0D0

	    CON_GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    CON_GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_GAM(I)=3.33564E-06_LDP*V(I)/R(I)
	    CON_GAM(I)=3.33564D-06*V(I)/R(I)

	  CON_GAM(ND)=3.33564E-06_LDP*V(ND)/R(ND)
	  CON_GAM(ND)=3.33564D-06*V(ND)/R(ND)

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0_LDP+W(I))
	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0D0+W(I))

	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)= (COH_VEC(1)-1.0_LDP) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)
	  TB(1)= (COH_VEC(1)-1.0D0) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)

	IF(MINVAL(XM) .LE. -1.0E+20_LDP)THEN   !0.0D0)THEN
	IF(MINVAL(XM) .LE. -1.0D+20)THEN   !0.0D0)THEN

	    T1=1.0_LDP
	    T1=1.0D0

	    IF(XM(I) .LE. 0.0_LDP .AND. XM_SAVE(I) .LE. 0.0_LDP)THEN
	    IF(XM(I) .LE. 0.0D0 .AND. XM_SAVE(I) .LE. 0.0D0)THEN

              T1=T1*0.5_LDP
              T1=T1*0.5D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP .AND. VERBOSE)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0 .AND. VERBOSE)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	    T1=(RSQJNU(I)+RSQJNU(I+1))/2.0_LDP
	    T1=(RSQJNU(I)+RSQJNU(I+1))/2.0D0

	      RSQHNU(I)=0.99999_LDP*T1
	      RSQHNU(I)=0.99999D0*T1

	      RSQHNU(I)=-0.99999_LDP*T1
	      RSQHNU(I)=-0.99999D0*T1

	      RSQHNU(I)=0.99999_LDP*T1
	      RSQHNU(I)=0.99999D0*T1

	      RSQHNU(I)=-0.99999_LDP*T1
	      RSQHNU(I)=-0.99999D0*T1


mom_j_cmf_v8.f

	DATA VDOP_FRAC_SAVE/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAVE/-10001.1D0/    !Absurd value

	  RSQJNU(1:ND)=0.0_LDP; RSQJNU_PREV(1:ND)=0.0_LDP
	  RSQJNU(1:ND)=0.0D0; RSQJNU_PREV(1:ND)=0.0D0

	  RSQHNU(1:ND)=0.0_LDP; RSQHNU_PREV(1:ND)=0.0_LDP
	  RSQHNU(1:ND)=0.0D0; RSQHNU_PREV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    EPS(I)=0.0_LDP
	    EPS(I)=0.0D0

	    EPS_PREV(I)=0.0_LDP
	    EPS_PREV(I)=0.0D0

	  HBC_PREV=0.0_LDP;  IN_HBC_PREV=0.0_LDP; NBC_PREV=0.0_LDP
	  HBC_PREV=0.0D0;  IN_HBC_PREV=0.0D0; NBC_PREV=0.0D0

	    CON_GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    CON_GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_GAM(I)=3.33564E-06_LDP*V(I)/R(I)
	    CON_GAM(I)=3.33564D-06*V(I)/R(I)

	  CON_GAM(ND)=3.33564E-06_LDP*V(ND)/R(ND)
	  CON_GAM(ND)=3.33564D-06*V(ND)/R(ND)

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0_LDP+W(I))
	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0D0+W(I))

	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)= (COH_VEC(1)-1.0_LDP) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)
	  TB(1)= (COH_VEC(1)-1.0D0) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP .AND. VERBOSE)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0 .AND. VERBOSE)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0


mom_j_cmf_v9.f

	DATA VDOP_FRAC_SAVE/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAVE/-10001.1D0/    !Absurd value

	  RSQJNU(1:ND)=0.0_LDP; RSQJNU_PREV(1:ND)=0.0_LDP
	  RSQJNU(1:ND)=0.0D0; RSQJNU_PREV(1:ND)=0.0D0

	  RSQHNU(1:ND)=0.0_LDP; RSQHNU_PREV(1:ND)=0.0_LDP
	  RSQHNU(1:ND)=0.0D0; RSQHNU_PREV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    EPS(I)=0.0_LDP
	    EPS(I)=0.0D0

	    EPS_PREV(I)=0.0_LDP
	    EPS_PREV(I)=0.0D0

	  HBC_PREV=0.0_LDP;  IN_HBC_PREV=0.0_LDP; NBC_PREV=0.0_LDP
	  HBC_PREV=0.0D0;  IN_HBC_PREV=0.0D0; NBC_PREV=0.0D0

	    CON_GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    CON_GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_GAM(I)=3.33564E-06_LDP*V(I)/R(I)
	    CON_GAM(I)=3.33564D-06*V(I)/R(I)

	  CON_GAM(ND)=3.33564E-06_LDP*V(ND)/R(ND)
	  CON_GAM(ND)=3.33564D-06*V(ND)/R(ND)

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID(I) )
	      W(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID(I) )

	      WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )
	      WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA(I)*NMID_ON_HMID_PREV(I) )

	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0_LDP+W(I))
	      EPS(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J(I)/(1.0D0+W(I))

	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	      EPS_PREV(I)=GAMH(I)*AV_SIGMA(I)*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	  PSI(I)=DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	  PSIPREV(I)=DTAUONQ(I)*GAM(I)*(  1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	    TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)= (COH_VEC(1)-1.0_LDP) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)
	  TB(1)= (COH_VEC(1)-1.0D0) -(HL(1)+HBC+EPS(1))/T1 -PSI(1)

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP .AND. VERBOSE)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0 .AND. VERBOSE)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	    T1=(RSQJNU(I)+RSQJNU(I+1))/2.0_LDP
	    T1=(RSQJNU(I)+RSQJNU(I+1))/2.0D0

	      RSQHNU(I)=0.99999_LDP*T1
	      RSQHNU(I)=0.99999D0*T1

	      RSQHNU(I)=-0.99999_LDP*T1
	      RSQHNU(I)=-0.99999D0*T1


mom_j_ddt_v1.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0_LDP
	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    CON_GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS
	    CON_GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(:)=0.0_LDP
	  COH_VEC(:)=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    dH(I)=0.0_LDP
	    dH(I)=0.0D0

	    dH_OLDT(I)=0.0_LDP
	    dH_OLDT(I)=0.0D0

	    DJDt(I)=0.0_LDP
	    DJDt(I)=0.0D0

	  HONJ_OUTBC_PREV=0.0_LDP;  HFLUX_AT_INB_PREV=0.0_LDP
	  HONJ_OUTBC_PREV=0.0D0;  HFLUX_AT_INB_PREV=0.0D0

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  HU(I)=F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=GAMH(I)/(1.0_LDP+W(I))
	  HS(I)=GAMH(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)
	  TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)

	TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  HFLUX_AT_INB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  HFLUX_AT_INB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0


mom_j_ddt_v2.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0_LDP
	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    CON_GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS
	    CON_GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(:)=0.0_LDP
	  COH_VEC(:)=0.0D0

	IF(DTAU(ND-1) .LT. 1.0E-05_LDP)DTAU(ND-1)=1.0E-05_LDP
	IF(DTAU(ND-1) .LT. 1.0D-05)DTAU(ND-1)=1.0D-05

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    dH(I)=0.0_LDP
	    dH(I)=0.0D0

	    dH_OLDT(I)=0.0_LDP
	    dH_OLDT(I)=0.0D0

	    DJDt(I)=0.0_LDP
	    DJDt(I)=0.0D0

	  HONJ_OUTBC_PREV=0.0_LDP;  RSQH_AT_IB_PREV=0.0_LDP; RSQH_AT_OB_PREV=0.0_LDP
	  HONJ_OUTBC_PREV=0.0D0;  RSQH_AT_IB_PREV=0.0D0; RSQH_AT_OB_PREV=0.0D0

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  HU(I)=F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=GAMH(I)/(1.0_LDP+W(I))
	  HS(I)=GAMH(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)
	  TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	IF(INIT)DJDt(1)=0.0_LDP
	IF(INIT)DJDt(1)=0.0D0

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0_LDP+GAM(1)+DJDT(1))
	  TB(1)=FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0D0+GAM(1)+DJDT(1))

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	DJDt(ND)=0.0_LDP
	DJDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  XM(ND)=XM(ND)+0.10_LDP*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.10D0*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=TB(ND)+0.10_LDP*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.10D0*F(ND)/DTAU(ND-1)

	  TB(ND)=FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+DjdT(ND)+GAM(ND))
	  TB(ND)=FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+DjdT(ND)+GAM(ND))

	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0_LDP-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )
	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0D0-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )

          TB(ND)=TB(ND)+0.1_LDP*FMIN/DTAU(ND-1)
          TB(ND)=TB(ND)+0.1D0*FMIN/DTAU(ND-1)

          XM(ND)=XM(ND)+0.1_LDP*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)
          XM(ND)=XM(ND)+0.1D0*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	     IF(XM(I) .LE. 0.0_LDP)THEN
	     IF(XM(I) .LE. 0.0D0)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	  T1=(XM(I)+XM(I+1))/2.0_LDP
	  T1=(XM(I)+XM(I+1))/2.0D0

	    RSQHNU(I)=0.99_LDP*T1
	    RSQHNU(I)=0.99D0*T1

	    RSQHNU(I)=-0.99_LDP*T1
	    RSQHNU(I)=-0.99D0*T1


mom_j_ddt_v3.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0_LDP
	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    CON_GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS
	    CON_GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(:)=0.0_LDP
	  COH_VEC(:)=0.0D0

	IF(DTAU(ND-1) .LT. 1.0E-05_LDP)DTAU(ND-1)=1.0E-05_LDP
	IF(DTAU(ND-1) .LT. 1.0D-05)DTAU(ND-1)=1.0D-05

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    dH(I)=0.0_LDP
	    dH(I)=0.0D0

	    dH_OLDT(I)=0.0_LDP
	    dH_OLDT(I)=0.0D0

	    DJDt(I)=0.0_LDP
	    DJDt(I)=0.0D0

	  HONJ_OUTBC_PREV=0.0_LDP;  RSQH_AT_IB_PREV=0.0_LDP; RSQH_AT_OB_PREV=0.0_LDP
	  HONJ_OUTBC_PREV=0.0D0;  RSQH_AT_IB_PREV=0.0D0; RSQH_AT_OB_PREV=0.0D0

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  HU(I)=F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=GAMH(I)/(1.0_LDP+W(I))
	  HS(I)=GAMH(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)
	  TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	IF(INIT)DJDt(1)=0.0_LDP
	IF(INIT)DJDt(1)=0.0D0

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0_LDP+GAM(1)+DJDT(1))
	  TB(1)=FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0D0+GAM(1)+DJDT(1))

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	DJDt(ND)=0.0_LDP
	DJDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  XM(ND)=XM(ND)+0.10_LDP*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.10D0*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=TB(ND)+0.10_LDP*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.10D0*F(ND)/DTAU(ND-1)

	  TB(ND)=FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+DjdT(ND)+GAM(ND))
	  TB(ND)=FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+DjdT(ND)+GAM(ND))

	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0_LDP-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )
	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0D0-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )

          TB(ND)=TB(ND)+0.1_LDP*FMIN/DTAU(ND-1)
          TB(ND)=TB(ND)+0.1D0*FMIN/DTAU(ND-1)

          XM(ND)=XM(ND)+0.1_LDP*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)
          XM(ND)=XM(ND)+0.1D0*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	     IF(XM(I) .LE. 0.0_LDP)THEN
	     IF(XM(I) .LE. 0.0D0)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	  T1=(XM(I)+XM(I+1))/2.0_LDP
	  T1=(XM(I)+XM(I+1))/2.0D0

	    RSQHNU(I)=0.99_LDP*T1
	    RSQHNU(I)=0.99D0*T1

	    RSQHNU(I)=-0.99_LDP*T1
	    RSQHNU(I)=-0.99D0*T1


mom_j_ddt_v4.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0_LDP
	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    CON_GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS
	    CON_GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(:)=0.0_LDP
	  COH_VEC(:)=0.0D0

	IF(DTAU(ND-1) .LT. 1.0E-05_LDP)DTAU(ND-1)=1.0E-05_LDP
	IF(DTAU(ND-1) .LT. 1.0D-05)DTAU(ND-1)=1.0D-05

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    dH(I)=0.0_LDP
	    dH(I)=0.0D0

	    dH_OLDT(I)=0.0_LDP
	    dH_OLDT(I)=0.0D0

	    DJDt(I)=0.0_LDP
	    DJDt(I)=0.0D0

	  HONJ_OUTBC_PREV=0.0_LDP;  RSQH_AT_IB_PREV=0.0_LDP; RSQH_AT_OB_PREV=0.0_LDP
	  HONJ_OUTBC_PREV=0.0D0;  RSQH_AT_IB_PREV=0.0D0; RSQH_AT_OB_PREV=0.0D0

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  HU(I)=F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=GAMH(I)/(1.0_LDP+W(I))
	  HS(I)=GAMH(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)
	  TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	IF(INIT)DJDt(1)=0.0_LDP
	IF(INIT)DJDt(1)=0.0D0

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0_LDP+GAM(1)+DJDT(1))
	  TB(1)=FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0D0+GAM(1)+DJDT(1))

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	DJDt(ND)=0.0_LDP
	DJDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  XM(ND)=XM(ND)+0.10_LDP*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.10D0*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=TB(ND)+0.10_LDP*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.10D0*F(ND)/DTAU(ND-1)

	  TB(ND)=FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+DjdT(ND)+GAM(ND))
	  TB(ND)=FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+DjdT(ND)+GAM(ND))

	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0_LDP-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )
	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0D0-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )

          TB(ND)=TB(ND)+0.1_LDP*FMIN/DTAU(ND-1)
          TB(ND)=TB(ND)+0.1D0*FMIN/DTAU(ND-1)

          XM(ND)=XM(ND)+0.1_LDP*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)
          XM(ND)=XM(ND)+0.1D0*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	     IF(XM(I) .LE. 0.0_LDP)THEN
	     IF(XM(I) .LE. 0.0D0)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	    T1=(XM(I)+XM(I+1))/2.0_LDP
	    T1=(XM(I)+XM(I+1))/2.0D0

	      RSQHNU(I)=0.99_LDP*T1
	      RSQHNU(I)=0.99D0*T1

	      RSQHNU(I)=-0.99_LDP*T1
	      RSQHNU(I)=-0.99D0*T1

	      RSQHNU(I)=0.99_LDP*T1
	      RSQHNU(I)=0.99D0*T1

	      RSQHNU(I)=-0.99_LDP*T1
	      RSQHNU(I)=-0.99D0*T1


mom_j_ddt_v5.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0_LDP
	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    CON_GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS
	    CON_GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(:)=0.0_LDP
	  COH_VEC(:)=0.0D0

	IF(DTAU(ND-1) .LT. 1.0E-05_LDP)DTAU(ND-1)=1.0E-05_LDP
	IF(DTAU(ND-1) .LT. 1.0D-05)DTAU(ND-1)=1.0D-05

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    dH(I)=0.0_LDP
	    dH(I)=0.0D0

	    dH_OLDT(I)=0.0_LDP
	    dH_OLDT(I)=0.0D0

	    DJDt(I)=0.0_LDP
	    DJDt(I)=0.0D0

	  HONJ_OUTBC_PREV=0.0_LDP;  RSQH_AT_IB_PREV=0.0_LDP; RSQH_AT_OB_PREV=0.0_LDP
	  HONJ_OUTBC_PREV=0.0D0;  RSQH_AT_IB_PREV=0.0D0; RSQH_AT_OB_PREV=0.0D0

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  HU(I)=F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=GAMH(I)/(1.0_LDP+W(I))
	  HS(I)=GAMH(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)
	  TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)

	  T1=1.0_LDP
	  T1=1.0D0

	  DO WHILE(XM(I) .LT. 0.0_LDP .AND. ICNT .LT. 3)
	  DO WHILE(XM(I) .LT. 0.0D0 .AND. ICNT .LT. 3)

	    T1=0.5_LDP*T1
	    T1=0.5D0*T1

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	IF(INIT)DJDt(1)=0.0_LDP
	IF(INIT)DJDt(1)=0.0D0

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  TB(1)=TB(1)+0.1_LDP*F(1)*Q(1)/DTAU(1)
	  TB(1)=TB(1)+0.1D0*F(1)*Q(1)/DTAU(1)

	  XM(1)=XM(1)+0.1_LDP*F(1)*Q(1)*(JPLUS_OB+JMIN_OB)/DTAU(1)
	  XM(1)=XM(1)+0.1D0*F(1)*Q(1)*(JPLUS_OB+JMIN_OB)/DTAU(1)

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0_LDP+GAM(1)+DJDT(1))
	  TB(1)=FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0D0+GAM(1)+DJDT(1))

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	DJDt(ND)=0.0_LDP
	DJDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  XM(ND)=XM(ND)+0.10_LDP*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.10D0*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=TB(ND)+0.10_LDP*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.10D0*F(ND)/DTAU(ND-1)

	  TB(ND)=FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+DjdT(ND)+GAM(ND))
	  TB(ND)=FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+DjdT(ND)+GAM(ND))

	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0_LDP-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )
	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0D0-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )

          TB(ND)=TB(ND)+0.1_LDP*FMIN/DTAU(ND-1)
          TB(ND)=TB(ND)+0.1D0*FMIN/DTAU(ND-1)

          XM(ND)=XM(ND)+0.1_LDP*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)
          XM(ND)=XM(ND)+0.1D0*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	     IF(XM(I) .LE. 0.0_LDP)THEN
	     IF(XM(I) .LE. 0.0D0)THEN

	  IF(XM(I) .LE. 0.0_LDP)THEN
	  IF(XM(I) .LE. 0.0D0)THEN

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    T1=(XM(I)+XM(I+1))/2.0_LDP
	    T1=(XM(I)+XM(I+1))/2.0D0

	      RSQHNU(I)=0.99_LDP*T1
	      RSQHNU(I)=0.99D0*T1

	      RSQHNU(I)=-0.99_LDP*T1
	      RSQHNU(I)=-0.99D0*T1


mom_j_ddt_v6.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU(ND) )             ; RSQJNU(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU(ND) )             ; RSQHNU(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_PREV(ND) )        ; RSQJNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_PREV(ND) )        ; RSQHNU_PREV(1:ND)=0.0D0

	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQJNU_OLDt(ND) )        ; RSQJNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0_LDP
	  ALLOCATE ( RSQHNU_OLDt(ND) )        ; RSQHNU_OLDt(1:ND)=0.0D0

	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0_LDP
	  ALLOCATE ( F_SAV(ND) )              ; F_SAV(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	  C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    CON_GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS
	    CON_GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/C_KMS

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(:)=0.0_LDP
	  COH_VEC(:)=0.0D0

	IF(DTAU(ND-1) .LT. 1.0E-05_LDP)DTAU(ND-1)=1.0E-05_LDP
	IF(DTAU(ND-1) .LT. 1.0D-05)DTAU(ND-1)=1.0D-05

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    RSQJNU_PREV(I)=0.0_LDP
	    RSQJNU_PREV(I)=0.0D0

	    RSQHNU_PREV(I)=0.0_LDP
	    RSQHNU_PREV(I)=0.0D0

	    dH(I)=0.0_LDP
	    dH(I)=0.0D0

	    dH_OLDT(I)=0.0_LDP
	    dH_OLDT(I)=0.0D0

	    DJDt(I)=0.0_LDP
	    DJDt(I)=0.0D0

	  HONJ_OUTBC_PREV=0.0_LDP;  RSQH_AT_IB_PREV=0.0_LDP; RSQH_AT_OB_PREV=0.0_LDP
	  HONJ_OUTBC_PREV=0.0D0;  RSQH_AT_IB_PREV=0.0D0; RSQH_AT_OB_PREV=0.0D0

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  DTAUONQ(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU(I)+DTAU(I-1))/Q(I)

	  HU(I)=F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=GAMH(I)/(1.0_LDP+W(I))
	  HS(I)=GAMH(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)
	  TB(I)=DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDt(I) + HL(I) + HU(I-1)

	    T1=1.0_LDP
	    T1=1.0D0

	    DO WHILE(XM(I) .LT. 0.0_LDP .AND. ICNT .LT. 5)
	    DO WHILE(XM(I) .LT. 0.0D0 .AND. ICNT .LT. 5)

	      T1=0.5_LDP*T1
	      T1=0.5D0*T1

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	IF(INIT)DJDt(1)=0.0_LDP
	IF(INIT)DJDt(1)=0.0D0

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0_LDP+GAM(1)+DJDt(1))
	  TB(1)=F(1)*Q(1)/DTAU(1) + HONJ_OUTBC*(1.0D0+GAM(1)+DJDt(1))

	  TB(1)=TB(1)+0.1_LDP*F(1)*Q(1)/DTAU(1)
	  TB(1)=TB(1)+0.1D0*F(1)*Q(1)/DTAU(1)

	  XM(1)=XM(1)+0.1_LDP*F(1)*Q(1)*(JPLUS_OB+JMIN_OB)/DTAU(1)
	  XM(1)=XM(1)+0.1D0*F(1)*Q(1)*(JPLUS_OB+JMIN_OB)/DTAU(1)

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0_LDP+GAM(1)+DJDT(1))
	  TB(1)=FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS*(1.0D0+GAM(1)+DJDT(1))

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	DJDt(ND)=0.0_LDP
	DJDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  XM(ND)=XM(ND)+0.10_LDP*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.10D0*F(ND)*R(ND)*R(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=TB(ND)+0.10_LDP*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.10D0*F(ND)/DTAU(ND-1)

	  TB(ND)=FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+DjdT(ND)+GAM(ND))
	  TB(ND)=FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+DjdT(ND)+GAM(ND))

	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0_LDP-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )
	  XM(ND)=T1*( HPLUS_IB-FPLUS*JPLUS_IB/DTAU(ND-1)-(1.0D0-FPLUS)/R(ND)/CHI(ND)*JPLUS_IB )

          TB(ND)=TB(ND)+0.1_LDP*FMIN/DTAU(ND-1)
          TB(ND)=TB(ND)+0.1D0*FMIN/DTAU(ND-1)

          XM(ND)=XM(ND)+0.1_LDP*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)
          XM(ND)=XM(ND)+0.1D0*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU(ND-1)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	     IF(XM(I) .LE. 0.0_LDP)THEN
	     IF(XM(I) .LE. 0.0D0)THEN

	  IF(XM(I) .LE. 0.0_LDP)THEN
	  IF(XM(I) .LE. 0.0D0)THEN

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    T1=(XM(I)+XM(I+1))/2.0_LDP
	    T1=(XM(I)+XM(I+1))/2.0D0

	      RSQHNU(I)=0.99_LDP*T1
	      RSQHNU(I)=0.99D0*T1

	      RSQHNU(I)=-0.99_LDP*T1
	      RSQHNU(I)=-0.99D0*T1


mom_j_pp_v1.f

	  ALLOCATE ( JNU(ND) )             ; JNU(1:ND)=0.0_LDP
	  ALLOCATE ( JNU(ND) )             ; JNU(1:ND)=0.0D0

	  ALLOCATE ( HNU(ND) )             ; HNU(1:ND)=0.0_LDP
	  ALLOCATE ( HNU(ND) )             ; HNU(1:ND)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	  MID_DTAU(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))
	  MID_DTAU(I)=0.5D0*(DTAU(I)+DTAU(I-1))

	  DD(I)=-MID_DTAU(I)*(1.0_LDP-COH_VEC(I)) - (F(I)-F(I-1))/DTAU(I-1) -
	  DD(I)=-MID_DTAU(I)*(1.0D0-COH_VEC(I)) - (F(I)-F(I-1))/DTAU(I-1) -

	DD(1)=(F(2)-F(1))/DTAU(1) -0.5_LDP*DTAU(1)*(1.0_LDP-COH_VEC(1)) -
	DD(1)=(F(2)-F(1))/DTAU(1) -0.5D0*DTAU(1)*(1.0D0-COH_VEC(1)) -

	XM(1)=0.5_LDP*DTAU(1)*SOURCE(1)+HBC_S*SOURCE(1)
	XM(1)=0.5D0*DTAU(1)*SOURCE(1)+HBC_S*SOURCE(1)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5_LDP*DTAU(ND-1)*(1.0_LDP-COH_VEC(ND))
	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5D0*DTAU(ND-1)*(1.0D0-COH_VEC(ND))

	  XM(ND)=DBB/3.0_LDP/CHI(ND)+0.5_LDP*DTAU(ND-1)*SOURCE(ND)
	  XM(ND)=DBB/3.0D0/CHI(ND)+0.5D0*DTAU(ND-1)*SOURCE(ND)

	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5_LDP*DTAU(ND-1)*(1.0_LDP-COH_VEC(ND))-IN_HBC
	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5D0*DTAU(ND-1)*(1.0D0-COH_VEC(ND))-IN_HBC

	  XM(ND)=IC*(0.25_LDP+0.5_LDP*IN_HBC)+0.5_LDP*DTAU(ND-1)*SOURCE(ND)
	  XM(ND)=IC*(0.25D0+0.5D0*IN_HBC)+0.5D0*DTAU(ND-1)*SOURCE(ND)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0


mom_jrel_grey_v1.f

	DAMP_FAC=0.1_LDP
	DAMP_FAC=0.1D0

	MAX_ER_LST_IT=1.0E+10_LDP
	MAX_ER_LST_IT=1.0D+10

	BETA(1:ND)=V(1:ND)/2.99794E+05_LDP
	BETA(1:ND)=V(1:ND)/2.99794D+05

	GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	IF(.NOT. INCL_ADVEC_TERMS)H_ADV_FAC(1:ND)=0.0_LDP
	IF(.NOT. INCL_ADVEC_TERMS)H_ADV_FAC(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	JOLD(:)=0.0_LDP
	JOLD(:)=0.0D0

	  CHI_H(I)=( CHI(I)/GAM_REL(I)+2.0_LDP*CON_DELTA(I)*(
	  CHI_H(I)=( CHI(I)/GAM_REL(I)+2.0D0*CON_DELTA(I)*(

	1       1.0_LDP+GAM_REL_SQ(I)*(SIGMA(I)+1) )  )/GAM_REL(I)
	1       1.0D0+GAM_REL_SQ(I)*(SIGMA(I)+1) )  )/GAM_REL(I)

	  P_H(I)=1.0_LDP
	  P_H(I)=1.0D0

	1       3.0_LDP-F(I)+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I))*
	1       3.0D0-F(I)+GAM_REL_SQ(I)*(1.0D0+SIGMA(I))*

	1                       (1.0_LDP+F(I)) )
	1                       (1.0D0+F(I)) )

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*F(I)-1.0_LDP-H_ADV_FAC(I)*(SIGMA(I)+1.0_LDP)+
	  TA(ND-I+1)=( 3.0D0*F(I)-1.0D0-H_ADV_FAC(I)*(SIGMA(I)+1.0D0)+

	1      GAM_REL_SQ(I)*BETA(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1              (1.0_LDP-H_ADV_FAC(I)) )/(F(I)+H_ADV_FAC(I))/R(I)
	1              (1.0D0-H_ADV_FAC(I)) )/(F(I)+H_ADV_FAC(I))/R(I)

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	    P_J(1:ND)=1.0_LDP+CON_DELTA(1:ND)*
	    P_J(1:ND)=1.0D0+CON_DELTA(1:ND)*

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	  XM(1)=0.0_LDP
	  XM(1)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	    XM(ND)=GAM_REL_SQ(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL_SQ(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)*GAM_REL_SQ(ND)
	    XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)*GAM_REL_SQ(ND)

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    RSQHNU(I)=(HU(I)*XM(I+1)-HL(I)*XM(I))*(1.0_LDP-T1*T1)
	    RSQHNU(I)=(HU(I)*XM(I+1)-HL(I)*XM(I))*(1.0D0-T1*T1)

	  RSQHNU(ND)=0.0_LDP
	  RSQHNU(ND)=0.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-06_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-06)ACCURATE=.TRUE.

	    dlnJdlnR(1:ND)=(1.0_LDP-DAMP_FAC)*dlnJdlnR(1:ND)+DAMP_FAC*TB(1:ND)
	    dlnJdlnR(1:ND)=(1.0D0-DAMP_FAC)*dlnJdlnR(1:ND)+DAMP_FAC*TB(1:ND)

	T2=GAM_REL_SQ(ND)*DBB/3.0_LDP/CHI(ND)
	T2=GAM_REL_SQ(ND)*DBB/3.0D0/CHI(ND)

	  TA(I)=CON_DELTA(I)*( XM(I)*(1.0_LDP-F(I)) +
	  TA(I)=CON_DELTA(I)*( XM(I)*(1.0D0-F(I)) +

	1           GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP)*(F(I)*XM(I)+BETA(I)*TB(I))
	1           GAM_REL_SQ(I)*(SIGMA(I)+1.0D0)*(F(I)*XM(I)+BETA(I)*TB(I))

	Q(1:ND)=0.0_LDP
	Q(1:ND)=0.0D0

	  T1=4.1274E-12_LDP*( TB(1)/GAM_REL(1) + GAM_REL(1)*BETA(1)*XM(1)*(1.0_LDP+F(1)) )
	  T1=4.1274D-12*( TB(1)/GAM_REL(1) + GAM_REL(1)*BETA(1)*XM(1)*(1.0D0+F(1)) )

	  T1=4.1274E-12_LDP*TB(1)/GAM_REL(1)
	  T1=4.1274D-12*TB(1)/GAM_REL(1)


mom_jrel_grey_v2.f

	DAMP_FAC=0.1_LDP
	DAMP_FAC=0.1D0

	MAX_ER_LST_IT=1.0E+10_LDP
	MAX_ER_LST_IT=1.0D+10

	BETA(1:ND)=V(1:ND)/2.99794E+05_LDP
	BETA(1:ND)=V(1:ND)/2.99794D+05

	GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	IF(.NOT. INCL_ADVEC_TERMS)H_ADV_FAC(1:ND)=0.0_LDP
	IF(.NOT. INCL_ADVEC_TERMS)H_ADV_FAC(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	JOLD(:)=0.0_LDP
	JOLD(:)=0.0D0

	  CHI_H(I)=( CHI(I)/GAM_REL(I)+2.0_LDP*CON_DELTA(I)*(
	  CHI_H(I)=( CHI(I)/GAM_REL(I)+2.0D0*CON_DELTA(I)*(

	1       1.0_LDP+GAM_REL_SQ(I)*(SIGMA(I)+1) )  )/GAM_REL(I)
	1       1.0D0+GAM_REL_SQ(I)*(SIGMA(I)+1) )  )/GAM_REL(I)

	  P_H(I)=1.0_LDP
	  P_H(I)=1.0D0

	1       3.0_LDP-F(I)+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I))*
	1       3.0D0-F(I)+GAM_REL_SQ(I)*(1.0D0+SIGMA(I))*

	1                       (1.0_LDP+F(I)) )
	1                       (1.0D0+F(I)) )

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*F(I)-1.0_LDP-H_ADV_FAC(I)*(SIGMA(I)+1.0_LDP)+
	  TA(ND-I+1)=( 3.0D0*F(I)-1.0D0-H_ADV_FAC(I)*(SIGMA(I)+1.0D0)+

	1      GAM_REL_SQ(I)*BETA(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1              (1.0_LDP-H_ADV_FAC(I)) )/(F(I)+H_ADV_FAC(I))/R(I)
	1              (1.0D0-H_ADV_FAC(I)) )/(F(I)+H_ADV_FAC(I))/R(I)

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	    P_J(1:ND)=1.0_LDP+CON_DELTA(1:ND)*
	    P_J(1:ND)=1.0D0+CON_DELTA(1:ND)*

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	  XM(1)=0.0_LDP
	  XM(1)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	    XM(ND)=GAM_REL_SQ(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL_SQ(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)*GAM_REL_SQ(ND)
	    XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)*GAM_REL_SQ(ND)

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    RSQHNU(I)=(HU(I)*XM(I+1)-HL(I)*XM(I))*(1.0_LDP-T1*T1)
	    RSQHNU(I)=(HU(I)*XM(I+1)-HL(I)*XM(I))*(1.0D0-T1*T1)

	  RSQHNU(ND)=0.0_LDP
	  RSQHNU(ND)=0.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-06_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-06)ACCURATE=.TRUE.

	    DAMP_FAC=0.2_LDP
	    DAMP_FAC=0.2D0

	    dlnJdlnR(1:ND)=(1.0_LDP-DAMP_FAC)*dlnJdlnR(1:ND)+DAMP_FAC*TB(1:ND)
	    dlnJdlnR(1:ND)=(1.0D0-DAMP_FAC)*dlnJdlnR(1:ND)+DAMP_FAC*TB(1:ND)

	T2=GAM_REL_SQ(ND)*DBB/3.0_LDP/CHI(ND)
	T2=GAM_REL_SQ(ND)*DBB/3.0D0/CHI(ND)

	  TA(I)=CON_DELTA(I)*( XM(I)*(1.0_LDP-F(I)) +
	  TA(I)=CON_DELTA(I)*( XM(I)*(1.0D0-F(I)) +

	1           GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP)*(F(I)*XM(I)+BETA(I)*TB(I))
	1           GAM_REL_SQ(I)*(SIGMA(I)+1.0D0)*(F(I)*XM(I)+BETA(I)*TB(I))

	Q(1:ND)=0.0_LDP
	Q(1:ND)=0.0D0

	  T1=4.1274E-12_LDP*( TB(1)/GAM_REL(1) + GAM_REL(1)*BETA(1)*XM(1)*(1.0_LDP+F(1)) )
	  T1=4.1274D-12*( TB(1)/GAM_REL(1) + GAM_REL(1)*BETA(1)*XM(1)*(1.0D0+F(1)) )

	  T1=4.1274E-12_LDP*TB(1)/GAM_REL(1)
	  T1=4.1274D-12*TB(1)/GAM_REL(1)


mom_j_rel_v2.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        FEDD_SAVE(:)=0.0_LDP
        FEDD_SAVE(:)=0.0D0

        GEDD_SAVE(:)=0.0_LDP
        GEDD_SAVE(:)=0.0D0

        H_ON_J_SAVE(:)=0.0_LDP
        H_ON_J_SAVE(:)=0.0D0

        N_ON_J_SAVE(:)=0.0_LDP
        N_ON_J_SAVE(:)=0.0D0

        RSQN_ON_RSQJ_SAVE(:)=0.0_LDP
        RSQN_ON_RSQJ_SAVE(:)=0.0D0

        KMID_ON_J_SAVE(:)=0.0_LDP
        KMID_ON_J_SAVE(:)=0.0D0

        JNU_SAVE(:)=0.0_LDP
        JNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	HBC_SAVE=0.0_LDP
	HBC_SAVE=0.0D0

	NBC_SAVE=0.0_LDP
	NBC_SAVE=0.0D0

	IN_HBC_SAVE=0.0_LDP
	IN_HBC_SAVE=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  JNU_PREV(:)=0.0_LDP
	  JNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  FEDD_PREV(:)=0.0_LDP
	  FEDD_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  GEDD_PREV(:)=0.0_LDP
	  GEDD_PREV(:)=0.0D0

	  RSQN_ON_RSQJ_PREV(:)=0.0_LDP
	  RSQN_ON_RSQJ_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)/2.99794E+05_LDP
	  BETA_FREQ(1:ND)=V(1:ND)/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	  GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          RSQN_ON_RSQJ(1:ND)=0.0_LDP
          RSQN_ON_RSQJ(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*FEDD(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*FEDD(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*FEDD_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*FEDD_PREV(I)+

	IF(INIT)dlnJdlnR(1:ND)=0.0_LDP
	IF(INIT)dlnJdlnR(1:ND)=0.0D0

	JOLD(1:ND)=0.0_LDP
	JOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	  XM(1)=0.0_LDP
	  XM(1)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=GAM_REL(ND)*R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	    XM(ND)=GAM_REL(ND)*R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnJdlnR(1:ND)
	        dlnJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnJdlnR(1:ND)

	        dlnJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnJdlnR(1:ND)
	        dlnJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnJdlnR(1:ND)


mom_jrel_v3.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        FEDD_SAVE(:)=0.0_LDP
        FEDD_SAVE(:)=0.0D0

        GEDD_SAVE(:)=0.0_LDP
        GEDD_SAVE(:)=0.0D0

        H_ON_J_SAVE(:)=0.0_LDP
        H_ON_J_SAVE(:)=0.0D0

        N_ON_J_SAVE(:)=0.0_LDP
        N_ON_J_SAVE(:)=0.0D0

        RSQN_ON_RSQJ_SAVE(:)=0.0_LDP
        RSQN_ON_RSQJ_SAVE(:)=0.0D0

        KMID_ON_J_SAVE(:)=0.0_LDP
        KMID_ON_J_SAVE(:)=0.0D0

        JNU_SAVE(:)=0.0_LDP
        JNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	HBC_SAVE=0.0_LDP
	HBC_SAVE=0.0D0

	NBC_SAVE=0.0_LDP
	NBC_SAVE=0.0D0

	IN_HBC_SAVE=0.0_LDP
	IN_HBC_SAVE=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  JNU_PREV(:)=0.0_LDP
	  JNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  FEDD_PREV(:)=0.0_LDP
	  FEDD_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  GEDD_PREV(:)=0.0_LDP
	  GEDD_PREV(:)=0.0D0

	  RSQN_ON_RSQJ_PREV(:)=0.0_LDP
	  RSQN_ON_RSQJ_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	  GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          RSQN_ON_RSQJ(1:ND)=0.0_LDP
          RSQN_ON_RSQJ(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*FEDD(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*FEDD(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*FEDD_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*FEDD_PREV(I)+

	IF(INIT)dlnJdlnR(1:ND)=0.0_LDP
	IF(INIT)dlnJdlnR(1:ND)=0.0D0

	JOLD(1:ND)=0.0_LDP
	JOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	  XM(1)=0.0_LDP
	  XM(1)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	    TA(ND)=0.0_LDP; TC(ND)=0.0_LDP
	    TA(ND)=0.0D0; TC(ND)=0.0D0

	    TB(ND)=1.0_LDP
	    TB(ND)=1.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=GAM_REL(ND)*R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	    XM(ND)=GAM_REL(ND)*R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

        IF(ABS(FREQ-49.8654_LDP) .LT. 0.001_LDP)THEN
        IF(ABS(FREQ-49.8654D0) .LT. 0.001)THEN

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnJdlnR(1:ND)
	        dlnJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnJdlnR(1:ND)

	        dlnJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnJdlnR(1:ND)
	        dlnJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(I)+BETA(I+1))
	  T1=0.5D0*(BETA(I)+BETA(I+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


mom_jrel_v4.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        FEDD_SAVE(:)=0.0_LDP
        FEDD_SAVE(:)=0.0D0

        GEDD_SAVE(:)=0.0_LDP
        GEDD_SAVE(:)=0.0D0

        H_ON_J_SAVE(:)=0.0_LDP
        H_ON_J_SAVE(:)=0.0D0

        N_ON_J_SAVE(:)=0.0_LDP
        N_ON_J_SAVE(:)=0.0D0

        RSQN_ON_RSQJ_SAVE(:)=0.0_LDP
        RSQN_ON_RSQJ_SAVE(:)=0.0D0

        KMID_ON_J_SAVE(:)=0.0_LDP
        KMID_ON_J_SAVE(:)=0.0D0

        JNU_SAVE(:)=0.0_LDP
        JNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	HBC_SAVE=0.0_LDP
	HBC_SAVE=0.0D0

	NBC_SAVE=0.0_LDP
	NBC_SAVE=0.0D0

	IN_HBC_SAVE=0.0_LDP
	IN_HBC_SAVE=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  JNU_PREV(:)=0.0_LDP
	  JNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  FEDD_PREV(:)=0.0_LDP
	  FEDD_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  GEDD_PREV(:)=0.0_LDP
	  GEDD_PREV(:)=0.0D0

	  RSQN_ON_RSQJ_PREV(:)=0.0_LDP
	  RSQN_ON_RSQJ_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	  GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          RSQN_ON_RSQJ(1:ND)=0.0_LDP
          RSQN_ON_RSQJ(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*FEDD(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*FEDD(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*FEDD_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*FEDD_PREV(I)+

	IF(INIT)dlnJdlnR(1:ND)=0.0_LDP
	IF(INIT)dlnJdlnR(1:ND)=0.0D0

	JOLD(1:ND)=0.0_LDP
	JOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	  XM(1)=0.0_LDP
	  XM(1)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	    TA(ND)=0.0_LDP; TC(ND)=0.0_LDP
	    TA(ND)=0.0D0; TC(ND)=0.0D0

	    TB(ND)=1.0_LDP
	    TB(ND)=1.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=GAM_REL(ND)*R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	    XM(ND)=GAM_REL(ND)*R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

        IF(ABS(FREQ-49.8654_LDP) .LT. 0.001_LDP)THEN
        IF(ABS(FREQ-49.8654D0) .LT. 0.001)THEN

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnJdlnR(1:ND)
	        dlnJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnJdlnR(1:ND)

	        dlnJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnJdlnR(1:ND)
	        dlnJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(I)+BETA(I+1))
	  T1=0.5D0*(BETA(I)+BETA(I+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


mom_jrel_v5.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        GAM_RSQJNU_SAVE(:)=0.0_LDP
        GAM_RSQJNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  GAM_RSQJNU_PREV(:)=0.0_LDP
	  GAM_RSQJNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL_STORE(1:ND_STORE)=1.0_LDP
	    GAM_REL_STORE(1:ND_STORE)=1.0D0

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	  dlnGRSQJdlnR(1:ND)=0.0_LDP
	  dlnGRSQJdlnR(1:ND)=0.0D0

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	GAM_RSQJNU(:)=0.0_LDP
	GAM_RSQJNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	GAM_RSQJOLD(1:ND)=0.0_LDP
	GAM_RSQJOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	  XM(1)=0.0_LDP
	  XM(1)=0.0D0

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	    TA(ND)=0.0_LDP; TC(ND)=0.0_LDP
	    TA(ND)=0.0D0; TC(ND)=0.0D0

	    TB(ND)=1.0_LDP
	    TB(ND)=1.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)/CHI_H(ND)/R(ND)/dLOG_NU
	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)/CHI_H(ND)/R(ND)/dLOG_NU

	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)-1.0_LDP
	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)-1.0D0

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

        IF(ABS(FREQ-49.8654_LDP) .LT. 0.001_LDP)THEN
        IF(ABS(FREQ-49.8654D0) .LT. 0.001)THEN

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnGRSQJdlnR(1:ND)

	        dlnGRSQJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnGRSQJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(K)+BETA(K+1))
	  T1=0.5D0*(BETA(K)+BETA(K+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


mom_jrel_v6.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        GAM_RSQJNU_SAVE(:)=0.0_LDP
        GAM_RSQJNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  GAM_RSQJNU_PREV(:)=0.0_LDP
	  GAM_RSQJNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL_STORE(1:ND_STORE)=1.0_LDP
	    GAM_REL_STORE(1:ND_STORE)=1.0D0

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	  dlnGRSQJdlnR(1:ND)=0.0_LDP
	  dlnGRSQJdlnR(1:ND)=0.0D0

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	GAM_RSQJNU(:)=0.0_LDP
	GAM_RSQJNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	  IF(TA(I) .LT. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I))
	  IF(TA(I) .LT. 0.0D0)TA(I)=0.1D0*ABS(TA(I))

	  IF(TA(I) .EQ. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I-1))
	  IF(TA(I) .EQ. 0.0D0)TA(I)=0.1D0*ABS(TA(I-1))

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	GAM_RSQJOLD(1:ND)=0.0_LDP
	GAM_RSQJOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    VB(1)=0.0_LDP
	    VB(1)=0.0D0

	    VC(1)=0.0_LDP
	    VC(1)=0.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=0.0_LDP
	    XM(ND)=0.0D0

	    DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	    DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1)
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1)

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=TB(ND)+0.1_LDP*FMIN/DTAU
	      TB(ND)=TB(ND)+0.1D0*FMIN/DTAU

	      XM(ND)=XM(ND)+0.1_LDP*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU
	      XM(ND)=XM(ND)+0.1D0*FMIN*R(ND)*R(ND)*JMIN_IB/DTAU

	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)/CHI_H(ND)/R(ND)/dLOG_NU
	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)/CHI_H(ND)/R(ND)/dLOG_NU

	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)-1.0_LDP
	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)-1.0D0

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  IN_HBC_SAVE=0.0_LDP
	  IN_HBC_SAVE=0.0D0

	  IN_NBC_SAVE=0.0_LDP
	  IN_NBC_SAVE=0.0D0

	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0_LDP/CHI(ND)
	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0D0/CHI(ND)

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnGRSQJdlnR(1:ND)

	        dlnGRSQJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnGRSQJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(K)+BETA(K+1))
	  T1=0.5D0*(BETA(K)+BETA(K+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


mom_jrel_v7.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        GAM_RSQJNU_SAVE(:)=0.0_LDP
        GAM_RSQJNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  GAM_RSQJNU_PREV(:)=0.0_LDP
	  GAM_RSQJNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL_STORE(1:ND_STORE)=1.0_LDP
	    GAM_REL_STORE(1:ND_STORE)=1.0D0

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	  dlnGRSQJdlnR(1:ND)=0.0_LDP
	  dlnGRSQJdlnR(1:ND)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	GAM_RSQJNU(:)=0.0_LDP
	GAM_RSQJNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	  IF(TA(I) .LT. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I))
	  IF(TA(I) .LT. 0.0D0)TA(I)=0.1D0*ABS(TA(I))

	  IF(TA(I) .EQ. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I-1))
	  IF(TA(I) .EQ. 0.0D0)TA(I)=0.1D0*ABS(TA(I-1))

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	GAM_RSQJOLD(1:ND)=0.0_LDP
	GAM_RSQJOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    VB(1)=0.0_LDP
	    VB(1)=0.0D0

	    VC(1)=0.0_LDP
	    VC(1)=0.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=0.0_LDP
	    XM(ND)=0.0D0

	    TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	    TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	    DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	    DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1)
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1)

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	      TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)/CHI_H(ND)/R(ND)/dLOG_NU
	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)/CHI_H(ND)/R(ND)/dLOG_NU

	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)-1.0_LDP
	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)-1.0D0

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  IN_HBC_SAVE=0.0_LDP
	  IN_HBC_SAVE=0.0D0

	  IN_NBC_SAVE=0.0_LDP
	  IN_NBC_SAVE=0.0D0

	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0_LDP/CHI(ND)
	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0D0/CHI(ND)

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    T1=(XM(I)+XM(I+1))/2.0_LDP
	    T1=(XM(I)+XM(I+1))/2.0D0

	       GAM_RSQHNU(I)=0.99_LDP*T1
	       GAM_RSQHNU(I)=0.99D0*T1

	       GAM_RSQHNU(I)=-0.99_LDP*T1
	       GAM_RSQHNU(I)=-0.99D0*T1

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnGRSQJdlnR(1:ND)

	        dlnGRSQJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnGRSQJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(K)+BETA(K+1))
	  T1=0.5D0*(BETA(K)+BETA(K+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


mom_jrel_v8.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        GAM_RSQJNU_SAVE(:)=0.0_LDP
        GAM_RSQJNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  GAM_RSQJNU_PREV(:)=0.0_LDP
	  GAM_RSQJNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL_STORE(1:ND_STORE)=1.0_LDP
	    GAM_REL_STORE(1:ND_STORE)=1.0D0

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	  dlnGRSQJdlnR(1:ND)=0.0_LDP
	  dlnGRSQJdlnR(1:ND)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	GAM_RSQJNU(:)=0.0_LDP
	GAM_RSQJNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	  IF(TA(I) .LT. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I))
	  IF(TA(I) .LT. 0.0D0)TA(I)=0.1D0*ABS(TA(I))

	  IF(TA(I) .EQ. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I-1))
	  IF(TA(I) .EQ. 0.0D0)TA(I)=0.1D0*ABS(TA(I-1))

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	GAM_RSQJOLD(1:ND)=0.0_LDP
	GAM_RSQJOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    VB(1)=0.0_LDP
	    VB(1)=0.0D0

	    VC(1)=0.0_LDP
	    VC(1)=0.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=0.0_LDP
	    XM(ND)=0.0D0

	    TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	    TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	    DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	    DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1)
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1)

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	      TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)/CHI_H(ND)/R(ND)/dLOG_NU
	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)/CHI_H(ND)/R(ND)/dLOG_NU

	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)-1.0_LDP
	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)-1.0D0

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  IN_HBC_SAVE=0.0_LDP
	  IN_HBC_SAVE=0.0D0

	  IN_NBC_SAVE=0.0_LDP
	  IN_NBC_SAVE=0.0D0

	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0_LDP/CHI(ND)
	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0D0/CHI(ND)

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	      T1=(XM(I)+XM(I+1))/2.0_LDP
	      T1=(XM(I)+XM(I+1))/2.0D0

	        GAM_RSQHNU(I)=0.9999_LDP*T1
	        GAM_RSQHNU(I)=0.9999D0*T1

	        GAM_RSQHNU(I)=-0.9999_LDP*T1
	        GAM_RSQHNU(I)=-0.9999D0*T1

	        GAM_RSQHNU(I)=0.9999_LDP*T1
	        GAM_RSQHNU(I)=0.9999D0*T1

	        GAM_RSQHNU(I)=-0.9999_LDP*T1
	        GAM_RSQHNU(I)=-0.9999D0*T1

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnGRSQJdlnR(1:ND)

	        dlnGRSQJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnGRSQJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(K)+BETA(K+1))
	  T1=0.5D0*(BETA(K)+BETA(K+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


mom_jrel_v9.f

	  FREQ_SAVE=0.0_LDP
	  FREQ_SAVE=0.0D0

        GAM_RSQJNU_SAVE(:)=0.0_LDP
        GAM_RSQJNU_SAVE(:)=0.0D0

        GAM_RSQHNU_SAVE(:)=0.0_LDP
        GAM_RSQHNU_SAVE(:)=0.0D0

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  W(:)=0.0_LDP
	  W(:)=0.0D0

	  WPREV(:)=0.0_LDP
	  WPREV(:)=0.0D0

	  PSI(:)=0.0_LDP
	  PSI(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  GAM_RSQJNU_PREV(:)=0.0_LDP
	  GAM_RSQJNU_PREV(:)=0.0D0

	  GAM_RSQHNU_PREV(:)=0.0_LDP
	  GAM_RSQHNU_PREV(:)=0.0D0

	  EPS(:)=0.0_LDP
	  EPS(:)=0.0D0

	  EPS_PREV(:)=0.0_LDP
	  EPS_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP                  !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06                  !/2.99794D+05

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL_STORE(1:ND_STORE)=1.0_LDP
	    GAM_REL_STORE(1:ND_STORE)=1.0D0

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	  dlnGRSQJdlnR(1:ND)=0.0_LDP
	  dlnGRSQJdlnR(1:ND)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  IF(NMID_ON_HMID(I) .GT. 1.0_LDP)NMID_ON_HMID(I)=1.0_LDP
	  IF(NMID_ON_HMID(I) .GT. 1.0D0)NMID_ON_HMID(I)=1.0D0

	GAM_RSQJNU(:)=0.0_LDP
	GAM_RSQJNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

	  COH_VEC(1:ND)=0.0_LDP
	  COH_VEC(1:ND)=0.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	  IF(TA(I) .LT. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I))
	  IF(TA(I) .LT. 0.0D0)TA(I)=0.1D0*ABS(TA(I))

	  IF(TA(I) .EQ. 0.0_LDP)TA(I)=0.1_LDP*ABS(TA(I-1))
	  IF(TA(I) .EQ. 0.0D0)TA(I)=0.1D0*ABS(TA(I-1))

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	  DTAUONQ(I)=0.5_LDP*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  DTAUONQ(I)=0.5D0*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	GAM_RSQJOLD(1:ND)=0.0_LDP
	GAM_RSQJOLD(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	    P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	    VdJdR_TERM(1:ND)=0.0_LDP
	    VdJdR_TERM(1:ND)=0.0D0

	    P_J(1:ND)=1.0_LDP
	    P_J(1:ND)=1.0D0

              T1=1.0_LDP
              T1=1.0D0

              DO WHILE(XM(I) .LT. 0.0_LDP .AND. ICNT .LT. 5)
              DO WHILE(XM(I) .LT. 0.0D0 .AND. ICNT .LT. 5)

	        T1=0.5_LDP*T1
	        T1=0.5D0*T1

	    TA(1)=0.0_LDP
	    TA(1)=0.0D0

	    VB(1)=0.0_LDP
	    VB(1)=0.0D0

	    VC(1)=0.0_LDP
	    VC(1)=0.0D0

	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	    XM(ND)=GAM_REL(ND)*DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	    XM(ND)=0.0_LDP
	    XM(ND)=0.0D0

	    TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	    TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	    DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	    DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1)
	      TB(ND)=FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1)

	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	      XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU- (1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	      TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	      TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)/CHI_H(ND)/R(ND)/dLOG_NU
	      T1=BETA(ND)*BETA(ND)*GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)/CHI_H(ND)/R(ND)/dLOG_NU

	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0_LDP)-1.0_LDP
	      T1=GAM_REL_SQ(ND)*(SIGMA(ND)+1.0D0)-1.0D0

	  TC(ND)=0.0_LDP
	  TC(ND)=0.0D0

	  VB(ND)=0.0_LDP
	  VB(ND)=0.0D0

	  VC(ND)=0.0_LDP
	  VC(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  IN_HBC_SAVE=0.0_LDP
	  IN_HBC_SAVE=0.0D0

	  IN_NBC_SAVE=0.0_LDP
	  IN_NBC_SAVE=0.0D0

	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  IN_HBC_SAVE=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0_LDP/CHI(ND)
	  IN_NBC_SAVE=DBB*R(ND)*R(ND)/5.0D0/CHI(ND)

	        XM(I)=ABS(XM(I))/10.0_LDP
	        XM(I)=ABS(XM(I))/10.0D0

	      T1=(XM(I)+XM(I+1))/2.0_LDP
	      T1=(XM(I)+XM(I+1))/2.0D0

	        GAM_RSQHNU(I)=0.9999_LDP*T1
	        GAM_RSQHNU(I)=0.9999D0*T1

	        GAM_RSQHNU(I)=-0.9999_LDP*T1
	        GAM_RSQHNU(I)=-0.9999D0*T1

	        GAM_RSQHNU(I)=0.9999_LDP*T1
	        GAM_RSQHNU(I)=0.9999D0*T1

	        GAM_RSQHNU(I)=-0.9999_LDP*T1
	        GAM_RSQHNU(I)=-0.9999D0*T1

	    MAX_ER=0.0_LDP
	    MAX_ER=0.0D0

	    IF(MAX_ER .LT. 1.0E-08_LDP)ACCURATE=.TRUE.
	    IF(MAX_ER .LT. 1.0D-08)ACCURATE=.TRUE.

	    DAMP_FAC=0.8_LDP
	    DAMP_FAC=0.8D0

	      IF(MAX_ER .LT. 0.01_LDP)THEN
	      IF(MAX_ER .LT. 0.01D0)THEN

	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0_LDP-DAMP_FAC)*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=DAMP_FAC*TB(1:ND)+(1.0D0-DAMP_FAC)*dlnGRSQJdlnR(1:ND)

	        dlnGRSQJdlnR(1:ND)=0.1_LDP*TB(1:ND)+0.9_LDP*dlnGRSQJdlnR(1:ND)
	        dlnGRSQJdlnR(1:ND)=0.1D0*TB(1:ND)+0.9D0*dlnGRSQJdlnR(1:ND)

	  T1=0.5_LDP*(BETA(K)+BETA(K+1))
	  T1=0.5D0*(BETA(K)+BETA(K+1))

	  T1=SQRT(1.0_LDP-T1*T1)
	  T1=SQRT(1.0D0-T1*T1)


n_weight.f

      temp(:)=0.0_LDP
      temp(:)=0.0d0

     *      angle(j+1)*angle(j+1)*angle(j+1))/8.0_LDP
     *      angle(j+1)*angle(j+1)*angle(j+1))/8.0d0

     *      angle(j+1)*angle(j+1)*angle(j+1)*angle(j+1))/10.0_LDP
     *      angle(j+1)*angle(j+1)*angle(j+1)*angle(j+1))/10.0d0

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**4-angle(nw)**4)/8.0_LDP
      check=(angle(1)**4-angle(nw)**4)/8.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then

      sum=0.0_LDP
      sum=0.0d0

      check=(angle(1)**5-angle(nw)**5)/10.0_LDP
      check=(angle(1)**5-angle(nw)**5)/10.0d0

      if(abs(check-sum).gt.1.0E-12_LDP)then
      if(abs(check-sum).gt.1.0d-12)then


optdepth_v2.f

	dchidz(1:nz)=0.0_LDP
	dchidz(1:nz)=0.0d0

        tau(1)=0.0_LDP
        tau(1)=0.0D0

          dtau(iz)=0.5_LDP*(ray(ip)%s_p(iz)-ray(ip)%s_p(iz+1))
          dtau(iz)=0.5d0*(ray(ip)%s_p(iz)-ray(ip)%s_p(iz+1))

     *         *(dchidz(iz+1)-dchidz(iz))/6.0_LDP )
     *         *(dchidz(iz+1)-dchidz(iz))/6.0d0 )

	dchidz(1:nz)=0.0_LDP
	dchidz(1:nz)=0.0d0

        tau(1)=0.0_LDP
        tau(1)=0.0D0

          dtau(iz)=0.5_LDP*(ray(ip)%s_m(iz+1)-ray(ip)%s_m(iz))
          dtau(iz)=0.5d0*(ray(ip)%s_m(iz+1)-ray(ip)%s_m(iz))

     *         *(dchidz(iz)-dchidz(iz+1))/6.0_LDP)
     *         *(dchidz(iz)-dchidz(iz+1))/6.0d0)


optdepth_v3.f

	dchidz(1:nz)=0.0_LDP
	dchidz(1:nz)=0.0d0

        tau_loc(1)=0.0_LDP
        tau_loc(1)=0.0D0

          dtau_loc(iz)=0.5_LDP*(ray(ip)%s_p(iz)-ray(ip)%s_p(iz+1))
          dtau_loc(iz)=0.5d0*(ray(ip)%s_p(iz)-ray(ip)%s_p(iz+1))

     *         *(dchidz(iz+1)-dchidz(iz))/6.0_LDP )
     *         *(dchidz(iz+1)-dchidz(iz))/6.0d0 )

	dchidz(1:nz)=0.0_LDP
	dchidz(1:nz)=0.0d0

        tau_loc(1)=0.0_LDP
        tau_loc(1)=0.0D0

          dtau_loc(iz)=0.5_LDP*(ray(ip)%s_m(iz+1)-ray(ip)%s_m(iz))
          dtau_loc(iz)=0.5d0*(ray(ip)%s_m(iz+1)-ray(ip)%s_m(iz))

     *         *(dchidz(iz)-dchidz(iz+1))/6.0_LDP)
     *         *(dchidz(iz)-dchidz(iz+1))/6.0d0)


optdepth_v4.f

	  DCHIDZ(1:NZ)=0.0_LDP
	  DCHIDZ(1:NZ)=0.0D0

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))

	    T1=( (RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))**2 )*(DCHIDZ(IZ+1)-DCHIDZ(IZ))/12.0_LDP
	    T1=( (RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))**2 )*(DCHIDZ(IZ+1)-DCHIDZ(IZ))/12.0D0

            IF(T1 .LT. 0.0_LDP)THEN
            IF(T1 .LT. 0.0D0)THEN

	      DTAU_LOC(IZ)=MAX(0.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MAX(0.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)

	      DTAU_LOC(IZ)=MIN(1.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MIN(1.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)

	  DCHIDZ(1:NZ)=0.0_LDP
	  DCHIDZ(1:NZ)=0.0D0

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))

     	    T1=((RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))**2)*(DCHIDZ(IZ)-DCHIDZ(IZ+1))/12.0_LDP
     	    T1=((RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))**2)*(DCHIDZ(IZ)-DCHIDZ(IZ+1))/12.0D0

            IF(T1 .LT. 0.0_LDP)THEN
            IF(T1 .LT. 0.0D0)THEN

	      DTAU_LOC(IZ)=MAX(0.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MAX(0.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)

	      DTAU_LOC(IZ)=MIN(1.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MIN(1.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)


optdepth_v4_gam.f

	  DCHIDZ(1:NZ)=0.0_LDP
	  DCHIDZ(1:NZ)=0.0D0

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))*(CHI(IZ)+CHI(IZ+1))

	    T1=( (RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))**2 )*(DCHIDZ(IZ+1)-DCHIDZ(IZ))/12.0_LDP
	    T1=( (RAY(IP)%S_P(IZ)-RAY(IP)%S_P(IZ+1))**2 )*(DCHIDZ(IZ+1)-DCHIDZ(IZ))/12.0D0

            IF(T1 .LT. 0.0_LDP)THEN
            IF(T1 .LT. 0.0D0)THEN

	      DTAU_LOC(IZ)=MAX(0.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MAX(0.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)

	      DTAU_LOC(IZ)=MIN(1.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MIN(1.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)

	  DCHIDZ(1:NZ)=0.0_LDP
	  DCHIDZ(1:NZ)=0.0D0

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))

            DTAU_LOC(IZ)=0.5_LDP*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))
            DTAU_LOC(IZ)=0.5D0*(RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))*(CHI(IZ+1)+CHI(IZ))

     	    T1=((RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))**2)*(DCHIDZ(IZ)-DCHIDZ(IZ+1))/12.0_LDP
     	    T1=((RAY(IP)%S_M(IZ+1)-RAY(IP)%S_M(IZ))**2)*(DCHIDZ(IZ)-DCHIDZ(IZ+1))/12.0D0

            IF(T1 .LT. 0.0_LDP)THEN
            IF(T1 .LT. 0.0D0)THEN

	      DTAU_LOC(IZ)=MAX(0.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MAX(0.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)

	      DTAU_LOC(IZ)=MIN(1.5_LDP*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)
	      DTAU_LOC(IZ)=MIN(1.5D0*DTAU_LOC(IZ),DTAU_LOC(IZ)+T1)


out_jh.f

	REAL(KIND=LDP),  SAVE :: NU_STORE=0.0_LDP
	REAL(KIND=LDP),  SAVE :: NU_STORE=0.0D0

	  NU_STORE=0.0_LDP
	  NU_STORE=0.0D0


pp_edd_var_cmf_v1.f

	VK(:,:,:)=0.0_LDP
	VK(:,:,:)=0.0D0

	RHS_dHdCHI(:,:)=0.0_LDP
	RHS_dHdCHI(:,:)=0.0D0

	Q(1:ND)=1.0_LDP
	Q(1:ND)=1.0D0

	  T1=(1.0_LDP+W(I))*(CHI(I)+CHI(I+1))
	  T1=(1.0D0+W(I))*(CHI(I)+CHI(I+1))

	  EPS_FAC(I)=-1.0_LDP/T1
	  EPS_FAC(I)=-1.0D0/T1

	  dTBdCHI=PSI(I)/(DTAU(J)+DTAU(I))+0.5_LDP*(1.0_LDP-ES_COH_VEC(I))
	  dTBdCHI=PSI(I)/(DTAU(J)+DTAU(I))+0.5D0*(1.0D0-ES_COH_VEC(I))

	  dRHSdJ(I)=  0.5_LDP*SOURCE(I)
	  dRHSdJ(I)=  0.5D0*SOURCE(I)

	  dRHSdI(I)= 0.5_LDP*SOURCE(I)
	  dRHSdI(I)= 0.5D0*SOURCE(I)

	  T1=0.5_LDP*(DTAU(J)+DTAU(I))/CHI(I)
	  T1=0.5D0*(DTAU(J)+DTAU(I))/CHI(I)

	  VK(ND,ND,1)=VK(ND,ND,1)-DBB/3.0_LDP/CHI(ND)/CHI(ND)
	  VK(ND,ND,1)=VK(ND,ND,1)-DBB/3.0D0/CHI(ND)/CHI(ND)


pp_form_cmf_v2.f

	DATA VDOP_FRAC_SAV/-1001.0_LDP/ 	!Absurd value.
	DATA VDOP_FRAC_SAV/-1001.0D0/ 	!Absurd value.

	DATA PREVIOUS_FREQ/0.0_LDP/
	DATA PREVIOUS_FREQ/0.0D0/

	REAL(KIND=LDP), PARAMETER :: ZERO=0.0_LDP
	REAL(KIND=LDP), PARAMETER :: ZERO=0.0D0

	REAL(KIND=LDP), PARAMETER :: ONE=1.0_LDP
	REAL(KIND=LDP), PARAMETER :: ONE=1.0D0

	    IF(V(ND) .LT. 10.0_LDP .AND. R(1)/R(ND) .GE. 9.99_LDP)THEN
	    IF(V(ND) .LT. 10.0D0 .AND. R(1)/R(ND) .GE. 9.99D0)THEN

	      RMAX=10.0_LDP*R(1)		!Stellar wind
	      RMAX=10.0D0*R(1)		!Stellar wind

	    ELSE IF(V(ND) .GT. 10.0_LDP .OR. V(1) .GT. 2.0E+04_LDP)THEN
	    ELSE IF(V(ND) .GT. 10.0D0 .OR. V(1) .GT. 2.0D+04)THEN

	      RMAX=1.5_LDP*R(1)		!SN model
	      RMAX=1.5D0*R(1)		!SN model

	      RMAX=MIN(10.0_LDP,SQRT(R(1)/R(ND)))*R(1)
	      RMAX=MIN(10.0D0,SQRT(R(1)/R(ND)))*R(1)

	    R_EXT(2)=R_EXT(1)-0.1_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(2)=R_EXT(1)-0.1D0*(R_EXT(1)-R_EXT(4))

	    R_EXT(3)=R_EXT(1)-0.4_LDP*(R_EXT(1)-R_EXT(4))
	    R_EXT(3)=R_EXT(1)-0.4D0*(R_EXT(1)-R_EXT(4))

	      BETA=(SIGMA(1)+1.0_LDP)*(R(1)/R(ND)-1.0_LDP)
	      BETA=(SIGMA(1)+1.0D0)*(R(1)/R(ND)-1.0D0)

	        V_EXT(I)=VINF*(1.0_LDP-R_EXT(ND_EXT)/R_EXT(I))**BETA
	        V_EXT(I)=VINF*(1.0D0-R_EXT(ND_EXT)/R_EXT(I))**BETA

	        SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0_LDP)-1.0_LDP
	        SIGMA_EXT(I)=BETA/(R_EXT(I)/R_EXT(ND_EXT)-1.0D0)-1.0D0

	    T1=MIN(3.0_LDP,T1)
	    T1=MIN(3.0D0,T1)

	    IF(T1 .GT. 1.0_LDP)K=K+INT(T1)
	    IF(T1 .GT. 1.0D0)K=K+INT(T1)

	    IF(T1 .GT. 1.0_LDP)THEN
	    IF(T1 .GT. 1.0D0)THEN

	        T1=0.5_LDP*(R(I)+R(I+1))
	        T1=0.5D0*(R(I)+R(I+1))

	        T1=0.5_LDP*(R(I)+R(I+1))
	        T1=0.5D0*(R(I)+R(I+1))

	        IF(T1 .LE. 0.5_LDP*(R_RAY(K)+R_RAY(K+1)) .AND. T1 .GE. 0.5_LDP*(R_RAY(K+1)+R_RAY(K+2)) )THEN
	        IF(T1 .LE. 0.5D0*(R_RAY(K)+R_RAY(K+1)) .AND. T1 .GE. 0.5D0*(R_RAY(K+1)+R_RAY(K+2)) )THEN

	  FG_ERR_ON_FREQ(:)=0.0_LDP
	  FG_ERR_ON_FREQ(:)=0.0D0

	    AV_PREV(:,:)=0.0_LDP
	    AV_PREV(:,:)=0.0D0

	    CV_PREV(:,:)=0.0_LDP
	    CV_PREV(:,:)=0.0D0

	    I_P_PREV(:,:)=0.0_LDP
	    I_P_PREV(:,:)=0.0D0

	    I_M_PREV(:,:)=0.0_LDP
	    I_M_PREV(:,:)=0.0D0

	      T1=3.33564E-06_LDP*V_RAY(I)/R_RAY(I)
	      T1=3.33564D-06*V_RAY(I)/R_RAY(I)

	      GAM(I,LS)=T1*MU(LS)*MU(LS)*(SIGMA_RAY(I)+1.0_LDP)
	      GAM(I,LS)=T1*MU(LS)*MU(LS)*(SIGMA_RAY(I)+1.0D0)

	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564E-06_LDP*
	        GAMH(I,LS)=(V_RAY(I+1)+V_RAY(I))*3.33564D-06*

	1                   0.5_LDP*MU(LS)*MU(LS)*
	1                   0.5D0*MU(LS)*MU(LS)*

	1                   (SIGMA_RAY(I)+SIGMA_RAY(I+1)+2.0_LDP)/
	1                   (SIGMA_RAY(I)+SIGMA_RAY(I+1)+2.0D0)/

	      GAMH(NI,LS)=0.0_LDP
	      GAMH(NI,LS)=0.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	    IF(ALPHA .LT. 2.0_LDP)ALPHA=2.0_LDP
	    IF(ALPHA .LT. 2.0D0)ALPHA=2.0D0

	    IF(ESEC_POW .LT. 2.0_LDP)ESEC_POW=2.0_LDP
	    IF(ESEC_POW .LT. 2.0D0)ESEC_POW=2.0D0

	  IF(ALPHA .LT. 3.5_LDP)ALPHA=3.5_LDP
	  IF(ALPHA .LT. 3.5D0)ALPHA=3.5D0

	    IF(ETA_EXT(I) .LE. 1.0E-280_LDP)ETA_EXT(I)=1.0E-280_LDP
	    IF(ETA_EXT(I) .LE. 1.0D-280)ETA_EXT(I)=1.0D-280

	      T2=(3.0_LDP*CHI_COEF(K,1)*T1+2.0_LDP*CHI_COEF(K,2))*T1+CHI_COEF(K,3)
	      T2=(3.0D0*CHI_COEF(K,1)*T1+2.0D0*CHI_COEF(K,2))*T1+CHI_COEF(K,3)

	      TMPV(I)=0.5_LDP*(CHI_RAY(I)+CHI_RAY(I+1))*dR
	      TMPV(I)=0.5D0*(CHI_RAY(I)+CHI_RAY(I+1))*dR

	      TMPV(I)=0.5_LDP*dR*( CHI_RAY(I)+CHI_RAY(I+1) +
	      TMPV(I)=0.5D0*dR*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dR*(dCHIdR_RAY(I+1) - dCHIdR_RAY(I))/6.0_LDP )
	1            dR*(dCHIdR_RAY(I+1) - dCHIdR_RAY(I))/6.0D0 )

	      TMPV(I)=0.5_LDP*dR*( CHI_RAY(I)+CHI_RAY(I+1) +
	      TMPV(I)=0.5D0*dR*( CHI_RAY(I)+CHI_RAY(I+1) +

	1            dR*(dCHIdR_RAY(I+1)-dCHIdR_RAY(I))/6.0_LDP )
	1            dR*(dCHIdR_RAY(I+1)-dCHIdR_RAY(I))/6.0D0 )

	        DTAU(I,LS)=TMPV(I)/MU(LS)+ 3.33564E-06_LDP*MU(LS)*(V_RAY(I)-V_RAY(I+1))/dLOG_NU
	        DTAU(I,LS)=TMPV(I)/MU(LS)+ 3.33564D-06*MU(LS)*(V_RAY(I)-V_RAY(I+1))/dLOG_NU

	  IBOUND(:)=0.0_LDP
	  IBOUND(:)=0.0D0

	  AV(:,:)=0.0_LDP
	  AV(:,:)=0.0D0

	  CV(:,:)=0.0_LDP
	  CV(:,:)=0.0D0

	        Q(I)=0.0_LDP
	        Q(I)=0.0D0

	        QH(I)=0.0_LDP
	        QH(I)=0.0D0

	        QH(I)=GAMH(I,LS)*2.0_LDP/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)
	        QH(I)=GAMH(I,LS)*2.0D0/((CHI_RAY(I)+CHI_RAY(I+1))*dLOG_NU)

	      QH(NI)=0.0_LDP
	      QH(NI)=0.0D0

	      T1=0.0_LDP
	      T1=0.0D0

	1            *(1.0_LDP+T1*(1.0_LDP-CHI_RAY(NI)/OLDCHI(LS)))
	1            *(1.0D0+T1*(1.0D0-CHI_RAY(NI)/OLDCHI(LS)))

	      TC(NI,LS)=0.0_LDP				!As used.
	      TC(NI,LS)=0.0D0				!As used.

	      DIV(1)=1.0_LDP/(TC(1,LS)+TB(1,LS))
	      DIV(1)=1.0D0/(TC(1,LS)+TB(1,LS))

	        DIV(I)=1.0_LDP/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))
	        DIV(I)=1.0D0/(TA(I,LS)*TB(I-1,LS)+TB(I,LS)+TC(I,LS))

	      XM(1)=0.0_LDP
	      XM(1)=0.0D0

	        XM(I)=-0.5_LDP*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))
	        XM(I)=-0.5D0*SOURCE_RAY(I)*(DTAU(I-1,LS)+DTAU(I,LS))

	      T1=1.0E-08_LDP*ABS(AV(K,LS))
	      T1=1.0D-08*ABS(AV(K,LS))

	        AV(I,LS)=MAX(0.01_LDP*ABS(AV(I,LS)),T1)
	        AV(I,LS)=MAX(0.01D0*ABS(AV(I,LS)),T1)

	      CV_BOUND(LS)=0.0_LDP
	      CV_BOUND(LS)=0.0D0

	      IPLUS_P(LS)=0.0_LDP
	      IPLUS_P(LS)=0.0D0

	      CV_BOUND(LS)=0.5_LDP*(CV(K+1,LS)+CV(K-1,LS))
	      CV_BOUND(LS)=0.5D0*(CV(K+1,LS)+CV(K-1,LS))

	      Q(1:NI)=0.0_LDP
	      Q(1:NI)=0.0D0

	        EE(I)=0.0_LDP
	        EE(I)=0.0D0

	        IF(T1 .LT. 700.0_LDP)EE(I)=EXP(-T1)
	        IF(T1 .LT. 700.0D0)EE(I)=EXP(-T1)

	        IF(T1 .GT. 0.5_LDP)THEN
	        IF(T1 .GT. 0.5D0)THEN

	          E0(I)=1.0_LDP-EE(I)
	          E0(I)=1.0D0-EE(I)

	          E1(I)=1.0_LDP-E0(I)/T1
	          E1(I)=1.0D0-E0(I)/T1

	          E2(I)=1.0_LDP-2.0_LDP*E1(I)/T1
	          E2(I)=1.0D0-2.0D0*E1(I)/T1

	          E3(I)=1.0_LDP-3.0_LDP*E2(I)/T1
	          E3(I)=1.0D0-3.0D0*E2(I)/T1

	        ELSE IF(T1 .GT. 0.1_LDP)THEN
	        ELSE IF(T1 .GT. 0.1D0)THEN

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP*
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0*

	1               (1.0_LDP-T1/10.0_LDP*(1.0_LDP-T1/11.0_LDP*
	1               (1.0D0-T1/10.0D0*(1.0D0-T1/11.0D0*

	1               (1.0_LDP-T1/12.0_LDP*(1.0_LDP-T1/13.0_LDP)))))))) )
	1               (1.0D0-T1/12.0D0*(1.0D0-T1/13.0D0)))))))) )

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0D0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	          E3(I)=0.25_LDP*T1*( 1.0_LDP-0.20_LDP*T1*
	          E3(I)=0.25D0*T1*( 1.0D0-0.20*T1*

	1               (1.0_LDP-T1/6.0_LDP*(1.0_LDP-T1/7.0_LDP*
	1               (1.0D0-T1/6.0D0*(1.0D0-T1/7.0D0*

	1               (1.0_LDP-T1/8.0_LDP*(1.0_LDP-T1/9.0_LDP) ))))
	1               (1.0D0-T1/8.0D0*(1.0D0-T1/9.0D0) ))))

	          E2(I)=T1*( 1.0_LDP-E3(I) )/3.0_LDP
	          E2(I)=T1*( 1.0D0-E3(I) )/3.0D0

	          E1(I)=T1*( 1.0_LDP-E2(I) )/2.0_LDP
	          E1(I)=T1*( 1.0D0-E2(I) )/2.0d0

	          E0(I)=T1*( 1.0_LDP-E1(I) )
	          E0(I)=T1*( 1.0D0-E1(I) )

	        A1(I,LS)=E0(I)-3.0_LDP*E2(I)+2.0_LDP*E3(I)
	        A1(I,LS)=E0(I)-3.0D0*E2(I)+2.0D0*E3(I)

	        A2(I,LS)=3.0_LDP*E2(I)-2.0_LDP*E3(I)
	        A2(I,LS)=3.0D0*E2(I)-2.0D0*E3(I)

	        A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0_LDP*E2(I)+E3(I))
	        A3(I,LS)=DTAU(I,LS)*(E1(I)-2.0D0*E2(I)+E3(I))

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5D0*ABS(dS(1)))

	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1               MIN(ABS(S(I-1)),ABS(S(I)),0.5D0*ABS(dS(I)))

	1               MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1               MIN(ABS(S(NI-1)),0.5D0*ABS(dS(NI)))

	1                      MIN(ABS(S(1)),0.5_LDP*ABS(dS(1)))
	1                      MIN(ABS(S(1)),0.5D0*ABS(dS(1)))

	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5_LDP*ABS(dS(I)))
	1          MIN(ABS(S(I-1)),ABS(S(I)),0.5D0*ABS(dS(I)))

	1            MIN(ABS(S(NI-1)),0.5_LDP*ABS(dS(NI)))
	1            MIN(ABS(S(NI-1)),0.5D0*ABS(dS(NI)))

	    CV_BOUND(LS)=0.5_LDP*(I_P(K,LS)-I_M(K,LS))
	    CV_BOUND(LS)=0.5D0*(I_P(K,LS)-I_M(K,LS))

	      AV(I,LS)=0.5_LDP*( I_P(I,LS)+I_M(I,LS) )
	      AV(I,LS)=0.5D0*( I_P(I,LS)+I_M(I,LS) )

	      CV(I,LS)=0.5_LDP*( I_P(I,LS)-I_M(I,LS) )
	      CV(I,LS)=0.5D0*( I_P(I,LS)-I_M(I,LS) )

	HBC=0.0_LDP			!uI+/J or H/J at model outer boundary.
	HBC=0.0D0			!uI+/J or H/J at model outer boundary.

	HBC_INCID=0.0_LDP			!iI-/J at model outer boundary.
	HBC_INCID=0.0D0			!iI-/J at model outer boundary.

	NBC=0.0_LDP			!N/J at model outer boundary.
	NBC=0.0D0			!N/J at model outer boundary.

	NBC_INCID=0.0_LDP
	NBC_INCID=0.0D0

	IN_HBC=0.0_LDP
	IN_HBC=0.0D0

	JNU(:)=0.0_LDP			!1:ND
	JNU(:)=0.0D0			!1:ND

	HNU(:)=0.0_LDP
	HNU(:)=0.0D0

	KNU(:)=0.0_LDP
	KNU(:)=0.0D0

	NNU(:)=0.0_LDP
	NNU(:)=0.0D0

	N_ON_J(:)=0.0_LDP
	N_ON_J(:)=0.0D0

	     TMPV(I)=0.5_LDP*(R(I)+R(I+1))
	     TMPV(I)=0.5D0*(R(I)+R(I+1))

	      T2=0.5_LDP*(R(I)+R(I+1))
	      T2=0.5D0*(R(I)+R(I+1))

	      T1=( 2.0_LDP*T2-(R_RAY(K)+R_RAY(K+1)) )/(R_RAY(K+2)-R_RAY(K))
	      T1=( 2.0D0*T2-(R_RAY(K)+R_RAY(K+1)) )/(R_RAY(K+2)-R_RAY(K))

	      HNU(I)=HNU(I)+HQW(LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      HNU(I)=HNU(I)+HQW(LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	      NNU(I)=NNU(I)+NQW(LS)*((1.0_LDP-T1)*CV(K,LS)+T1*CV(K+1,LS))
	      NNU(I)=NNU(I)+NQW(LS)*((1.0D0-T1)*CV(K,LS)+T1*CV(K+1,LS))

	    HBC=HBC+0.5_LDP*(AV(K,LS)+CV_BOUND(LS))*HQW(LS)
	    HBC=HBC+0.5D0*(AV(K,LS)+CV_BOUND(LS))*HQW(LS)

	    HBC_INCID=HBC_INCID+0.5_LDP*(AV(K,LS)-CV_BOUND(LS))*HQW(LS)
	    HBC_INCID=HBC_INCID+0.5D0*(AV(K,LS)-CV_BOUND(LS))*HQW(LS)

	    NBC=NBC+0.5_LDP*(AV(K,LS)+CV_BOUND(LS))*NQW(LS)
	    NBC=NBC+0.5D0*(AV(K,LS)+CV_BOUND(LS))*NQW(LS)

	    NBC_INCID=NBC_INCID+0.5_LDP*(AV(K,LS)-CV_BOUND(LS))*NQW(LS)
	    NBC_INCID=NBC_INCID+0.5D0*(AV(K,LS)-CV_BOUND(LS))*NQW(LS)

	IN_HBC=IN_HBC/(2.0_LDP*JNU(ND)-IC)
	IN_HBC=IN_HBC/(2.0D0*JNU(ND)-IC)

	    NNU(I)=0.0_LDP
	    NNU(I)=0.0D0

	  N_ON_J(1:ND-1)=0.0_LDP
	  N_ON_J(1:ND-1)=0.0D0

	    IF(HNU(I) .NE. 0.0_LDP)THEN
	    IF(HNU(I) .NE. 0.0D0)THEN

	      T1=100.0_LDP
	      T1=100.0D0

	    IF(T1 .GT. 1.1_LDP .OR. T1 .LT. 0.05_LDP)THEN
	    IF(T1 .GT. 1.1D0 .OR. T1 .LT. 0.05D0)THEN

	      NNU(I)=0.0_LDP
	      NNU(I)=0.0D0

	      IF(NNU(I) .GT. 1.0_LDP)THEN
	      IF(NNU(I) .GT. 1.0D0)THEN

	        NNU(I)=1.0_LDP
	        NNU(I)=1.0D0

	      ELSE IF( NNU(I) .LT. 0.01_LDP) THEN
	      ELSE IF( NNU(I) .LT. 0.01D0) THEN

	        NNU(I)=0.01_LDP
	        NNU(I)=0.01D0

	      NNU(I)=0.0_LDP		!Later replaced by average.
	      NNU(I)=0.0D0		!Later replaced by average.

	  IF(JNU(I) .LT. 0.0_LDP)THEN
	  IF(JNU(I) .LT. 0.0D0)THEN

	  T1=0.0_LDP
	  T1=0.0D0


pp_mom_cmf_v1.f

	DATA VDOP_FRAC_SAV/-10001.1_LDP/    !Absurd value
	DATA VDOP_FRAC_SAV/-10001.1D0/    !Absurd value

	    T1=0.5_LDP*(R_SM(I)+R_SM(I+1))
	    T1=0.5D0*(R_SM(I)+R_SM(I+1))

	    MOM_ERR_ON_FREQ(I)=0.0_LDP
	    MOM_ERR_ON_FREQ(I)=0.0D0

          JNU=0.0_LDP; HNU=0.0_LDP
          JNU=0.0D0; HNU=0.0D0

	  JNU_PREV=0.0_LDP; HNU_PREV=0.0_LDP
	  JNU_PREV=0.0D0; HNU_PREV=0.0D0

	  N_ON_J_SAV=0.0_LDP; G_SAV=0.0_LDP; F_SAV=0.0_LDP
	  N_ON_J_SAV=0.0D0; G_SAV=0.0D0; F_SAV=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	  IF(G(I) .GT. 1.0_LDP)G(I)=1.0_LDP
	  IF(G(I) .GT. 1.0D0)G(I)=1.0D0

	  IF(G(I) .LT. -1.0_LDP)G(I)=-1.0_LDP
	  IF(G(I) .LT. -1.0D0)G(I)=-1.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    JNU_PREV(I)=0.0_LDP
	    JNU_PREV(I)=0.0D0

	    HNU_PREV(I)=0.0_LDP
	    HNU_PREV(I)=0.0D0

	    EPS(I)=0.0_LDP
	    EPS(I)=0.0D0

	    EPS_PREV(I)=0.0_LDP
	    EPS_PREV(I)=0.0D0

	  HBC_PREV=0.0_LDP;  IN_HBC_PREV=0.0_LDP; NBC_PREV=0.0_LDP
	  HBC_PREV=0.0D0;  IN_HBC_PREV=0.0D0; NBC_PREV=0.0D0

	  dNBC_INCID=0.0_LDP
	  dNBC_INCID=0.0D0

	    CON_GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    CON_GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_GAM(I)=3.33564E-06_LDP*V(I)/R(I)
	    CON_GAM(I)=3.33564D-06*V(I)/R(I)

	  CON_GAM(ND)=3.33564E-06_LDP*V(ND)/R(ND)
	  CON_GAM(ND)=3.33564D-06*V(ND)/R(ND)

	      W(I)=GAMH(I)*(1.0_LDP+AV_SIGMA(I))*G(I)
	      W(I)=GAMH(I)*(1.0D0+AV_SIGMA(I))*G(I)

	      WPREV(I)=GAMH(I)*(1.0_LDP+AV_SIGMA(I))*G_PREV(I)
	      WPREV(I)=GAMH(I)*(1.0D0+AV_SIGMA(I))*G_PREV(I)

	      W(I)=GAMH(I)*(1.0_LDP+AV_SIGMA(I))*G(I)
	      W(I)=GAMH(I)*(1.0D0+AV_SIGMA(I))*G(I)

	      WPREV(I)=GAMH(I)*(1.0_LDP+AV_SIGMA(I))*G_PREV(I)
	      WPREV(I)=GAMH(I)*(1.0D0+AV_SIGMA(I))*G_PREV(I)

	      EPS(I)=GAMH(I)*(1.0_LDP+AV_SIGMA(I))*N_ON_J(I)/(1.0_LDP+W(I))
	      EPS(I)=GAMH(I)*(1.0D0+AV_SIGMA(I))*N_ON_J(I)/(1.0D0+W(I))

	      EPS_PREV(I)=GAMH(I)*(1.0_LDP+AV_SIGMA(I))*N_ON_J_PREV(I)/(1.0_LDP+W(I))
	      EPS_PREV(I)=GAMH(I)*(1.0D0+AV_SIGMA(I))*N_ON_J_PREV(I)/(1.0D0+W(I))

	  PSI(1)=GAM(1)*NBC*(1.0_LDP+SIGMA(1))
	  PSI(1)=GAM(1)*NBC*(1.0D0+SIGMA(1))

	  PSIPREV(1)=GAM(1)*NBC_PREV*(1.0_LDP+SIGMA(1))
	  PSIPREV(1)=GAM(1)*NBC_PREV*(1.0D0+SIGMA(1))

	  dNBC_INCID=GAM(1)*(1.0_LDP+SIGMA(1))*(NBC_INCID-NBC_INCID_PREV)
	  dNBC_INCID=GAM(1)*(1.0D0+SIGMA(1))*(NBC_INCID-NBC_INCID_PREV)

	  DTAU_MID(I)=0.5_LDP*(DTAU(I)+DTAU(I-1))
	  DTAU_MID(I)=0.5D0*(DTAU(I)+DTAU(I-1))

	  PSI(I)=DTAU_MID(I)*GAM(I)*(1.0_LDP+SIGMA(I))*F(I)
	  PSI(I)=DTAU_MID(I)*GAM(I)*(1.0D0+SIGMA(I))*F(I)

	  PSIPREV(I)=DTAU_MID(I)*GAM(I)*(1.0_LDP+SIGMA(I))*F_PREV(I)
	  PSIPREV(I)=DTAU_MID(I)*GAM(I)*(1.0D0+SIGMA(I))*F_PREV(I)

	  HU(I)=F(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	    TB(I)=DTAU_MID(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAU_MID(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	    TB(I)=DTAU_MID(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)
	    TB(I)=DTAU_MID(I)*(1.0D0-COH_VEC(I)) + PSI(I) + HL(I) + HU(I-1)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  XM(ND)=DBB/3.0_LDP/CHI(ND)
	  XM(ND)=DBB/3.0D0/CHI(ND)

	  XM(ND)=IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	IF(MINVAL(XM(1:ND)) .LE. 0.0_LDP)THEN
	IF(MINVAL(XM(1:ND)) .LE. 0.0D0)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0


pp_var_mom_cmf_v1.f

	JNU=0.0_LDP; HNU=0.0_LDP
	JNU=0.0D0; HNU=0.0D0

	  TX=0.0_LDP; TVX=0.0_LDP
	  TX=0.0D0; TVX=0.0D0

	  JNUM1=0.0_LDP; HNUM1=0.0_LDP
	  JNUM1=0.0D0; HNUM1=0.0D0

	  GAM=0.0_LDP; GAMH=0.0_LDP
	  GAM=0.0D0; GAMH=0.0D0

	  W=0.0_LDP; WPREV=0.0_LDP
	  W=0.0D0; WPREV=0.0D0

	  PSI=0.0_LDP; PSIPREV=0.0_LDP
	  PSI=0.0D0; PSIPREV=0.0D0

	  TX_DIF_d_T=0.0_LDP; TX_DIF_d_dTdR=0.0_LDP
	  TX_DIF_d_T=0.0D0; TX_DIF_d_dTdR=0.0D0

	  EPS=0.0_LDP; EPS_PREV=0.0_LDP
	  EPS=0.0D0; EPS_PREV=0.0D0

	  dN_INCID=0.0_LDP
	  dN_INCID=0.0D0

	THETA=0.0_LDP
	THETA=0.0D0

	  MID_DTAU(I)=0.5_LDP*(DTAU(I-1)+DTAU(I))
	  MID_DTAU(I)=0.5D0*(DTAU(I-1)+DTAU(I))

	    AV_SIGMA=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    W(I)=GAMH(I)*(1.0_LDP+AV_SIGMA)*G(I)
	    W(I)=GAMH(I)*(1.0D0+AV_SIGMA)*G(I)

	    WPREV(I)=GAMH(I)*(1.0_LDP+AV_SIGMA)*G_PREV(I)
	    WPREV(I)=GAMH(I)*(1.0D0+AV_SIGMA)*G_PREV(I)

	    EPS(I)=GAMH(I)*(1.0_LDP+AV_SIGMA)*N_ON_J(I)/(1.0_LDP+W(I))
	    EPS(I)=GAMH(I)*(1.0D0+AV_SIGMA)*N_ON_J(I)/(1.0D0+W(I))

	    EPS_PREV(I)=GAMH(I)*(1.0_LDP+AV_SIGMA)*N_ON_J_PREV(I)/(1.0_LDP+W(I))
	    EPS_PREV(I)=GAMH(I)*(1.0D0+AV_SIGMA)*N_ON_J_PREV(I)/(1.0D0+W(I))

	    GAM(I)=3.33564E-06_LDP*V(I)/R(I)/CHI(I)/dLOG_NU
	    GAM(I)=3.33564D-06*V(I)/R(I)/CHI(I)/dLOG_NU

	  PSI(1)=GAM(1)*NBC*(1.0_LDP+SIGMA(1))
	  PSI(1)=GAM(1)*NBC*(1.0D0+SIGMA(1))

	  PSIPREV(1)=GAM(1)*NBC_PREV*(1.0_LDP+SIGMA(1))
	  PSIPREV(1)=GAM(1)*NBC_PREV*(1.0D0+SIGMA(1))

	  dN_INCID=GAM(1)*(1.0_LDP+SIGMA(1))*(NBC_INCID-NBC_INCID_PREV)
	  dN_INCID=GAM(1)*(1.0D0+SIGMA(1))*(NBC_INCID-NBC_INCID_PREV)

	    PSI(I)=MID_DTAU(I)*GAM(I)*(1.0_LDP+SIGMA(I))*F(I)
	    PSI(I)=MID_DTAU(I)*GAM(I)*(1.0D0+SIGMA(I))*F(I)

	    PSIPREV(I)=MID_DTAU(I)*GAM(I)*(1.0_LDP+SIGMA(I))*F_PREV(I)
	    PSIPREV(I)=MID_DTAU(I)*GAM(I)*(1.0D0+SIGMA(I))*F_PREV(I)

	  HU(I)=F(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=F(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=F(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=F(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  TB(I)=MID_DTAU(I)*(1.0_LDP-THETA(I)) + PSI(I) +HU(I-1) +HL(I)
	  TB(I)=MID_DTAU(I)*(1.0D0-THETA(I)) + PSI(I) +HU(I-1) +HL(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  XM(ND)=DBB/3.0_LDP/CHI(ND)
	  XM(ND)=DBB/3.0D0/CHI(ND)

	  XM(ND)=IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TX_DIF_d_T(ND)=dDBBdT/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=dDBBdT/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=DBB/dTdR/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=DBB/dTdR/3.0D0/CHI(ND) +


rel_variables.f

      chi_tau=(nu_dnu+3.0_LDP)*b+chi
      chi_tau=(nu_dnu+3.0d0)*b+chi


rel_variables_gam.f

      chi_tau=(nu_dnu+3.0_LDP)*b+chi
      chi_tau=(nu_dnu+3.0d0)*b+chi


runge_kutta.f

      hh=h*0.5_LDP
      hh=h*0.5d0

      h6=h/6.0_LDP
      h6=h/6.0d0

        y(i)=y(i)+h6*(dydx(i)+dyt(i)+2.0_LDP*dym(i))
        y(i)=y(i)+h6*(dydx(i)+dyt(i)+2.0d0*dym(i))


solve_cmf_formal_v2.f

      RAY(IP)%I_m(1)=0.0_LDP
      RAY(IP)%I_m(1)=0.0d0

        if(t1 .gt. 0.01_LDP)then
        if(t1 .gt. 0.01D0)then

          e0=1.0_LDP-ee
          e0=1.0d0-ee

          e2=dtau_loc(iz-1)*dtau_loc(iz-1)-2.0_LDP*e1
          e2=dtau_loc(iz-1)*dtau_loc(iz-1)-2.0d0*e1

          e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
          e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0d0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1              (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1              (1.0D0-t1/7.0D0))))/3.0D0

          e1=0.5_LDP*(t1*t1-e2)
          e1=0.5d0*(t1*t1-e2)

          ee=1.0_LDP-e0
          ee=1.0d0-e0

        alpha=e0+(e2-(dtau_loc(iz)+2.0_LDP*dtau_loc(iz-1))*e1)/(dtau_loc(iz-1)*(dtau_loc(iz)+dtau_loc(iz-1)))
        alpha=e0+(e2-(dtau_loc(iz)+2.0d0*dtau_loc(iz-1))*e1)/(dtau_loc(iz-1)*(dtau_loc(iz)+dtau_loc(iz-1)))

        if(t1 .lt. 0.0_LDP)then
        if(t1 .lt. 0.0d0)then

      if(t1 .gt. 0.01_LDP)then
      if(t1 .gt. 0.01d0)then

        e0=1.0_LDP-ee
        e0=1.0d0-ee

        e2=dtau_loc(nzz-1)*dtau_loc(nzz-1)-2.0_LDP*e1
        e2=dtau_loc(nzz-1)*dtau_loc(nzz-1)-2.0d0*e1

        e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
        e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0D0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1              (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1              (1.0D0-t1/7.0D0))))/3.0D0

        e1=0.5_LDP*(t1*t1-e2)
        e1=0.5d0*(t1*t1-e2)

        ee=1.0_LDP-e0
        ee=1.0d0-e0

        if(freq_store(n_store-1) .EQ. 0.0_LDP)THEN
        if(freq_store(n_store-1) .EQ. 0.0D0)THEN

	if(new_freq .ge. freq_store(k) .and. freq_store(n_store-1) .eq. 0.0_LDP)THEN
	if(new_freq .ge. freq_store(k) .and. freq_store(n_store-1) .eq. 0.0D0)THEN

          ibound=t1*ray(ip)%i_in_bnd_store(ist)+(1.0_LDP-t1)*ray(ip)%i_in_bnd_store(iend)
          ibound=t1*ray(ip)%i_in_bnd_store(ist)+(1.0d0-t1)*ray(ip)%i_in_bnd_store(iend)

        if(t1 .gt. 0.01_LDP)then
        if(t1 .gt. 0.01d0)then

          e0=1.0_LDP-ee
          e0=1.0d0-ee

          e2=dtau_loc(iz)*dtau_loc(iz)-2.0_LDP*e1
          e2=dtau_loc(iz)*dtau_loc(iz)-2.0d0*e1

           e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
           e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0D0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1              (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1              (1.0D0-t1/7.0D0))))/3.0D0

           e1=0.5_LDP*(t1*t1-e2)
           e1=0.5d0*(t1*t1-e2)

           ee=1.0_LDP-e0
           ee=1.0d0-e0

        gamma=e0+(e2-(dtau_loc(iz-1)+2.0_LDP*dtau_loc(iz))*e1)/(dtau_loc(iz)*(dtau_loc(iz)+dtau_loc(iz-1)))
        gamma=e0+(e2-(dtau_loc(iz-1)+2.0d0*dtau_loc(iz))*e1)/(dtau_loc(iz)*(dtau_loc(iz)+dtau_loc(iz-1)))

        if(t1 .lt. 0.0_LDP)then
        if(t1 .lt. 0.0d0)then

        if(t1 .gt. 0.01_LDP)then
        if(t1 .gt. 0.01d0)then

          e0=1.0_LDP-ee
          e0=1.0d0-ee

          e2=dtau_loc(iz)*dtau_loc(iz)-2.0_LDP*e1
          e2=dtau_loc(iz)*dtau_loc(iz)-2.0d0*e1

          e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
          e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0d0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1                (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1                (1.0D0-t1/7.0D0))))/3.0D0

          e1=0.5_LDP*(t1*t1-e2)
          e1=0.5d0*(t1*t1-e2)

          ee=1.0_LDP-e0
          ee=1.0d0-e0


solve_cmf_formal_v3_gam.f

	REAL(KIND=LDP), PARAMETER :: PLANCK=4.135668E-21_LDP
	REAL(KIND=LDP), PARAMETER :: PLANCK=4.135668D-21

      RAY(IP)%I_m(1)=0.0_LDP
      RAY(IP)%I_m(1)=0.0d0

        if(t1 .gt. 0.01_LDP)then
        if(t1 .gt. 0.01D0)then

          e0=1.0_LDP-ee
          e0=1.0d0-ee

          e2=dtau_loc(iz-1)*dtau_loc(iz-1)-2.0_LDP*e1
          e2=dtau_loc(iz-1)*dtau_loc(iz-1)-2.0d0*e1

          e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
          e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0d0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1              (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1              (1.0D0-t1/7.0D0))))/3.0D0

          e1=0.5_LDP*(t1*t1-e2)
          e1=0.5d0*(t1*t1-e2)

          ee=1.0_LDP-e0
          ee=1.0d0-e0

        alpha=e0+(e2-(dtau_loc(iz)+2.0_LDP*dtau_loc(iz-1))*e1)/(dtau_loc(iz-1)*(dtau_loc(iz)+dtau_loc(iz-1)))
        alpha=e0+(e2-(dtau_loc(iz)+2.0d0*dtau_loc(iz-1))*e1)/(dtau_loc(iz-1)*(dtau_loc(iz)+dtau_loc(iz-1)))

        if(t1 .lt. 0.0_LDP)then
        if(t1 .lt. 0.0d0)then

      if(t1 .gt. 0.01_LDP)then
      if(t1 .gt. 0.01d0)then

        e0=1.0_LDP-ee
        e0=1.0d0-ee

        e2=dtau_loc(nzz-1)*dtau_loc(nzz-1)-2.0_LDP*e1
        e2=dtau_loc(nzz-1)*dtau_loc(nzz-1)-2.0d0*e1

        e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
        e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0D0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1              (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1              (1.0D0-t1/7.0D0))))/3.0D0

        e1=0.5_LDP*(t1*t1-e2)
        e1=0.5d0*(t1*t1-e2)

        ee=1.0_LDP-e0
        ee=1.0d0-e0

        if(freq_store(n_store-1) .EQ. 0.0_LDP)THEN
        if(freq_store(n_store-1) .EQ. 0.0D0)THEN

	if(new_freq .ge. freq_store(k) .and. freq_store(n_store-1) .eq. 0.0_LDP)THEN
	if(new_freq .ge. freq_store(k) .and. freq_store(n_store-1) .eq. 0.0D0)THEN

          ibound=t1*ray(ip)%i_in_bnd_store(ist)+(1.0_LDP-t1)*ray(ip)%i_in_bnd_store(iend)
          ibound=t1*ray(ip)%i_in_bnd_store(ist)+(1.0d0-t1)*ray(ip)%i_in_bnd_store(iend)

        if(t1 .gt. 0.01_LDP)then
        if(t1 .gt. 0.01d0)then

          e0=1.0_LDP-ee
          e0=1.0d0-ee

          e2=dtau_loc(iz)*dtau_loc(iz)-2.0_LDP*e1
          e2=dtau_loc(iz)*dtau_loc(iz)-2.0d0*e1

           e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
           e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0D0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1              (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1              (1.0D0-t1/7.0D0))))/3.0D0

           e1=0.5_LDP*(t1*t1-e2)
           e1=0.5d0*(t1*t1-e2)

           ee=1.0_LDP-e0
           ee=1.0d0-e0

        gamma=e0+(e2-(dtau_loc(iz-1)+2.0_LDP*dtau_loc(iz))*e1)/(dtau_loc(iz)*(dtau_loc(iz)+dtau_loc(iz-1)))
        gamma=e0+(e2-(dtau_loc(iz-1)+2.0d0*dtau_loc(iz))*e1)/(dtau_loc(iz)*(dtau_loc(iz)+dtau_loc(iz-1)))

        if(t1 .lt. 0.0_LDP)then
        if(t1 .lt. 0.0d0)then

        if(t1 .gt. 0.01_LDP)then
        if(t1 .gt. 0.01d0)then

          e0=1.0_LDP-ee
          e0=1.0d0-ee

          e2=dtau_loc(iz)*dtau_loc(iz)-2.0_LDP*e1
          e2=dtau_loc(iz)*dtau_loc(iz)-2.0d0*e1

          e2=t1*t1*t1*(1.0_LDP-0.25_LDP*t1*(1.0_LDP-0.2_LDP*t1*(1.0_LDP-t1/6.0_LDP*
          e2=t1*t1*t1*(1.0D0-0.25D0*t1*(1.0d0-0.2D0*t1*(1.0D0-t1/6.0D0*

     1                (1.0_LDP-t1/7.0_LDP))))/3.0_LDP
     1                (1.0D0-t1/7.0D0))))/3.0D0

          e1=0.5_LDP*(t1*t1-e2)
          e1=0.5d0*(t1*t1-e2)

          ee=1.0_LDP-e0
          ee=1.0d0-e0


tst_exp.f


tst_get_ib.f

	MU(1)=0.0_LDP; MU(NP)=1.0_LDP
	MU(1)=0.0D0; MU(NP)=1.0D0

	  MU(LS)=(LS-1.0_LDP)/(NP-1.0_LDP)
	  MU(LS)=(LS-1.0D0)/(NP-1.0D0)

	FREQ=20.0_LDP
	FREQ=20.0D0

	  FREQ=FREQ/2.0_LDP
	  FREQ=FREQ/2.0D0


var_jrel_v1.f

	JNU=0.0_LDP			!1:ND
	JNU=0.0D0			!1:ND

	GAM_RSQHNU=0.0_LDP		!1:ND
	GAM_RSQHNU=0.0D0		!1:ND

	  TX(:,:,:)=0.0_LDP		!ND*ND*NM
	  TX(:,:,:)=0.0D0		!ND*ND*NM

	  TVX(:,:,:)=0.0_LDP		!(ND-1)*ND*NM )
	  TVX(:,:,:)=0.0D0		!(ND-1)*ND*NM )

	  JNU_PREV=0.0_LDP
	  JNU_PREV=0.0D0

	  GAM_RSQHNU_PREV=0.0_LDP
	  GAM_RSQHNU_PREV=0.0D0

	  W=0.0_LDP
	  W=0.0D0

	  WPREV=0.0_LDP
	  WPREV=0.0D0

	  PSI=0.0_LDP
	  PSI=0.0D0

	  PSIPREV=0.0_LDP
	  PSIPREV=0.0D0

	  TX_DIF_d_T=0.0_LDP
	  TX_DIF_d_T=0.0D0

	  TX_DIF_d_dTdR=0.0_LDP
	  TX_DIF_d_dTdR=0.0D0

	  EPS_A=0.0_LDP
	  EPS_A=0.0D0

	  EPS_B=0.0_LDP
	  EPS_B=0.0D0

	  EPS_PREV_A=0.0_LDP
	  EPS_PREV_A=0.0D0

	  EPS_PREV_B=0.0_LDP
	  EPS_PREV_B=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  FEDD_PREV(:)=0.0_LDP
	  FEDD_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  GEDD_PREV(:)=0.0_LDP
	  GEDD_PREV(:)=0.0D0

	  RSQN_ON_RSQJ_PREV(:)=0.0_LDP
	  RSQN_ON_RSQJ_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP       !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06       !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          RSQN_ON_RSQJ(1:ND)=0.0_LDP
          RSQN_ON_RSQJ(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	  TA(ND-I+1)=( 3.0_LDP*FEDD(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*FEDD(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-FEDD(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*GEDD_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*GEDD_PREV(I))

	  GAM_RSQ_DTAUONQ(I)=0.5_LDP*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  GAM_RSQ_DTAUONQ(I)=0.5D0*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*FEDD(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*FEDD_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*FEDD_PREV(I)+

	  P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	  P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	  VdJdR_TERM(1:ND)=0.0_LDP
	  VdJdR_TERM(1:ND)=0.0D0

	  P_J(1:ND)=1.0_LDP
	  P_J(1:ND)=1.0D0

	XM(1)=0.0_LDP; XM(ND)=0.0_LDP
	XM(1)=0.0D0; XM(ND)=0.0D0

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             BETA(1)*FEDD_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             BETA(1)*FEDD_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	XM(1)=0.0_LDP
	XM(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  TA(ND)=0.0_LDP; TC(ND)=0.0_LDP;
	  TA(ND)=0.0D0; TC(ND)=0.0D0;

	  TB(ND)=1.0_LDP
	  TB(ND)=1.0D0

	  XM(ND)=GAM_RSQ(ND)*DBB/3.0_LDP/CHI(ND)
	  XM(ND)=GAM_RSQ(ND)*DBB/3.0D0/CHI(ND)

	  XM(ND)=GAM_RSQ(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=GAM_RSQ(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	IF(ABS(FREQ-49.8654_LDP) .LT. 0.001_LDP)THEN
	IF(ABS(FREQ-49.8654D0) .LT. 0.001)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0D0/CHI(ND) +


var_jrel_v2.f

	JNU=0.0_LDP			!1:ND
	JNU=0.0D0			!1:ND

	GAM_RSQHNU=0.0_LDP		!1:ND
	GAM_RSQHNU=0.0D0		!1:ND

	  TX(:,:,:)=0.0_LDP		!ND*ND*NM
	  TX(:,:,:)=0.0D0		!ND*ND*NM

	  TVX(:,:,:)=0.0_LDP		!(ND-1)*ND*NM )
	  TVX(:,:,:)=0.0D0		!(ND-1)*ND*NM )

	  JNU_PREV=0.0_LDP
	  JNU_PREV=0.0D0

	  GAM_RSQHNU_PREV=0.0_LDP
	  GAM_RSQHNU_PREV=0.0D0

	  W=0.0_LDP
	  W=0.0D0

	  WPREV=0.0_LDP
	  WPREV=0.0D0

	  PSI=0.0_LDP
	  PSI=0.0D0

	  PSIPREV=0.0_LDP
	  PSIPREV=0.0D0

	  TX_DIF_d_T=0.0_LDP
	  TX_DIF_d_T=0.0D0

	  TX_DIF_d_dTdR=0.0_LDP
	  TX_DIF_d_dTdR=0.0D0

	  EPS_A=0.0_LDP
	  EPS_A=0.0D0

	  EPS_B=0.0_LDP
	  EPS_B=0.0D0

	  EPS_PREV_A=0.0_LDP
	  EPS_PREV_A=0.0D0

	  EPS_PREV_B=0.0_LDP
	  EPS_PREV_B=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP       !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06       !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	  GAM_RSQ_DTAUONQ(I)=0.5_LDP*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  GAM_RSQ_DTAUONQ(I)=0.5D0*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	  P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	  P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	  VdJdR_TERM(1:ND)=0.0_LDP
	  VdJdR_TERM(1:ND)=0.0D0

	  P_J(1:ND)=1.0_LDP
	  P_J(1:ND)=1.0D0

	XM(1)=0.0_LDP; XM(ND)=0.0_LDP
	XM(1)=0.0D0; XM(ND)=0.0D0

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	XM(1)=0.0_LDP
	XM(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  TA(ND)=0.0_LDP; TC(ND)=0.0_LDP;
	  TA(ND)=0.0D0; TC(ND)=0.0D0;

	  TB(ND)=1.0_LDP
	  TB(ND)=1.0D0

	  XM(ND)=GAM_RSQ(ND)*DBB/3.0_LDP/CHI(ND)
	  XM(ND)=GAM_RSQ(ND)*DBB/3.0D0/CHI(ND)

	  XM(ND)=GAM_RSQ(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=GAM_RSQ(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	IF(ABS(FREQ-49.8654_LDP) .LT. 0.001_LDP)THEN
	IF(ABS(FREQ-49.8654D0) .LT. 0.001D0)THEN

	  IF(XM(I) .GT. 1.0E+20_LDP)THEN
	  IF(XM(I) .GT. 1.0D+20)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0D0/CHI(ND) +


var_jrel_v3.f

	JNU=0.0_LDP			!1:ND
	JNU=0.0D0			!1:ND

	GAM_RSQHNU=0.0_LDP		!1:ND
	GAM_RSQHNU=0.0D0		!1:ND

	  TX(:,:,:)=0.0_LDP		!ND*ND*NM
	  TX(:,:,:)=0.0D0		!ND*ND*NM

	  TVX(:,:,:)=0.0_LDP		!(ND-1)*ND*NM )
	  TVX(:,:,:)=0.0D0		!(ND-1)*ND*NM )

	  JNU_PREV=0.0_LDP
	  JNU_PREV=0.0D0

	  GAM_RSQHNU_PREV=0.0_LDP
	  GAM_RSQHNU_PREV=0.0D0

	  W=0.0_LDP
	  W=0.0D0

	  WPREV=0.0_LDP
	  WPREV=0.0D0

	  PSI=0.0_LDP
	  PSI=0.0D0

	  PSIPREV=0.0_LDP
	  PSIPREV=0.0D0

	  TX_DIF_d_T=0.0_LDP
	  TX_DIF_d_T=0.0D0

	  TX_DIF_d_dTdR=0.0_LDP
	  TX_DIF_d_dTdR=0.0D0

	  EPS_A=0.0_LDP
	  EPS_A=0.0D0

	  EPS_B=0.0_LDP
	  EPS_B=0.0D0

	  EPS_PREV_A=0.0_LDP
	  EPS_PREV_A=0.0D0

	  EPS_PREV_B=0.0_LDP
	  EPS_PREV_B=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP       !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06       !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	  GAM_RSQ_DTAUONQ(I)=0.5_LDP*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  GAM_RSQ_DTAUONQ(I)=0.5D0*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	  P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	  P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	  VdJdR_TERM(1:ND)=0.0_LDP
	  VdJdR_TERM(1:ND)=0.0D0

	  P_J(1:ND)=1.0_LDP
	  P_J(1:ND)=1.0D0

	XM(1)=0.0_LDP; XM(ND)=0.0_LDP
	XM(1)=0.0D0; XM(ND)=0.0D0

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	XM(1)=0.0_LDP
	XM(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  TA(ND)=0.0_LDP; TC(ND)=0.0_LDP;
	  TA(ND)=0.0D0; TC(ND)=0.0D0;

	  TB(ND)=1.0_LDP
	  TB(ND)=1.0D0

	  XM(ND)=GAM_RSQ(ND)*DBB/3.0_LDP/CHI(ND)
	  XM(ND)=GAM_RSQ(ND)*DBB/3.0D0/CHI(ND)

	  XM(ND)=0.0_LDP
	  XM(ND)=0.0D0

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	  DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	    TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN)
	    TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN)

	    XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	    XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

            TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1))
            TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1))

            XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
            XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	    TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	    TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	    dIBCHI_B=(1.0_LDP+IB_STAB_FACTOR)*GAM_RSQ(ND)*FMIN/DTAU/DTAU
	    dIBCHI_B=(1.0D0+IB_STAB_FACTOR)*GAM_RSQ(ND)*FMIN/DTAU/DTAU

	    dIBCHI_B=dIBCHI_B*0.5_LDP*(R(ND-1)-R(ND))
	    dIBCHI_B=dIBCHI_B*0.5D0*(R(ND-1)-R(ND))

	    dIBCHI_A=dIBCHI_B+(1.0_LDP+IB_STAB_FACTOR)*((1.0_LDP-FMIN)/R(ND)/CHI(ND)+HMIN*T1)/CHI(ND)
	    dIBCHI_A=dIBCHI_B+(1.0D0+IB_STAB_FACTOR)*((1.0D0-FMIN)/R(ND)/CHI(ND)+HMIN*T1)/CHI(ND)

	    dIBCHI_A=dIBCHI_A+TA(ND)*JNU(ND-1)**0.5_LDP*(R(ND-1)-R(ND))/DTAU
	    dIBCHI_A=dIBCHI_A+TA(ND)*JNU(ND-1)**0.5D0*(R(ND-1)-R(ND))/DTAU

	    dIBCHI_B=dIBCHI_B+TA(ND)*JNU(ND-1)**0.5_LDP*(R(ND-1)-R(ND))/DTAU
	    dIBCHI_B=dIBCHI_B+TA(ND)*JNU(ND-1)**0.5D0*(R(ND-1)-R(ND))/DTAU

	  XM(ND)=GAM_RSQ(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=GAM_RSQ(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  IF(XM(I) .GT. 1.0E+20_LDP)THEN
	  IF(XM(I) .GT. 1.0D+20)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	  T1=(XM(I)+XM(I+1))/2.0_LDP
	  T1=(XM(I)+XM(I+1))/2.0D0

	    GAM_RSQHNU(I)=0.99_LDP*T1
	    GAM_RSQHNU(I)=0.99D0*T1

	    GAM_RSQHNU(I)=-0.99_LDP*T1
	    GAM_RSQHNU(I)=-0.99D0*T1

	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0D0/CHI(ND) +


var_jrel_v4.f

	JNU=0.0_LDP			!1:ND
	JNU=0.0D0			!1:ND

	GAM_RSQHNU=0.0_LDP		!1:ND
	GAM_RSQHNU=0.0D0		!1:ND

	  TX(:,:,:)=0.0_LDP		!ND*ND*NM
	  TX(:,:,:)=0.0D0		!ND*ND*NM

	  TVX(:,:,:)=0.0_LDP		!(ND-1)*ND*NM )
	  TVX(:,:,:)=0.0D0		!(ND-1)*ND*NM )

	  JNU_PREV=0.0_LDP
	  JNU_PREV=0.0D0

	  GAM_RSQHNU_PREV=0.0_LDP
	  GAM_RSQHNU_PREV=0.0D0

	  W=0.0_LDP
	  W=0.0D0

	  WPREV=0.0_LDP
	  WPREV=0.0D0

	  PSI=0.0_LDP
	  PSI=0.0D0

	  PSIPREV=0.0_LDP
	  PSIPREV=0.0D0

	  TX_DIF_d_T=0.0_LDP
	  TX_DIF_d_T=0.0D0

	  TX_DIF_d_dTdR=0.0_LDP
	  TX_DIF_d_dTdR=0.0D0

	  EPS_A=0.0_LDP
	  EPS_A=0.0D0

	  EPS_B=0.0_LDP
	  EPS_B=0.0D0

	  EPS_PREV_A=0.0_LDP
	  EPS_PREV_A=0.0D0

	  EPS_PREV_B=0.0_LDP
	  EPS_PREV_B=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP       !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06       !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	  GAM_RSQ_DTAUONQ(I)=0.5_LDP*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  GAM_RSQ_DTAUONQ(I)=0.5D0*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	  P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	  P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	  VdJdR_TERM(1:ND)=0.0_LDP
	  VdJdR_TERM(1:ND)=0.0D0

	  P_J(1:ND)=1.0_LDP
	  P_J(1:ND)=1.0D0

	XM(1)=0.0_LDP; XM(ND)=0.0_LDP
	XM(1)=0.0D0; XM(ND)=0.0D0

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	XM(1)=0.0_LDP
	XM(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  TA(ND)=0.0_LDP; TC(ND)=0.0_LDP;
	  TA(ND)=0.0D0; TC(ND)=0.0D0;

	  TB(ND)=1.0_LDP
	  TB(ND)=1.0D0

	  XM(ND)=GAM_RSQ(ND)*DBB/3.0_LDP/CHI(ND)
	  XM(ND)=GAM_RSQ(ND)*DBB/3.0D0/CHI(ND)

	  XM(ND)=0.0_LDP
	  XM(ND)=0.0D0

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	  DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	    TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN)
	    TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN)

	    XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	    XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

            TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1))
            TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1))

            XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
            XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	    TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	    TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	    dIBCHI_B=(1.0_LDP+IB_STAB_FACTOR)*GAM_RSQ(ND)*FMIN/DTAU/DTAU
	    dIBCHI_B=(1.0D0+IB_STAB_FACTOR)*GAM_RSQ(ND)*FMIN/DTAU/DTAU

	    dIBCHI_B=dIBCHI_B*0.5_LDP*(R(ND-1)-R(ND))
	    dIBCHI_B=dIBCHI_B*0.5D0*(R(ND-1)-R(ND))

	    dIBCHI_A=dIBCHI_B+(1.0_LDP+IB_STAB_FACTOR)*((1.0_LDP-FMIN)/R(ND)/CHI(ND)+HMIN*T1)/CHI(ND)
	    dIBCHI_A=dIBCHI_B+(1.0D0+IB_STAB_FACTOR)*((1.0D0-FMIN)/R(ND)/CHI(ND)+HMIN*T1)/CHI(ND)

	    dIBCHI_A=dIBCHI_A+TA(ND)*JNU(ND-1)**0.5_LDP*(R(ND-1)-R(ND))/DTAU
	    dIBCHI_A=dIBCHI_A+TA(ND)*JNU(ND-1)**0.5D0*(R(ND-1)-R(ND))/DTAU

	    dIBCHI_B=dIBCHI_B+TA(ND)*JNU(ND-1)**0.5_LDP*(R(ND-1)-R(ND))/DTAU
	    dIBCHI_B=dIBCHI_B+TA(ND)*JNU(ND-1)**0.5D0*(R(ND-1)-R(ND))/DTAU

	  XM(ND)=GAM_RSQ(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=GAM_RSQ(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  IF(XM(I) .GT. 1.0E+20_LDP)THEN
	  IF(XM(I) .GT. 1.0D+20)THEN

	  IF(XM(I) .LT. 0.0_LDP)THEN
	  IF(XM(I) .LT. 0.0D0)THEN

	    XM(I)=ABS(XM(I))/10.0_LDP
	    XM(I)=ABS(XM(I))/10.0D0

	    T1=(XM(I)+XM(I+1))/2.0_LDP
	    T1=(XM(I)+XM(I+1))/2.0D0

	      GAM_RSQHNU(I)=0.99_LDP*T1
	      GAM_RSQHNU(I)=0.99D0*T1

	      GAM_RSQHNU(I)=-0.99_LDP*T1
	      GAM_RSQHNU(I)=-0.99D0*T1

	      GAM_RSQHNU(I)=0.99_LDP*T1
	      GAM_RSQHNU(I)=0.99D0*T1

	      GAM_RSQHNU(I)=-0.99_LDP*T1
	      GAM_RSQHNU(I)=-0.99D0*T1

	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0D0/CHI(ND) +


var_jrel_v5.f

	JNU=0.0_LDP			!1:ND
	JNU=0.0D0			!1:ND

	GAM_RSQHNU=0.0_LDP		!1:ND
	GAM_RSQHNU=0.0D0		!1:ND

	  TX(:,:,:)=0.0_LDP		!ND*ND*NM
	  TX(:,:,:)=0.0D0		!ND*ND*NM

	  TVX(:,:,:)=0.0_LDP		!(ND-1)*ND*NM )
	  TVX(:,:,:)=0.0D0		!(ND-1)*ND*NM )

	  JNU_PREV=0.0_LDP
	  JNU_PREV=0.0D0

	  GAM_RSQHNU_PREV=0.0_LDP
	  GAM_RSQHNU_PREV=0.0D0

	  W=0.0_LDP
	  W=0.0D0

	  WPREV=0.0_LDP
	  WPREV=0.0D0

	  PSI=0.0_LDP
	  PSI=0.0D0

	  PSIPREV=0.0_LDP
	  PSIPREV=0.0D0

	  TX_DIF_d_T=0.0_LDP
	  TX_DIF_d_T=0.0D0

	  TX_DIF_d_dTdR=0.0_LDP
	  TX_DIF_d_dTdR=0.0D0

	  EPS_A=0.0_LDP
	  EPS_A=0.0D0

	  EPS_B=0.0_LDP
	  EPS_B=0.0D0

	  EPS_PREV_A=0.0_LDP
	  EPS_PREV_A=0.0D0

	  EPS_PREV_B=0.0_LDP
	  EPS_PREV_B=0.0D0

	  DELTAH(:)=0.0_LDP
	  DELTAH(:)=0.0D0

	  DELTA(:)=0.0_LDP
	  DELTA(:)=0.0D0

	  PSIPREV(:)=0.0_LDP
	  PSIPREV(:)=0.0D0

	  H_ON_J_PREV(:)=0.0_LDP
	  H_ON_J_PREV(:)=0.0D0

	  K_ON_J_PREV(:)=0.0_LDP
	  K_ON_J_PREV(:)=0.0D0

	  N_ON_J_PREV(:)=0.0_LDP
	  N_ON_J_PREV(:)=0.0D0

	  NMID_ON_HMID_PREV(:)=0.0_LDP
	  NMID_ON_HMID_PREV(:)=0.0D0

	  NMID_ON_J_PREV(:)=0.0_LDP
	  NMID_ON_J_PREV(:)=0.0D0

	  KMID_ON_J_PREV(:)=0.0_LDP
	  KMID_ON_J_PREV(:)=0.0D0

	  BETA_FREQ(1:ND)=V(1:ND)*3.33564E-06_LDP       !/2.99794D+05
	  BETA_FREQ(1:ND)=V(1:ND)*3.33564D-06       !/2.99794D+05

	    BETA(1:ND)=0.0_LDP
	    BETA(1:ND)=0.0D0

	    GAM_REL_SQ(1:ND)=1.0_LDP/(1.0_LDP-BETA(1:ND)*BETA(1:ND))
	    GAM_REL_SQ(1:ND)=1.0D0/(1.0D0-BETA(1:ND)*BETA(1:ND))

	    GAM_REL_SQ(1:ND)=1.0_LDP
	    GAM_REL_SQ(1:ND)=1.0D0

	    GAM_REL(1:ND)=1.0_LDP
	    GAM_REL(1:ND)=1.0D0

	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)-1.0_LDP
	  CON_dKdNU(1:ND)=GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)-1.0D0

	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0_LDP)
	  CON_dHdNU(1:ND)=BETA(1:ND)*GAM_REL_SQ(1:ND)*(SIGMA(1:ND)+1.0D0)

	    T1=0.5_LDP*(BETA(I)+BETA(I+1))
	    T1=0.5D0*(BETA(I)+BETA(I+1))

	    AV_SIGMA(I)=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA(I)=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    CON_DELTAH(I)=2.0_LDP*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))
	    CON_DELTAH(I)=2.0D0*(BETA_FREQ(I)+BETA_FREQ(I+1))/(R(I)+R(I+1))

	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1)
	    CON_dKdNUH(I)=T1*(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1)

	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0_LDP)/(1.0_LDP-T1*T1) -1.0_LDP
	    CON_dNdNUH(I)=(AV_SIGMA(I)+1.0D0)/(1.0D0-T1*T1) -1.0D0

	  H_ON_J(1:ND)=0.0_LDP
	  H_ON_J(1:ND)=0.0D0

	  N_ON_J(1:ND)=0.0_LDP
	  N_ON_J(1:ND)=0.0D0

	  KMID_ON_J(1:ND)=0.0_LDP
	  KMID_ON_J(1:ND)=0.0D0

          NMID_ON_J(1:ND)=0.0_LDP
          NMID_ON_J(1:ND)=0.0D0

	JNU(:)=0.0_LDP
	JNU(:)=0.0D0

	GAM_RSQHNU(:)=0.0_LDP
	GAM_RSQHNU(:)=0.0D0

	  VdHdR_TERM(1:ND)=0.0_LDP
	  VdHdR_TERM(1:ND)=0.0D0

	1       1.0_LDP+2.0_LDP*GAM_REL_SQ(I)*(SIGMA(I)+1.0_LDP) )
	1       1.0D0+2.0D0*GAM_REL_SQ(I)*(SIGMA(I)+1.0D0) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0_LDP+SIGMA(I))
	      CHI_J(I)=CHI(I)/GAM_REL(I)+CON_DELTA(I)*(1.0D0+SIGMA(I))

	1                   2.0_LDP+GAM_REL_SQ(I)*(1.0_LDP+SIGMA(I)) )
	1                   2.0D0+GAM_REL_SQ(I)*(1.0D0+SIGMA(I)) )

	    P_H(I)=1.0_LDP
	    P_H(I)=1.0D0

	  TA(ND-I+1)=( 3.0_LDP*K_ON_J(I)-1.0_LDP+
	  TA(ND-I+1)=( 3.0D0*K_ON_J(I)-1.0D0+

	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0_LDP)*VdHdR_TERM(I)+
	1           BETA(I)*N_ON_J(I)-(SIGMA(I)+1.0D0)*VdHdR_TERM(I)+

	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0_LDP)*
	1      GAM_REL_SQ(I)*BETA(I)*(SIGMA(I)+1.0D0)*

	1       (BETA(I)*(1.0_LDP-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))
	1       (BETA(I)*(1.0D0-K_ON_J(I)-VdHdR_TERM(I))-N_ON_J(I))

	Q(ND)=1.0_LDP
	Q(ND)=1.0D0

	    W(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID(I))
	    W(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID(I))

	    WPREV(I)=DELTAH(I)*(1.0_LDP+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))
	    WPREV(I)=DELTAH(I)*(1.0D0+CON_dNdNUH(I)*NMID_ON_HMID_PREV(I))

	  GAM_RSQ_DTAUONQ(I)=0.5_LDP*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)
	  GAM_RSQ_DTAUONQ(I)=0.5D0*GAM_RSQ(I)*(DTAU_J(I)+DTAU_J(I-1))/Q(I)

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )
	1            (1.0D0+CON_dKdNU(I)*K_ON_J(I)+CON_dHdNU(I)*H_ON_J(I) )

	1            (1.0_LDP+CON_dKdNU(I)*K_ON_J_PREV(I)+
	1            (1.0D0+CON_dKdNU(I)*K_ON_J_PREV(I)+

	  P_J(1:ND)=1.0_LDP+VdJdR_TERM(1:ND)
	  P_J(1:ND)=1.0D0+VdJdR_TERM(1:ND)

	  VdJdR_TERM(1:ND)=0.0_LDP
	  VdJdR_TERM(1:ND)=0.0D0

	  P_J(1:ND)=1.0_LDP
	  P_J(1:ND)=1.0D0

	XM(1)=0.0_LDP; XM(ND)=0.0_LDP
	XM(1)=0.0D0; XM(ND)=0.0D0

	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0_LDP) )
	1             BETA(1)*K_ON_J_PREV(1))*GAM_REL_SQ(1)*(SIGMA(1)+1.0D0) )

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	XM(1)=0.0_LDP
	XM(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  TA(ND)=0.0_LDP; TC(ND)=0.0_LDP;
	  TA(ND)=0.0D0; TC(ND)=0.0D0;

	  TB(ND)=1.0_LDP
	  TB(ND)=1.0D0

	  XM(ND)=GAM_RSQ(ND)*DBB/3.0_LDP/CHI(ND)
	  XM(ND)=GAM_RSQ(ND)*DBB/3.0D0/CHI(ND)

	  XM(ND)=0.0_LDP
	  XM(ND)=0.0D0

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  DTAU=0.5_LDP*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))
	  DTAU=0.5D0*(R(ND-1)-R(ND))*(CHI(ND)+CHI(ND-1))

	    TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN)
	    TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN)

	    XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
	    XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

            TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+T1))
            TB(ND)=GAM_RSQ(ND)*(FMIN/DTAU + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+T1))

            XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0_LDP-FPLUS)*RSQ_JP/R(ND)/CHI(ND)
            XM(ND)=RSQ_HP-FPLUS*RSQ_JP/DTAU-(1.0D0-FPLUS)*RSQ_JP/R(ND)/CHI(ND)

	    TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	    TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	    dIBCHI_B=(1.0_LDP+IB_STAB_FACTOR)*GAM_RSQ(ND)*FMIN/DTAU/DTAU
	    dIBCHI_B=(1.0D0+IB_STAB_FACTOR)*GAM_RSQ(ND)*FMIN/DTAU/DTAU

	    dIBCHI_B=dIBCHI_B*0.5_LDP*(R(ND-1)-R(ND))
	    dIBCHI_B=dIBCHI_B*0.5D0*(R(ND-1)-R(ND))

	    dIBCHI_A=dIBCHI_B+(1.0_LDP+IB_STAB_FACTOR)*((1.0_LDP-FMIN)/R(ND)/CHI(ND)+HMIN*T1)/CHI(ND)
	    dIBCHI_A=dIBCHI_B+(1.0D0+IB_STAB_FACTOR)*((1.0D0-FMIN)/R(ND)/CHI(ND)+HMIN*T1)/CHI(ND)

	    dIBCHI_A=dIBCHI_A+TA(ND)*JNU(ND-1)**0.5_LDP*(R(ND-1)-R(ND))/DTAU
	    dIBCHI_A=dIBCHI_A+TA(ND)*JNU(ND-1)**0.5D0*(R(ND-1)-R(ND))/DTAU

	    dIBCHI_B=dIBCHI_B+TA(ND)*JNU(ND-1)**0.5_LDP*(R(ND-1)-R(ND))/DTAU
	    dIBCHI_B=dIBCHI_B+TA(ND)*JNU(ND-1)**0.5D0*(R(ND-1)-R(ND))/DTAU

	  XM(ND)=GAM_RSQ(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=GAM_RSQ(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	DERIV_SCL_FAC=1.0_LDP
	DERIV_SCL_FAC=1.0D0

	    DO WHILE(XM(I) .LE. 0.0_LDP .AND. ICNT .LT. 5)
	    DO WHILE(XM(I) .LE. 0.0D0 .AND. ICNT .LT. 5)

	      DERIV_SCL_FAC(I)=DERIV_SCL_FAC(I)*0.5_LDP
	      DERIV_SCL_FAC(I)=DERIV_SCL_FAC(I)*0.5D0

	  IF(XM(I) .GT. 1.0E+20_LDP)THEN
	  IF(XM(I) .GT. 1.0D+20)THEN

	    IF(XM(I) .LT. 0.0_LDP)THEN
	    IF(XM(I) .LT. 0.0D0)THEN

	      XM(I)=ABS(XM(I))/10.0_LDP
	      XM(I)=ABS(XM(I))/10.0D0

	    IF(XM(I) .LT. 0.0_LDP)THEN
	    IF(XM(I) .LT. 0.0D0)THEN

	    T1=(TA(I)+TA(I+1))/2.0_LDP
	    T1=(TA(I)+TA(I+1))/2.0D0

	      GAM_RSQHNU(I)=0.99_LDP*T1
	      GAM_RSQHNU(I)=0.99D0*T1

	      GAM_RSQHNU(I)=-0.99_LDP*T1
	      GAM_RSQHNU(I)=-0.99D0*T1

	      GAM_RSQHNU(I)=0.99_LDP*T1
	      GAM_RSQHNU(I)=0.99D0*T1

	      GAM_RSQHNU(I)=-0.99_LDP*T1
	      GAM_RSQHNU(I)=-0.99D0*T1

	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=GAM_RSQ(ND)*dDBBdT/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=GAM_RSQ(ND)*DBB/dTdR/3.0D0/CHI(ND) +


var_mom_j_cmf_v10.f

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	    AV_SIGMA=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID(I) )
	    W(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID(I) )

	    WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID_PREV(I) )
	    WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID_PREV(I) )

	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0_LDP+W(I))
	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0D0+W(I))

	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	    GAM(I)=3.33564E-06_LDP*V(I)/R(I)/CHI(I)/dLOG_NU
	    GAM(I)=3.33564D-06*V(I)/R(I)/CHI(I)/dLOG_NU

	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) +HU(I-1) +HL(I)

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0_LDP-THETA(1))
	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0D0-THETA(1))

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	      RSQ_HNU(I)=0.99999_LDP*T1
	      RSQ_HNU(I)=0.99999D0*T1

	      RSQ_HNU(I)=-0.99999_LDP*T1
	      RSQ_HNU(I)=-0.99999D0*T1

	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0D0/CHI(ND) +


var_mom_j_cmf_v11.f

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	    AV_SIGMA=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID(I) )
	    W(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID(I) )

	    WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID_PREV(I) )
	    WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID_PREV(I) )

	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0_LDP+W(I))
	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0D0+W(I))

	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	    GAM(I)=3.33564E-06_LDP*V(I)/R(I)/CHI(I)/dLOG_NU
	    GAM(I)=3.33564D-06*V(I)/R(I)/CHI(I)/dLOG_NU

	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) +HU(I-1) +HL(I)

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0_LDP-THETA(1))
	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0D0-THETA(1))

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  LOCAL_DBB=0.0_LDP
	  LOCAL_DBB=0.0D0

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	      RSQ_HNU(I)=0.99999_LDP*T1
	      RSQ_HNU(I)=0.99999D0*T1

	      RSQ_HNU(I)=-0.99999_LDP*T1
	      RSQ_HNU(I)=-0.99999D0*T1

	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0D0/CHI(ND) +


var_mom_j_cmf_v12.f

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	    AV_SIGMA=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID(I) )
	    W(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID(I) )

	    WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID_PREV(I) )
	    WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID_PREV(I) )

	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0_LDP+W(I))
	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0D0+W(I))

	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	    GAM(I)=3.33564E-06_LDP*V(I)/R(I)/CHI(I)/dLOG_NU
	    GAM(I)=3.33564D-06*V(I)/R(I)/CHI(I)/dLOG_NU

	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) +HU(I-1) +HL(I)

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0_LDP-THETA(1))
	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0D0-THETA(1))

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  TB(ND)=(1.0_LDP+IB_STAB_FACTOR)*TB(ND)
	  TB(ND)=(1.0D0+IB_STAB_FACTOR)*TB(ND)

	  LOCAL_DBB=0.0_LDP
	  LOCAL_DBB=0.0D0

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	    T1=(R(I)*R(I)*XM(I)+R(I+1)*R(I+1)*XM(I+1))/2.0_LDP
	    T1=(R(I)*R(I)*XM(I)+R(I+1)*R(I+1)*XM(I+1))/2.0D0

	      RSQ_HNU(I)=0.99999_LDP*T1
	      RSQ_HNU(I)=0.99999D0*T1

	      RSQ_HNU(I)=-0.99999_LDP*T1
	      RSQ_HNU(I)=-0.99999D0*T1

	      RSQ_HNU(I)=0.99999_LDP*T1
	      RSQ_HNU(I)=0.99999D0*T1

	      RSQ_HNU(I)=-0.99999_LDP*T1
	      RSQ_HNU(I)=-0.99999D0*T1

	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0D0/CHI(ND) +


var_mom_j_cmf_v9.f

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	    AV_SIGMA=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID(I) )
	    W(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID(I) )

	    WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID_PREV(I) )
	    WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID_PREV(I) )

	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0_LDP+W(I))
	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0D0+W(I))

	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	    GAM(I)=3.33564E-06_LDP*V(I)/R(I)/CHI(I)/dLOG_NU
	    GAM(I)=3.33564D-06*V(I)/R(I)/CHI(I)/dLOG_NU

	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	    PSIPREV(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) +HU(I-1) +HL(I)

	  TA(1)=0.0_LDP
	  TA(1)=0.0D0

	  VB(1)=0.0_LDP
	  VB(1)=0.0D0

	  VC(1)=0.0_LDP
	  VC(1)=0.0D0

	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J(1))
	  PSI(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J(1))

	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0_LDP+SIGMA(1)*K_ON_J_PREV(1))
	  PSIPREV(1)=R(1)*R(1)*GAM(1)*(1.0D0+SIGMA(1)*K_ON_J_PREV(1))

	  T1=0.25_LDP*(CHI(2)+CHI(1))*(R(2)-R(1))
	  T1=0.25D0*(CHI(2)+CHI(1))*(R(2)-R(1))

	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0_LDP-THETA(1))
	  TB(1)=-(HL(1)+R(1)*R(1)*HBC+EPS_A(1))/T1-PSI(1)-R(1)*R(1)*(1.0D0-THETA(1))

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0D0/CHI(ND) +


var_mom_j_ddt_v1.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  TA(1:ND)=R(1:ND)-1.0E-05_LDP*V(1:ND)*DELTA_TIME_SECS
	  TA(1:ND)=R(1:ND)-1.0D-05*V(1:ND)*DELTA_TIME_SECS

	  JNU_OLDT=0.0_LDP; RSQ_HNU_OLDt=0.0_LDP
	  JNU_OLDT=0.0D0; RSQ_HNU_OLDt=0.0D0

	  HFLUX_AT_INB_OLDT=0.0_LDP; HONJ_OUTBC_OLDT=0.0_LDP
	  HFLUX_AT_INB_OLDT=0.0D0; HONJ_OUTBC_OLDT=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	  TX=0.0_LDP		! ND:ND:NM
	  TX=0.0D0		! ND:ND:NM

	  TVX=0.0_LDP		! ND-1:ND:NM
	  TVX=0.0D0		! ND-1:ND:NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    DJDT(I)=0.0_LDP
	    DJDT(I)=0.0D0

	    DJDT_OLDT(I)=0.0_LDP
	    DJDT_OLDT(I)=0.0D0

	  CHI_AT_INB_PREV=1.0_LDP
	  CHI_AT_INB_PREV=1.0D0

	    GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS
	    GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	HFLUX_AT_INB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	HFLUX_AT_INB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	PSI(ND)=0.0_LDP
	PSI(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  dNU_TERM_DIF_BC=0.0_LDP
	  dNU_TERM_DIF_BC=0.0D0

	1         2.0_LDP*dNU_TERM_DIF_BC+DJDT(ND)*HFLUX_AT_INB)/CHI(ND)
	1         2.0D0*dNU_TERM_DIF_BC+DJDT(ND)*HFLUX_AT_INB)/CHI(ND)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	DUMMY_VEC=0.0_LDP
	DUMMY_VEC=0.0D0

	  T1=R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  T1=R(ND)*R(ND)/3.0D0/CHI(ND)

	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0_LDP+DJDT(ND)) +
	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0D0+DJDT(ND)) +

	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0_LDP+DJDT(ND)) +
	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0D0+DJDT(ND)) +


var_mom_j_ddt_v2.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  TA(1:ND)=R(1:ND)-1.0E-05_LDP*V(1:ND)*DELTA_TIME_SECS
	  TA(1:ND)=R(1:ND)-1.0D-05*V(1:ND)*DELTA_TIME_SECS

	  JNU_OLDT=0.0_LDP; RSQ_HNU_OLDt=0.0_LDP
	  JNU_OLDT=0.0D0; RSQ_HNU_OLDt=0.0D0

	  RSQH_AT_IB_OLDT=0.0_LDP; HONJ_OUTBC_OLDT=0.0_LDP
	  RSQH_AT_IB_OLDT=0.0D0; HONJ_OUTBC_OLDT=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	  TX=0.0_LDP		! ND:ND:NM
	  TX=0.0D0		! ND:ND:NM

	  TVX=0.0_LDP		! ND-1:ND:NM
	  TVX=0.0D0		! ND-1:ND:NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    DJDT(I)=0.0_LDP
	    DJDT(I)=0.0D0

	    DJDT_OLDT(I)=0.0_LDP
	    DJDT_OLDT(I)=0.0D0

	  CHI_AT_INB_PREV=1.0_LDP
	  CHI_AT_INB_PREV=1.0D0

	    GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS
	    GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  dRHSdCHI_OB=0.0_LDP
	  dRHSdCHI_OB=0.0D0

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)
	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  GAM_INB=0.0_LDP                               !or set to GAM(ND)
	  GAM_INB=0.0D0                               !or set to GAM(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  TB(ND)=TB(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*R(ND)*R(ND)*F(ND)/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+GAM(ND)) )
	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+GAM(ND)) )

	  TB(ND)=TB(ND)+0.1_LDP*RSQ*FMIN/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*RSQ*FMIN/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  DJDt(ND)=0.0_LDP
	  DJDt(ND)=0.0D0

	  DJDt_OLDt(ND)=0.0_LDP
	  DJDt_OLDt(ND)=0.0D0

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	DUMMY_VEC=0.0_LDP
	DUMMY_VEC=0.0D0

	  T1=R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  T1=R(ND)*R(ND)/3.0D0/CHI(ND)

	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0D0+RECIP_CDELTAT/CHI(ND)) +

	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0D0+RECIP_CDELTAT/CHI(ND)) +


var_mom_j_ddt_v3.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  TA(1:ND)=R(1:ND)-1.0E-05_LDP*V(1:ND)*DELTA_TIME_SECS
	  TA(1:ND)=R(1:ND)-1.0D-05*V(1:ND)*DELTA_TIME_SECS

	  JNU_OLDT=0.0_LDP; RSQ_HNU_OLDt=0.0_LDP
	  JNU_OLDT=0.0D0; RSQ_HNU_OLDt=0.0D0

	  RSQH_AT_IB_OLDT=0.0_LDP; HONJ_OUTBC_OLDT=0.0_LDP
	  RSQH_AT_IB_OLDT=0.0D0; HONJ_OUTBC_OLDT=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	  TX=0.0_LDP		! ND:ND:NM
	  TX=0.0D0		! ND:ND:NM

	  TVX=0.0_LDP		! ND-1:ND:NM
	  TVX=0.0D0		! ND-1:ND:NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    DJDT(I)=0.0_LDP
	    DJDT(I)=0.0D0

	    DJDT_OLDT(I)=0.0_LDP
	    DJDT_OLDT(I)=0.0D0

	  CHI_AT_INB_PREV=1.0_LDP
	  CHI_AT_INB_PREV=1.0D0

	    GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS
	    GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  dRHSdCHI_OB=0.0_LDP
	  dRHSdCHI_OB=0.0D0

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)
	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  GAM_INB=0.0_LDP                               !or set to GAM(ND)
	  GAM_INB=0.0D0                               !or set to GAM(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  TB(ND)=TB(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*R(ND)*R(ND)*F(ND)/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+GAM(ND)) )
	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+GAM(ND)) )

	  TB(ND)=TB(ND)+0.1_LDP*RSQ*FMIN/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*RSQ*FMIN/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  DJDt(ND)=0.0_LDP
	  DJDt(ND)=0.0D0

	  DJDt_OLDt(ND)=0.0_LDP
	  DJDt_OLDt(ND)=0.0D0

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	  T1=R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  T1=R(ND)*R(ND)/3.0D0/CHI(ND)

	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0D0+RECIP_CDELTAT/CHI(ND)) +

	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0D0+RECIP_CDELTAT/CHI(ND)) +


var_mom_j_ddt_v4.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  TA(1:ND)=R(1:ND)-1.0E-05_LDP*V(1:ND)*DELTA_TIME_SECS
	  TA(1:ND)=R(1:ND)-1.0D-05*V(1:ND)*DELTA_TIME_SECS

	  JNU_OLDT=0.0_LDP; RSQ_HNU_OLDt=0.0_LDP
	  JNU_OLDT=0.0D0; RSQ_HNU_OLDt=0.0D0

	  RSQH_AT_IB_OLDT=0.0_LDP; HONJ_OUTBC_OLDT=0.0_LDP
	  RSQH_AT_IB_OLDT=0.0D0; HONJ_OUTBC_OLDT=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	  TX=0.0_LDP		! ND:ND:NM
	  TX=0.0D0		! ND:ND:NM

	  TVX=0.0_LDP		! ND-1:ND:NM
	  TVX=0.0D0		! ND-1:ND:NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    DJDT(I)=0.0_LDP
	    DJDT(I)=0.0D0

	    DJDT_OLDT(I)=0.0_LDP
	    DJDT_OLDT(I)=0.0D0

	  CHI_AT_INB_PREV=1.0_LDP
	  CHI_AT_INB_PREV=1.0D0

	    GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS
	    GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  dRHSdCHI_OB=0.0_LDP
	  dRHSdCHI_OB=0.0D0

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)
	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  GAM_INB=0.0_LDP                               !or set to GAM(ND)
	  GAM_INB=0.0D0                               !or set to GAM(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  TB(ND)=TB(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*R(ND)*R(ND)*F(ND)/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+GAM(ND)) )
	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+GAM(ND)) )

	  TB(ND)=TB(ND)+0.1_LDP*RSQ*FMIN/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*RSQ*FMIN/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  DJDt(ND)=0.0_LDP
	  DJDt(ND)=0.0D0

	  DJDt_OLDt(ND)=0.0_LDP
	  DJDt_OLDt(ND)=0.0D0

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	  T1=R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  T1=R(ND)*R(ND)/3.0D0/CHI(ND)

	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0D0+RECIP_CDELTAT/CHI(ND)) +

	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0D0+RECIP_CDELTAT/CHI(ND)) +


var_mom_j_ddt_v5.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  TA(1:ND)=R(1:ND)-1.0E-05_LDP*V(1:ND)*DELTA_TIME_SECS
	  TA(1:ND)=R(1:ND)-1.0D-05*V(1:ND)*DELTA_TIME_SECS

	  JNU_OLDT=0.0_LDP; RSQ_HNU_OLDt=0.0_LDP
	  JNU_OLDT=0.0D0; RSQ_HNU_OLDt=0.0D0

	  RSQH_AT_IB_OLDT=0.0_LDP; HONJ_OUTBC_OLDT=0.0_LDP
	  RSQH_AT_IB_OLDT=0.0D0; HONJ_OUTBC_OLDT=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	  TX=0.0_LDP		! ND:ND:NM
	  TX=0.0D0		! ND:ND:NM

	  TVX=0.0_LDP		! ND-1:ND:NM
	  TVX=0.0D0		! ND-1:ND:NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    DJDT(I)=0.0_LDP
	    DJDT(I)=0.0D0

	    DJDT_OLDT(I)=0.0_LDP
	    DJDT_OLDT(I)=0.0D0

	  CHI_AT_INB_PREV=1.0_LDP
	  CHI_AT_INB_PREV=1.0D0

	    GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS
	    GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)

	DERIV_SCL_FAC=1.0_LDP
	DERIV_SCL_FAC=1.0D0

	  DO WHILE(XM(I) .LE. 0.0_LDP .AND. ICNT .LT. 3)
	  DO WHILE(XM(I) .LE. 0.0D0 .AND. ICNT .LT. 3)

	    DERIV_SCL_FAC(I)=0.5_LDP*DERIV_SCL_FAC(I)
	    DERIV_SCL_FAC(I)=0.5D0*DERIV_SCL_FAC(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  dRHSdCHI_OB=0.0_LDP
	  dRHSdCHI_OB=0.0D0

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)
	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  GAM_INB=0.0_LDP                               !or set to GAM(ND)
	  GAM_INB=0.0D0                               !or set to GAM(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  TB(ND)=TB(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*R(ND)*R(ND)*F(ND)/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+GAM(ND)) )
	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+GAM(ND)) )

	  TB(ND)=TB(ND)+0.1_LDP*RSQ*FMIN/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*RSQ*FMIN/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  DJDt(ND)=0.0_LDP
	  DJDt(ND)=0.0D0

	  DJDt_OLDt(ND)=0.0_LDP
	  DJDt_OLDt(ND)=0.0D0

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	IF(XM(I) .LT. 0.0_LDP)THEN
	IF(XM(I) .LT. 0.0D0)THEN

	     XM(I)=ABS(XM(I))/10.0_LDP
	     XM(I)=ABS(XM(I))/10.0D0

            T1=(R(I)*R(I)*XM(I)+R(I+1)*R(I+1)*XM(I+1))/2.0_LDP
            T1=(R(I)*R(I)*XM(I)+R(I+1)*R(I+1)*XM(I+1))/2.0D0

              RSQ_HNU(I)=0.99_LDP*T1
              RSQ_HNU(I)=0.99D0*T1

              RSQ_HNU(I)=-0.99_LDP*T1
              RSQ_HNU(I)=-0.99D0*T1

	  T1=R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  T1=R(ND)*R(ND)/3.0D0/CHI(ND)

	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0D0+RECIP_CDELTAT/CHI(ND)) +

	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0D0+RECIP_CDELTAT/CHI(ND)) +


var_mom_j_ddt_v6.f

	C_KMS=1.0E-05_LDP*SPEED_OF_LIGHT()
	C_KMS=1.0D-05*SPEED_OF_LIGHT()

	  JNU(I)=0.0_LDP
	  JNU(I)=0.0D0

	  RSQ_HNU(I)=0.0_LDP
	  RSQ_HNU(I)=0.0D0

	  TA(1:ND)=R(1:ND)-1.0E-05_LDP*V(1:ND)*DELTA_TIME_SECS
	  TA(1:ND)=R(1:ND)-1.0D-05*V(1:ND)*DELTA_TIME_SECS

	  JNU_OLDT=0.0_LDP; RSQ_HNU_OLDt=0.0_LDP
	  JNU_OLDT=0.0D0; RSQ_HNU_OLDt=0.0D0

	  RSQH_AT_IB_OLDT=0.0_LDP; HONJ_OUTBC_OLDT=0.0_LDP
	  RSQH_AT_IB_OLDT=0.0D0; HONJ_OUTBC_OLDT=0.0D0

	    RECIP_CDELTAT=1.0E+10_LDP*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS
	    RECIP_CDELTAT=1.0D+10*RELAX_PARAM/SPEED_OF_LIGHT()/DELTA_TIME_SECS

	    ROLD_ON_R=1.0_LDP-1.0E-05_LDP*V(ND)*DELTA_TIME_SECS/R(ND)
	    ROLD_ON_R=1.0D0-1.0D-05*V(ND)*DELTA_TIME_SECS/R(ND)

	    RECIP_CDELTAT=0.0_LDP
	    RECIP_CDELTAT=0.0D0

	    ROLD_ON_R=0.0_LDP
	    ROLD_ON_R=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	  TX=0.0_LDP		! ND:ND:NM
	  TX=0.0D0		! ND:ND:NM

	  TVX=0.0_LDP		! ND-1:ND:NM
	  TVX=0.0D0		! ND-1:ND:NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    DJDT(I)=0.0_LDP
	    DJDT(I)=0.0D0

	    DJDT_OLDT(I)=0.0_LDP
	    DJDT_OLDT(I)=0.0D0

	  CHI_AT_INB_PREV=1.0_LDP
	  CHI_AT_INB_PREV=1.0D0

	    GAMH(I)=2.0_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS
	    GAMH(I)=2.0D0*(V(I)+V(I+1))/(R(I)+R(I+1))/dLOG_NU/( CHI(I)+CHI(I+1) )/C_KMS

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	    dH(I)=2.0_LDP*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )
	    dH(I)=2.0D0*RECIP_CDELTAT/( CHI(I)+CHI(I+1) )

	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*F(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*F(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  HT(I)=dH_OLDT(I)/(1.0_LDP+W(I))
	  HT(I)=dH_OLDT(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-COH_VEC(I)) + PSI(I) + DJDT(I) +HU(I-1) +HL(I)

	DERIV_SCL_FAC=1.0_LDP
	DERIV_SCL_FAC=1.0D0

	    DO WHILE(XM(I) .LE. 0.0_LDP .AND. ICNT .LT. 5)
	    DO WHILE(XM(I) .LE. 0.0D0 .AND. ICNT .LT. 5)

	      DERIV_SCL_FAC(I)=0.5_LDP*DERIV_SCL_FAC(I)
	      DERIV_SCL_FAC(I)=0.5D0*DERIV_SCL_FAC(I)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  dRHSdCHI_OB=0.0_LDP
	  dRHSdCHI_OB=0.0D0

	  MOD_DTAU=0.5_LDP*(CHI(1)+CHI(2))*(R(1)-R(2))
	  MOD_DTAU=0.5D0*(CHI(1)+CHI(2))*(R(1)-R(2))

	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0_LDP-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)
	  TB(1)=RSQ*( FPLUS/MOD_DTAU -  (1.0D0-FPLUS)/R(1)/CHI(1) + HPLUS ) + PSI(1) +DJDT(1)

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  RSQH_AT_IB=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  GAM_INB=0.0_LDP                               !or set to GAM(ND)
	  GAM_INB=0.0D0                               !or set to GAM(ND)

	  RSQH_AT_IB=0.0_LDP
	  RSQH_AT_IB=0.0D0

	  PSI(ND)=0.0_LDP
	  PSI(ND)=0.0D0

	  PSIPREV(ND)=0.0_LDP
	  PSIPREV(ND)=0.0D0

	  DJDT(ND)=0.0_LDP
	  DJDT(ND)=0.0D0

	  DJDT_OLDt(ND)=0.0_LDP
	  DJDT_OLDt(ND)=0.0D0

	  TB(ND)=TB(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*R(ND)*R(ND)*F(ND)/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*R(ND)*R(ND)*F(ND)*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0_LDP-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0_LDP+GAM(ND)) )
	  TB(ND)=RSQ*( FMIN/DTAU(ND-1) + (1.0D0-FMIN)/R(ND)/CHI(ND) + HMIN*(1.0D0+GAM(ND)) )

	  TB(ND)=TB(ND)+0.1_LDP*RSQ*FMIN/DTAU(ND-1)
	  TB(ND)=TB(ND)+0.1D0*RSQ*FMIN/DTAU(ND-1)

	  XM(ND)=XM(ND)+0.1_LDP*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)
	  XM(ND)=XM(ND)+0.1D0*RSQ*FMIN*(JPLUS_IB+JMIN_IB)/DTAU(ND-1)

	  DJDt(ND)=0.0_LDP
	  DJDt(ND)=0.0D0

	  DJDt_OLDt(ND)=0.0_LDP
	  DJDt_OLDt(ND)=0.0D0

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	IF(XM(I) .LT. 0.0_LDP)THEN
	IF(XM(I) .LT. 0.0D0)THEN

	     XM(I)=ABS(XM(I))/10.0_LDP
	     XM(I)=ABS(XM(I))/10.0D0

            T1=(R(I)*R(I)*XM(I)+R(I+1)*R(I+1)*XM(I+1))/2.0_LDP
            T1=(R(I)*R(I)*XM(I)+R(I+1)*R(I+1)*XM(I+1))/2.0D0

              RSQ_HNU(I)=0.99_LDP*T1
              RSQ_HNU(I)=0.99D0*T1

              RSQ_HNU(I)=-0.99_LDP*T1
              RSQ_HNU(I)=-0.99D0*T1

	  T1=R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  T1=R(ND)*R(ND)/3.0D0/CHI(ND)

	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_T(ND)=T1*dDBBdT*(1.0D0+RECIP_CDELTAT/CHI(ND)) +

	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0_LDP+RECIP_CDELTAT/CHI(ND)) +
	  TX_DIF_d_dTdR(ND)=T1*DBB*(1.0D0+RECIP_CDELTAT/CHI(ND)) +


var_mom_jext_cmf_v3.f

	REAL(KIND=LDP), PARAMETER :: PROG_ID=3.4281463E+08_LDP  !Must be unique (VAR_MOM_)
	REAL(KIND=LDP), PARAMETER :: PROG_ID=3.4281463D+08  !Must be unique (VAR_MOM_)

	PSIPREV(NV-1)=1.0_LDP
	PSIPREV(NV-1)=1.0D0

	PSIPREV(NV)=1.0_LDP
	PSIPREV(NV)=1.0D0

	IF(PSIPREV(NV-1) .NE. 0.0_LDP .OR. PSIPREV(NV) .NE. 1.0_LDP)THEN
	IF(PSIPREV(NV-1) .NE. 0.0D0 .OR. PSIPREV(NV) .NE. 1.0D0)THEN

	  PSIPREV(NV)=0.0_LDP
	  PSIPREV(NV)=0.0D0

	JNU(1:ND)=0.0_LDP
	JNU(1:ND)=0.0D0

	RSQ_HNU(1:ND)=0.0_LDP
	RSQ_HNU(1:ND)=0.0D0

	  THETA(1:ND)=0.0_LDP
	  THETA(1:ND)=0.0D0

	  TX(:,:,:)=0.0_LDP			!ND*ND_SM*NM
	  TX(:,:,:)=0.0D0			!ND*ND_SM*NM

	  TVX(:,:,:)=0.0_LDP			!(ND-1)*ND_SM*NM
	  TVX(:,:,:)=0.0D0			!(ND-1)*ND_SM*NM

	    JNUM1(I)=0.0_LDP
	    JNUM1(I)=0.0D0

	    RSQ_HNUM1(I)=0.0_LDP
	    RSQ_HNUM1(I)=0.0D0

	    GAMH(I)=0.0_LDP
	    GAMH(I)=0.0D0

	    GAM(I)=0.0_LDP
	    GAM(I)=0.0D0

	    W(I)=0.0_LDP
	    W(I)=0.0D0

	    WPREV(I)=0.0_LDP
	    WPREV(I)=0.0D0

	    PSI(I)=0.0_LDP
	    PSI(I)=0.0D0

	    PSIPREV(I)=0.0_LDP
	    PSIPREV(I)=0.0D0

	    TX_DIF_d_T(I)=0.0_LDP
	    TX_DIF_d_T(I)=0.0D0

	    TX_DIF_d_dTdR(I)=0.0_LDP
	    TX_DIF_d_dTdR(I)=0.0D0

	    EPS_A(I)=0.0_LDP
	    EPS_A(I)=0.0D0

	    EPS_B(I)=0.0_LDP
	    EPS_B(I)=0.0D0

	    EPS_PREV_A(I)=0.0_LDP
	    EPS_PREV_A(I)=0.0D0

	    EPS_PREV_B(I)=0.0_LDP
	    EPS_PREV_B(I)=0.0D0

	  RSQ_DTAUONQ(I)=0.5_LDP*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)
	  RSQ_DTAUONQ(I)=0.5D0*R(I)*R(I)*(DTAU(I)+DTAU(I-1))/Q(I)

	    AV_SIGMA=0.5_LDP*(SIGMA(I)+SIGMA(I+1))
	    AV_SIGMA=0.5D0*(SIGMA(I)+SIGMA(I+1))

	    GAMH(I)=2.0_LDP*3.33564E-06_LDP*(V(I)+V(I+1))/(R(I)+R(I+1))
	    GAMH(I)=2.0D0*3.33564D-06*(V(I)+V(I+1))/(R(I)+R(I+1))

	    W(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID(I) )
	    W(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID(I) )

	    WPREV(I)=GAMH(I)*( 1.0_LDP+AV_SIGMA*NMID_ON_HMID(I) )
	    WPREV(I)=GAMH(I)*( 1.0D0+AV_SIGMA*NMID_ON_HMID(I) )

	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0_LDP+W(I))
	    EPS_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J(I)/(1.0D0+W(I))

	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0_LDP+W(I))
	    EPS_PREV_A(I)=GAMH(I)*AV_SIGMA*NMID_ON_J_PREV(I)/(1.0D0+W(I))

	    GAM(I)=3.33564E-06_LDP*V(I)/R(I)/CHI(I)/dLOG_NU
	    GAM(I)=3.33564D-06*V(I)/R(I)/CHI(I)/dLOG_NU

	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0_LDP+SIGMA(I)*K_ON_J(I) )
	    PSI(I)=RSQ_DTAUONQ(I)*GAM(I)*( 1.0D0+SIGMA(I)*K_ON_J(I) )

	1                   ( 1.0_LDP+SIGMA(I)*K_ON_J_PREV(I) )
	1                   ( 1.0D0+SIGMA(I)*K_ON_J_PREV(I) )

	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0_LDP+W(I))/DTAU(I)
	  HU(I)=R(I+1)*R(I+1)*K_ON_J(I+1)*Q(I+1)/(1.0D0+W(I))/DTAU(I)

	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0_LDP+W(I))/DTAU(I)
	  HL(I)=R(I)*R(I)*K_ON_J(I)*Q(I)/(1.0D0+W(I))/DTAU(I)

	  HS(I)=WPREV(I)/(1.0_LDP+W(I))
	  HS(I)=WPREV(I)/(1.0D0+W(I))

	  TB(I)=RSQ_DTAUONQ(I)*(1.0_LDP-THETA(I)) + PSI(I) +HU(I-1) +HL(I)
	  TB(I)=RSQ_DTAUONQ(I)*(1.0D0-THETA(I)) + PSI(I) +HU(I-1) +HL(I)

	XM(1)=0.0_LDP
	XM(1)=0.0D0

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	VB(1)=0.0_LDP
	VB(1)=0.0D0

	VC(1)=0.0_LDP
	VC(1)=0.0D0

	  XM(ND)=DBB*R(ND)*R(ND)/3.0_LDP/CHI(ND)
	  XM(ND)=DBB*R(ND)*R(ND)/3.0D0/CHI(ND)

	  XM(ND)=R(ND)*R(ND)*IC*(0.25_LDP+0.5_LDP*IN_HBC)
	  XM(ND)=R(ND)*R(ND)*IC*(0.25D0+0.5D0*IN_HBC)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

	VB(ND)=0.0_LDP
	VB(ND)=0.0D0

	VC(ND)=0.0_LDP
	VC(ND)=0.0D0

	PSIPREV(ND)=0.0_LDP
	PSIPREV(ND)=0.0D0

	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_T(ND)=dDBBdT*R(ND)*R(ND)/3.0D0/CHI(ND) +

	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0_LDP/CHI(ND) +
	  TX_DIF_d_dTdR(ND)=DBB/dTdR*R(ND)*R(ND)/3.0D0/CHI(ND) +


var_mom_pp_v1.f

	  IF(DO_THIS_MATRIX(I))TX(:,:,I)=0.0_LDP
	  IF(DO_THIS_MATRIX(I))TX(:,:,I)=0.0D0

	    COH_VEC(I)=0.0_LDP
	    COH_VEC(I)=0.0D0

	  DD(I)=-0.5_LDP*(DTAU(I-1)+DTAU(I))*(1.0_LDP-COH_VEC(I)) -
	  DD(I)=-0.5D0*(DTAU(I-1)+DTAU(I))*(1.0D0-COH_VEC(I)) -

	  RHS(I)=0.5_LDP*(DTAU(I-1)+DTAU(I))*SOURCE(I)
	  RHS(I)=0.5D0*(DTAU(I-1)+DTAU(I))*SOURCE(I)

	DD(1)= -0.5_LDP*DTAU(1)*(1.0_LDP-COH_VEC(1))-HBC_J-(F(1)-F(2))/DTAU(1)
	DD(1)= -0.5D0*DTAU(1)*(1.0D0-COH_VEC(1))-HBC_J-(F(1)-F(2))/DTAU(1)

	RHS(1)=0.5_LDP*DTAU(1)*SOURCE(1)+HBC_S*SOURCE(1)
	RHS(1)=0.5D0*DTAU(1)*SOURCE(1)+HBC_S*SOURCE(1)

	TA(1)=0.0_LDP
	TA(1)=0.0D0

	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5_LDP*DTAU(ND-1)*(1.0_LDP-COH_VEC(ND))
	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5D0*DTAU(ND-1)*(1.0D0-COH_VEC(ND))

	  RHS(ND)=DBB/3.0_LDP/CHI(ND)+0.5_LDP*DTAU(ND-1)*SOURCE(ND)
	  RHS(ND)=DBB/3.0D0/CHI(ND)+0.5D0*DTAU(ND-1)*SOURCE(ND)

	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5_LDP*DTAU(ND-1)*(1.0_LDP-COH_VEC(ND))-IN_HBC(1)
	  DD(ND)=-(F(ND)-F(ND-1))/DTAU(ND-1)-0.5D0*DTAU(ND-1)*(1.0D0-COH_VEC(ND))-IN_HBC(1)

	  RHS(ND)=IC*(0.25_LDP+0.5_LDP*IN_HBC(1))+0.5_LDP*DTAU(ND-1)*SOURCE(ND)
	  RHS(ND)=IC*(0.25D0+0.5D0*IN_HBC(1))+0.5D0*DTAU(ND-1)*SOURCE(ND)

	TC(ND)=0.0_LDP
	TC(ND)=0.0D0

        IF(TOR .LT. 0.0_LDP .OR. HBC_S .LE. 0.0_LDP)TOR=0.0_LDP
        IF(TOR .LT. 0.0D0 .OR. HBC_S .LE. 0.0D0)TOR=0.0D0

        TX(:,:,2)=0.0_LDP
        TX(:,:,2)=0.0D0

        TX(1,1,2)=0.5_LDP*DTAU(1)/CHI(1)+HBC_S/CHI(1)
        TX(1,1,2)=0.5D0*DTAU(1)/CHI(1)+HBC_S/CHI(1)

          TX(I,I,2)=0.5_LDP*(DTAU(I-1)+DTAU(I))/CHI(I)
          TX(I,I,2)=0.5D0*(DTAU(I-1)+DTAU(I))/CHI(I)

        TX(ND,ND,2)=0.5_LDP*DTAU(ND-1)/CHI(ND)		!Diff and non diff
        TX(ND,ND,2)=0.5D0*DTAU(ND-1)/CHI(ND)		!Diff and non diff

	dJ_dDBB(1:ND)=0.0_LDP
	dJ_dDBB(1:ND)=0.0D0

	  dJ_dDBB(ND)=1.0_LDP/3.0_LDP/CHI(ND)
	  dJ_dDBB(ND)=1.0D0/3.0D0/CHI(ND)


velocity_law.f

      REAL(KIND=LDP), PARAMETER :: C_KMS=2.99792458E+05_LDP
      REAL(KIND=LDP), PARAMETER :: C_KMS=2.99792458D+05

      VEL=T1*V(ID)+(1.0_LDP-T1)*V(ID+1)
      VEL=T1*V(ID)+(1.0D0-T1)*V(ID+1)

      GAMMA=1.0_LDP/SQRT(1.0_LDP-BETA*BETA)
      GAMMA=1.0D0/SQRT(1.0D0-BETA*BETA)

