!
! Program to test the solution of the large martices generated by
! CMFGEN. The routine reads in the file BA_ASCI_N_DX (X=depth) and generates
! the solution.
!
	PROGRAM CHECK_BA_CHANGES
	USE GEN_IN_INTERFACE
!
! Altered 24-Jun-2009: Depth of matrix now input.
!
	IMPLICIT NONE
	INTEGER ID
	INTEGER NT,N
	INTEGER ILOW,IUP
	INTEGER IOS
	LOGICAL FILE_OPEN
	CHARACTER(LEN=80) STRING
	CHARACTER(LEN=200) FILE_NAME_B
	CHARACTER(LEN=200) FILE_NAME_A 
	INTEGER, PARAMETER :: LU=10
!
	REAL*8, ALLOCATABLE :: POPS_A(:)
	REAL*8, ALLOCATABLE :: STEQ_A(:)
	REAL*8, ALLOCATABLE :: CMAT_A(:,:)
!
	REAL*8, ALLOCATABLE :: POPS_B(:)
	REAL*8, ALLOCATABLE :: STEQ_B(:)
	REAL*8, ALLOCATABLE :: CMAT_B(:,:)
!
	OPEN(UNIT=20,FILE='MODEL',STATUS='OLD',IOSTAT=IOS)
	  IF(IOS .EQ. 0)THEN
	    DO WHILE(1 .EQ. 1)
	      READ(20,'(A)',IOSTAT=IOS)STRING
	      IF(IOS .NE. 0)EXIT
	      IF(INDEX(STRING,'!Total number of variables') .NE. 0)THEN
	        READ(STRING,*)NT
	        WRITE(6,'(A,I4)')' Number of variables in the model is:',NT
	        EXIT
	      END IF
	    END DO
	  END IF
	  INQUIRE(UNIT=20,OPENED=FILE_OPEN)
	IF(FILE_OPEN)CLOSE(UNIT=20)
!
	IF(IOS .NE. 0)THEN
	  NT=0
	  WRITE(6,*)' Unable to open/read MODEL file to get # of variables'
	  CALL GEN_IN(NT,'Number of elements (==NT in MODEL)')
	END IF
	IF(NT .EQ. 0)THEN
	  WRITE(6,*)'Invalid number of elements'
	  WRITE(6,*)'Check NT in file MODEL'
	  STOP
	END IF
!
!	ID=1
!	CALL GEN_IN(ID,'Depth indicator: i.e., X in BA_ASCI_N_DX:')
	FILE_NAME_A='BA_ASCI_N_D51'
	FILE_NAME_B='../a4_65nodt_1it/BA_ASCI_N_D51'
!
	ALLOCATE (POPS_A(NT))
	ALLOCATE (STEQ_A(NT))
	ALLOCATE (CMAT_A(NT,NT))
!
	ALLOCATE (POPS_B(NT))
	ALLOCATE (STEQ_B(NT))
	ALLOCATE (CMAT_B(NT,NT))
!
	CALL RD_BA_MAT(POPS_A,STEQ_A,CMAT_A,NT,FILE_NAME_A,LU)
	CALL RD_BA_MAT(POPS_B,STEQ_B,CMAT_B,NT,FILE_NAME_B,LU)
!
	STOP
	END
! 
!
	SUBROUTINE RD_BA_MAT(POPS,STEQ,CMAT,NT,FILE_NAME,LU)
	IMPLICIT NONE
!
	INTEGER LU
	INTEGER NT
	CHARACTER(LEN=*) FILE_NAME
!
	REAL*8 POPS(NT)
	REAL*8 STEQ(NT)
	REAL*8 CMAT(NT,NT)
!
	INTEGER I,J,K,L
	CHARACTER(LEN=200) STRING
!
	OPEN(UNIT=LU, FILE=FILE_NAME,STATUS='OLD',ACTION='READ')
	  STRING=' '
	  DO WHILE(INDEX(STRING,'POP') .EQ. 0)		
	    READ(LU,'(A)')STRING
	  END DO
	  READ(LU,'(A)')STRING
	  DO WHILE(STRING .EQ. ' ')
	    READ(LU,'(A)')STRING
	  END DO
	  DO I=1,NT
	    READ(STRING(10:),*)POPS(I)
	    READ(LU,'(A)')STRING
	  END DO
	  WRITE(6,*)'Successfully read POPS'
!
	  STRING=' '
	  DO WHILE(INDEX(STRING,'STEQ') .EQ. 0)		
	    READ(LU,'(A)')STRING
	  END DO
	  READ(LU,'(A)')STRING
	  DO WHILE(STRING .EQ. ' ')
	    READ(LU,'(A)')STRING
	  END DO
	  DO I=1,NT
	    READ(STRING(10:),*)STEQ(I)
	    READ(LU,'(A)')STRING
	  END DO
	  WRITE(6,*)'Successfully read STEQ'
!
	  STRING=' '
	  DO WHILE(INDEX(STRING,'C_MAT') .EQ. 0)		
	    READ(LU,'(A)')STRING
	  END DO
!
	  STRING=' '
	  DO K=1,NT,5
	    DO WHILE(STRING .EQ. ' ')
	      READ(LU,'(A)')STRING
	    END DO
	    IF( MOD(K-1,50) .EQ. 0)WRITE(6,*)'Reading element=',K,' in CMAT'
	    DO I=1,NT
	      READ(STRING(10:),*)(CMAT(I,J),J=K,MIN(K+4,NT))
	      READ(LU,'(A)',END=100)STRING
	    END DO
100	    CONTINUE
	  END DO
	  WRITE(6,*)'Successfully read CMAT'
!
	CLOSE(UNIT=LU)
!
	RETURN
	END
